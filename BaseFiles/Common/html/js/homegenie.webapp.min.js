HG.WebApp=HG.WebApp||new function(){var $$=this;$$.Data={ServiceKey:"api",ServiceDomain:"HomeAutomation.HomeGenie",Modules:[],Groups:[],AutomationGroups:[],Programs:[],Interfaces:[],Events:[]},$$.Store=$.jStorage,$$.Initialize=function(){var theme=$$.Store.get("UI.Theme");(null==theme||"a">theme||theme>"g")&&$$.Store.set("UI.Theme","a"),$.mobile.ajaxFormsEnabled=!1,HG.Configure.LoadData(function(){setTimeout($$.Control.RenderMenu,2e3)}),$$.Home.UpdateHeaderStatus(),window.setInterval("HG.WebApp.Home.UpdateHeaderStatus();",1e4),$("[data-role=page]").on("pagebeforeshow",function(event){HG.Ui.SetTheme($$.Store.get("UI.Theme")),"page_analyze"==this.id?$$.Statistics.InitConfiguration():"page_configure_maintenance"==this.id?$$.Maintenance.LoadSettings():"page_configure_groups"==this.id?HG.Configure.Modules.List(function(data){try{$$.Data.Modules=eval(data)}catch(e){}HG.Automation.Programs.List(function(){$$.GroupsList.LoadGroups()})}):"page_configure_schedulerservice"==this.id&&$$.Scheduler.LoadScheduling()}),$("[data-role=page]").on("pagehide",function(){"page_analyze"==this.id&&$$.Statistics.SetAutoRefresh(!1)}),setTimeout(function(){var e=$$.Locales.GetUserLanguage();$$.Locales.Load("./locales/"+e.toLowerCase().substring(0,2)+".json",function(){$$.Locales.Load("./locales/"+e.toLowerCase().substring(0,2)+".programs.json",function(){$$.Locales.Localize(document),$("#homegenie_overlay").fadeOut(200),$$.Store.get("UI.AboutPopupShown")||($$.Store.set("UI.AboutPopupShown",!0),setTimeout($$.Home.About,3e3))})}),HG.VoiceControl.Initialize(),HG.Ui.SetTheme($$.Store.get("UI.Theme")),$$.Store.get("UI.EventsHistory")&&$("#btn_eventshistory_led").show(),HG.System.GetVersion(function(e){$("#systemversion").html(e.Version)}),setTimeout(function(){$("head").append('<link href="https://fonts.googleapis.com/css?family=Oxygen:400,700&subset=latin,latin-ext" rel="stylesheet" type="text/css">')},5e3)},100),$("#content").notify({speed:500,expires:5e3,stack:"below"}),Raphael.fn.ball=function(e,t,o,a){return this.set(this.ellipse(e,t+o-o/5,o,o/2).attr({fill:"rhsb("+a.h+", 1, .25)-hsb("+a.h+", 1, .25)",stroke:"none",opacity:0}),this.ellipse(e,t,o,o).attr({fill:"r(.5,.9)hsb("+a.h+", "+a.s+", .75)-hsb("+a.h+", "+a.s+", "+a.b+")",stroke:"none",opacity:.8}),this.ellipse(e,t,o-o/5,o-o/20).attr({stroke:"none",fill:"r(.5,.1)#ccc-#ccc",opacity:0}))},$("#automation_group_module_edit").enhanceWithin().popup(),$("#page_configure_groupmodules_propspopup").enhanceWithin().popup(),$("#page_configure_groupmodules_propspopup").on("popupbeforeposition",function(){$("#automation_group_module_params").scrollTop(0),$$.GroupModules.LoadModuleParameters()}),$("#module_options_button").on("click",function(){$$.GroupModules.ShowModuleOptions($$.GroupModules.CurrentModule.Domain,$$.GroupModules.CurrentModule.Address)}),$("#module_update_button").bind("click",function(){$$.GroupModules.CurrentModule.Name=$$.GroupModules.EditModule.Name,$$.GroupModules.CurrentModule.DeviceType=$$.GroupModules.EditModule.DeviceType,$$.Utility.SetModulePropertyByName($$.GroupModules.CurrentModule,"VirtualMeter.Watts",$$.GroupModules.EditModule.WMWatts),$$.Utility.SetModulePropertyByName($$.GroupModules.EditModule,"VirtualMeter.Watts",$$.GroupModules.EditModule.WMWatts);for(var e=0;e<$$.GroupModules.EditModule.Properties.length;e++){var t=$$.GroupModules.EditModule.Properties[e];$$.Utility.SetModulePropertyByName($$.GroupModules.CurrentModule,t.Name,t.Value),t=$$.Utility.GetModulePropertyByName($$.GroupModules.CurrentModule,t.Name),t.NeedsUpdate="true"}$$.GroupModules.UpdateModule($$.GroupModules.CurrentModule,function(){$$.GroupModules.ModuleUpdatedCallback()})}),$("#automationprograms_program_options").enhanceWithin().popup(),$("#configure_popupsettings_edit").enhanceWithin().popup(),$("#configure_popupsettings_edit").on("popupbeforeposition",function(){$$.Events.PopupRefreshIgnore()}),$("#actionconfirm_popup").enhanceWithin().popup();var menuPanel=$('body>[data-role="panel"]');menuPanel.panel().on("panelopen",function(){$("#homegenie_overlay").fadeIn(150)}).on("panelbeforeopen",function(){$("#homegenie_overlay").fadeIn(250)}).on("panelbeforeclose",function(){$("#homegenie_overlay").fadeOut(250)}).children().first().trigger("create"),menuPanel.on("click",function(){$(this).panel("close")}),$(document).on("swipeleft swiperight","div[data-role=page]",function(e){$("[data-ui-field=homegenie_panel_button]").hasClass("ui-disabled")||0==$(".ui-page-active .ui-popup-active").length&&($(e.target).is("span")||$(e.target).is("pre")||$(e.target).is("p")||$(e.target).is(":input")||"page_automation_editprogram"!=$(e.target).attr("id")&&0==$("#page_automation_editprogram").children().find($(e.target)).length&&"page_widgeteditor_editwidget"!=$(e.target).attr("id")&&0==$("#page_widgeteditor_editwidget").children().find($(e.target)).length&&"open"!==$.mobile.activePage.jqmData("panel")&&("swipeleft"===e.type?$(menuPanel.get(0)).panel("open"):"swiperight"===e.type&&$(menuPanel.get(1)).panel("open")))}),HG.Ui.GenerateWidget("core/popup.cronwizard",{parent:$(document).find("body")},function(e){var t=e.element;t.enhanceWithin().popup(),HG.Ui.Popup.CronWizard=e}),$("#homegenie_about").enhanceWithin().popup(),$("#about_popup_updatebutton").on("click",function(){HG.System.UpdateManager.UpdateCheck(),$("#homegenie_about").popup("close")}),$$.lastSleepCheck=(new Date).getTime(),setInterval($$.sleepCheck,1e3)},$$.lastSleepCheck=0,$$.sleepCheck=function(){var e=(new Date).getTime(),t=e-$$.lastSleepCheck;t>5e3&&(null==HG.WebApp.Events._eventSource||2==HG.WebApp.Events._eventSource.readyState)&&(console.log("sleepCheck -> device resume"),HG.WebApp.Events.Setup()),$$.lastSleepCheck=e}},HG.WebApp.Data._DefaultLocale={},HG.WebApp.Data._CurrentLocale={},HG.WebApp.Locales=HG.WebApp.Locales||new function(){var $$=this;$$.GetUserLanguage=function(){var e=navigator.languages?navigator.languages[0]:navigator.language||navigator.userLanguage;return e.length>2&&(e=e.substring(0,2)),e},moment.locale($$.GetUserLanguage()),$$.GetDateEndianType=function(){var e="L",t=new Date(983268e5),o=t.toLocaleDateString().replace(/[\u200E]/g,"").split("/");return"2"==o[0]&&(e="M"),e},$$.GetTemperatureUnit=function(){var e=HG.WebApp.Store.get("UI.TemperatureUnit");return"C"==e||"F"!=e&&"M"!=$$.GetDateEndianType()?"Celsius":"Fahrenheit"},$$.GetDefault=function(e){$.ajax({url:"./locales/en.json",type:"GET",success:function(t){HG.WebApp.Data._DefaultLocale=$.parseJSON(t),e(),$.ajax({url:"./locales/en.programs.json",type:"GET",success:function(e){HG.WebApp.Data._DefaultLocale=$.extend(HG.WebApp.Data._DefaultLocale,$.parseJSON(e))}})}})},$$.Load=function(e,t){$$.GetDefault(function(){$.ajax({url:e,type:"GET",success:function(e){HG.WebApp.Data._CurrentLocale=$.extend(HG.WebApp.Data._CurrentLocale,$.parseJSON(e)),"function"==typeof t&&t(!0)},error:function(o){console.log('WARNING (Locales.Load): "'+e+'" '+o.status+" "+o.statusText),"function"==typeof t&&t(!1)}})})},$$.Localize=function(e){$(e).find("[data-locale-id]").each(function(){var e=$(this).attr("data-locale-id"),t=$$.GetLocaleString(e);null!=t&&($this=$(this),$this.is("a")&&$("span.ui-btn-text",$this).is("span")?$("span.ui-btn-text",$this).text(t):$this.is("input")?$this.attr("placeholder",t):$(this).html(t))})},$$.LocalizeElement=function(e,t){$(e).find("[data-locale-id]").each(function(){var e=$(this).attr("data-locale-id"),o=$$.GetLocaleString(e,!1,t);null!=o&&($this=$(this),$this.is("a")&&$("span.ui-btn-text",$this).is("span")?$("span.ui-btn-text",$this).text(o):$this.is("input")?$this.attr("placeholder",o):$(this).html(o))})},$$.GetLocaleString=function(e,t,o){var a=null;return o&&$.each(o,function(t,o){return t==e?(a=o,!1):void 0}),null==a&&$.each(HG.WebApp.Data._CurrentLocale,function(t,o){return t==e?(a=o,!1):void 0}),null==a&&$.each(HG.WebApp.Data._DefaultLocale,function(t,o){return t==e?(a=o,!1):void 0}),null==a&&console.log('WARNING (Locales.GetLocaleString): "'+e+'" is undefined.'),null==a&&t?t:a},$$.LocalizeWidget=function(e,t,o){var a=$$.GetUserLanguage();e=e.substring(0,e.lastIndexOf("/"));var i="#"+t,r="pages/control/widgets/"+e+"/locales/"+a.toLowerCase().substring(0,2)+".json";$.ajax({url:r,type:"GET",success:function(e){var t=$.parseJSON(e);$(i).find("[data-ui-field=widget]").data("Locale",t),$(i).find("[data-locale-id]").each(function(){var e=$(this).attr("data-locale-id"),o=$$.GetLocaleString(e,!1,t);null!=o&&($this=$(this),$this.is("a")&&$("span.ui-btn-text",$this).is("span")?$("span.ui-btn-text",$this).text(o):$this.is("input")?$this.attr("placeholder",o):$(this).html(o))}),$(i).find("[data-localizable]").each(function(){var e=$(this).text(),o=$$.GetLocaleString(e,!1,t);null!=o&&$(this).text(o)});var a=$(i).find("[data-ui-field=widget]").data("ControlPopUp");a&&a.each(function(){var e=$(this);$(e).find("[data-locale-id]").each(function(){var e=$(this).attr("data-locale-id"),o=$$.GetLocaleString(e,!1,t);null!=o&&($this=$(this),$this.is("a")&&$("span.ui-btn-text",$this).is("span")?$("span.ui-btn-text",$this).text(o):$this.is("input")?$this.attr("placeholder",o):$(this).html(o))})}),"function"==typeof o&&o()},error:function(e){console.log('WARNING (Locales.LocalizeWidget): "'+r+'" '+e.status+" "+e.statusText),"function"==typeof o&&o()}})},$$.GetWidgetLocaleString=function(e,t,o){var a=null;return null==e||"undefined"==typeof e||"undefined"==typeof e.data("Locale")?o?o:null:(a=$$.GetLocaleString(t,!1,e.data("Locale")),null==a&&o?o:a)},$$.GetProgramLocaleString=function(programAddress,stringId,defaultValue){var response=defaultValue,plocale,hasLocale=eval("(HG.WebApp.Data._CurrentLocale.Programs && HG.WebApp.Data._CurrentLocale.Programs["+programAddress+"])");return hasLocale?plocale=eval("HG.WebApp.Data._CurrentLocale.Programs["+programAddress+"]"):(hasLocale=eval("(HG.WebApp.Data._DefaultLocale.Programs && HG.WebApp.Data._DefaultLocale.Programs["+programAddress+"])"),hasLocale&&(plocale=eval("HG.WebApp.Data._DefaultLocale.Programs["+programAddress+"]"))),"undefined"!=typeof plocale&&(response=$$.GetLocaleString(stringId,defaultValue,plocale)),response},$$.GenerateTemplate=function(){var e="";$(document).find("[data-locale-id]").each(function(){var t=$(this).attr("data-locale-id"),o=$(this).html().trim();e.indexOf('"'+t+'"')<0&&(e+=' "'+t+'": \n      "'+o+'",\n')}),console.log(e)}},HG.WebApp.Utility=HG.WebApp.Utility||new function(){var e=this;e._cmFsEditor=null,e.EditorPopup=function(t,o,a,i,r){null==e._cmFsEditor&&(e._cmFsEditor=CodeMirror.fromTextArea(document.getElementById("fullscreen_edit_text"),{lineNumbers:!0,matchBrackets:!0,autoCloseBrackets:!0,extraKeys:{"Ctrl-Q":function(e){e.foldCode(e.getCursor())},"Ctrl-Space":"autocomplete"},foldGutter:!0,gutters:["CodeMirror-lint-markers-4","CodeMirror-linenumbers","CodeMirror-foldgutter"],highlightSelectionMatches:{showToken:/\w/},mode:{name:"javascript",globalVars:!0},theme:"ambiance"}));var n=$("#fullscreen_edit_box");n.find("[data-ui-field=title]").html(o),n.find("[data-ui-field=subtitle]").html(a);var s=n.find("[data-ui-field=namelabel]").html(t),l=n.find("[data-ui-field=nameinput]"),d=l.find("input").val(t),p=n.find("[data-ui-field=confirm]"),u=n.find("[data-ui-field=cancel]");null==t||""==t?(s.hide(),l.show()):(s.show(),l.hide()),u.on("click",function(){var t={name:d.val(),text:e._cmFsEditor.getValue(),isCanceled:!0};u.off("click"),p.off("click"),$("#fullscreen_edit_box").hide(150),r(t)}),p.on("click",function(){var t={name:d.val(),text:e._cmFsEditor.getValue(),isCanceled:!1};""==d.val()?d.qtip({content:{text:HG.WebApp.Locales.GetLocaleString("fullscreen_editor_entervalidname","Enter a valid name.")},show:{event:!1,ready:!0,delay:200},hide:{event:!1,inactive:2e3},style:{classes:"qtip-red qtip-shadow qtip-rounded qtip-bootstrap"},position:{my:"bottom center",at:"top center"}}).parent().stop().animate({borderColor:"#FF5050"},250).animate({borderColor:"#FFFFFF"},250).animate({borderColor:"#FF5050"},250).animate({borderColor:"#FFFFFF"},250):(u.off("click"),p.off("click"),$("#fullscreen_edit_box").hide(150),r(t))}),e._cmFsEditor.setValue(i),setTimeout(function(){e._cmFsEditor.refresh(),e._cmFsEditor.focus(),e._cmFsEditor.setCursor({line:0,ch:0})},500),$("#fullscreen_edit_box").show(150)},e.ConfirmPopup=function(e,t,o){var a=$("#actionconfirm_popup");a.buttonProceed=$("#actionconfirm_confirm_button"),a.buttonCancel=$("#actionconfirm_cancel_button"),a.find("h3").html(e),a.find("p").html(t),a.buttonCancel.focus();var i=function(){o(!1)},r=function(){o(!0)};a.buttonCancel.on("click",i),a.buttonProceed.on("click",r),a.on("popupafterclose",function(){a.buttonCancel.off("click",i),a.buttonProceed.off("click",r)}),setTimeout(function(){a.popup("open",{transition:"pop"})},250)},e.GetElapsedTimeText=function(e){var t="";if(e=(new Date-e)/1e3,e>0){var o=Math.floor(e/86400),a=Math.floor((e-86400*o)/3600),i=Math.floor((e-86400*o-3600*a)/60),r=Math.floor(e-86400*o-3600*a-60*i);o>0&&(t+=o+"d "),a>0&&(t+=a+"h "),i>0?t+=i+"m ":r>0&&(t+=r+"s")}return t},e.ParseModuleDomainAddress=function(e){var t=null;return e.indexOf(":")>0&&(t={Domain:e.substring(0,e.lastIndexOf(":")),Address:e.substring(e.lastIndexOf(":")+1)}),t},e.GetModuleByDomainAddress=function(e,t){for(var o=null,a=0;a<HG.WebApp.Data.Modules.length;a++)if(HG.WebApp.Data.Modules[a].Domain==e&&HG.WebApp.Data.Modules[a].Address==t){o=HG.WebApp.Data.Modules[a];break}return o},e.GetModuleIndexByDomainAddress=function(e,t){for(var o=-1,a=0;a<HG.WebApp.Data.Modules.length;a++)if(HG.WebApp.Data.Modules[a].Domain==e&&HG.WebApp.Data.Modules[a].Address==t){o=a;break}return o},e.GetModulePropertyByName=function(e,t){var o=null;if(null!=e.Properties)for(var a=0;a<e.Properties.length;a++)if(e.Properties[a].Name==t){o=e.Properties[a];break}return o},e.SetModulePropertyByName=function(e,t,o,a){var i=!1;if(null!=e.Properties){for(var r=0;r<e.Properties.length;r++)if(e.Properties[r].Name==t){e.Properties[r].Value=o,"undefined"!=typeof a&&(e.Properties[r].UpdateTime=a),i=!0;break}i||e.Properties.push({Name:t,Value:o})}},e.GetProgramByAddress=function(e){var t=null;for(i=0;i<HG.WebApp.Data.Programs.length;i++)if(HG.WebApp.Data.Programs[i].Address==e){t=HG.WebApp.Data.Programs[i];break}return t},e.GetCommandFromEvent=function(e,t){var o=null;if("Switch"!=e.DeviceType&&"Light"!=e.DeviceType&&"Dimmer"!=e.DeviceType&&"Siren"!=e.DeviceType&&"Fan"!=e.DeviceType&&"Shutter"!=e.DeviceType||"Status.Level"!=t.Property)"Controllers.LircRemote"==e.Domain&&"IR"==e.Address&&(o={Domain:e.Domain,Target:e.Address,CommandString:"Control.IrSend",CommandArguments:t.Value});else{var a="Control.Level",i=t.Value;0==parseFloat(i.replace(",","."))?(a="Control.Off",i=""):1==parseFloat(i.replace(",","."))&&(a="Control.On",i=""),o={Domain:e.Domain,Target:e.Address,CommandString:a,CommandArguments:i}}return o},e.GetLocaleTemperature=function(e){var t=HG.WebApp.Store.get("UI.TemperatureUnit");return e="C"==t||"F"!=t&&"M"!=HG.WebApp.Locales.GetDateEndianType()?Math.round(10*e)/10:Math.round(10*(1.8*e+32))/10,(1*e).toFixed(2)},e.FormatTemperature=function(e){var t="",o=HG.WebApp.Store.get("UI.TemperatureUnit");return"C"==o||"F"!=o&&"M"!=HG.WebApp.Locales.GetDateEndianType()?(e=Math.round(10*e)/10,t=(1*e).toFixed(1)+"&deg;"):(e=Math.round(10*(1.8*e+32))/10,t=(1*e).toFixed(1)+"&deg;"),t},e.FormatDate=function(e){var t=HG.WebApp.Store.get("UI.DateFormat"),o=null;return o="DMY24"==t||"MDY12"!=t&&"M"!=HG.WebApp.Locales.GetDateEndianType()?$.datepicker.formatDate("D, dd/mm/yy",e):$.datepicker.formatDate("D, mm/dd/yy",e)},e.FormatDateTime=function(e,t){var o=HG.WebApp.Store.get("UI.DateFormat"),a=null,i=e.getHours(),r=e.getMinutes().toString();1==r.length&&(r="0"+r);var n=e.getSeconds().toString();if(1==n.length&&(n="0"+n),"undefined"!=typeof t&&null!=t||(t=""),"DMY24"==o||"MDY12"!=o&&"M"!=HG.WebApp.Locales.GetDateEndianType())a=i+":"+r+(0==t.indexOf("s")?":"+n+("sm"==t?"."+e.getMilliseconds():""):"");else{var s=i>=12?"PM":"AM";i%=12,i=i?i:12,a=i+":"+r+(0==t.indexOf("s")?":"+n+("sm"==t?"."+e.getMilliseconds():""):"")+" "+s}return a},e.GetDateBoxLocale=function(){var e="default",t=jQuery.jtsage.datebox.prototype.options.lang,o=HG.WebApp.Locales.GetUserLanguage();return t&&(t[o]?e=o:2===o.length&&$.each(t,function(t){return t.substring(0,2)===o?(e=t,!1):void 0})),e},e.SwitchPopup=HG.Ui.SwitchPopup,e.JScrollToElement=HG.Ui.ScrollTo},HG.WebApp.Data._CurrentGroup=null,HG.WebApp.Data._CurrentGroupIndex=0,HG.WebApp.Home=HG.WebApp.Home||new function(){var $$=this;$$.About=function(){$("#homegenie_about").popup("open")},$$.UpdateHeaderStatus=function(){$$.UpdateInterfacesStatus()},$$.UpdateInterfacesStatus=function(){var ifaceurl="/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Config/Interfaces.List/";$.ajax({url:ifaceurl,type:"GET",success:function(data){var interfaces=HG.WebApp.Data.Interfaces=eval(data),status="",isupdateavailable=!1;if(interfaces&&"undefined"!=interfaces)for(i=0;i<interfaces.length;i++){var domain=interfaces[i].Domain.split("."),name=domain[1].toUpperCase(),connected=interfaces[i].IsConnected;"HomeGenie.UpdateChecker"!=interfaces[i].Domain?status+='<img src="images/interfaces/'+name.toLowerCase()+'.png" height="28" width="30" style="'+("True"==connected?"opacity:1.0":"opacity:0.4")+'" vspace="2" hspace="0" />':isupdateavailable=!0}isupdateavailable&&(status+='<a href="#page_configure_maintenance" alt="Update available."><img title="Update available." src="images/update.png" height="28" width="28" style="margin-left:6px" vspace="2" hspace="0" /></a>'),$("#interfaces_status").html(status)}})}},HG.WebApp.Events=HG.WebApp.Events||new function(){var $$=this;$$._eventQueueCapacity=200,$$._ledOffTimeout=null,$$._popupHideTimeout=null,$$._listeners=[],$$.InitializePage=function(){var e=$$.getContainer();e.on("pagebeforeshow",function(){$$.Refresh()}),$$.field("property-txt").change(function(){$$.Refresh()}),$$.field("source-txt").change(function(){$$.Refresh()}),$$.field("domain-txt").change(function(){$$.Refresh()}),setTimeout(function(){$$.Setup()},2e3)},$$.AddListener=function(e){e._eventListenerId=$$._listeners.length+1,$$._listeners.push(e)},$$.RemoveListener=function(e){for(var t=0;t<$$._listeners.length;t++)if($$._listeners[t]._eventListenerId==e._eventListenerId){$$._listeners.splice(t,1);break}},$$._eventSource=null,$$.Setup=function(){var e=$$._eventSource;if(null==e)e=$$._eventSource=new EventSource("/events");else{try{e.close(),e=$$._eventSource=null}catch(t){}setTimeout($$.Setup,1e3),$$.ShowEventPopup({icon:"images/genie.png",title:"HomeGenie<br/>Event Stream<br/>Reconnecting...",text:"",timestamp:""})}e.onopen=function(){$$.ShowEventPopup({icon:"images/genie.png",title:"HomeGenie<br/>Event Stream<br/>Connected.",text:"",timestamp:""})},e.onerror=function(){$$.ShowEventPopup({icon:"images/genie.png",title:"HomeGenie<br/>EventStream<br/>Disconnected!",text:"",timestamp:""}),e.close(),e=$$._eventSource=null,setTimeout($$.Setup,1e3)},e.onmessage=function(e){var t=JSON&&JSON.parse(e.data)||$.parseJSON(e.data);t.Value=t.Value.toString();var o=null;0==("HomeGenie.System"==t.Domain&&"Console.Output"==t.Property)&&(o=HG.WebApp.Utility.GetModuleByDomainAddress(t.Domain,t.Source),null!=o&&(HG.WebApp.Utility.SetModulePropertyByName(o,t.Property,t.Value,t.Timestamp),HG.WebApp.Control.RefreshGroupIndicators()),$$.SendEventToUi(o,t)),"MIGService.Interfaces"==t.Domain&&HG.WebApp.Home.UpdateInterfacesStatus(),HG.WebApp.Store.get("UI.EventsHistory")&&(HG.WebApp.Data.Events.push(t),HG.WebApp.Data.Events.length>$$._eventQueueCapacity&&HG.WebApp.Data.Events.shift(),null!=$$._ledOffTimeout&&clearTimeout($$._ledOffTimeout),$$.field("#event_status_off",!0).hide(),$$.field("#event_status_on",!0).show(),$$._ledOffTimeout=setTimeout(function(){$$._ledOffTimeout=null,$$.field("#event_status_on",!0).hide(),$$.field("#event_status_off",!0).show()},500),$.mobile.activePage.attr("id")==$$.PageId&&$$.Refresh());for(var a=0;a<$$._listeners.length;a++)$$._listeners[a].parameterEventCallback(o,t)}},$$.Refresh=function(){for(var e=($("#"+$$.PageId),""),t=HG.WebApp.Data.Events.length-1;t>=0;t--){var o=HG.WebApp.Data.Events[t],a=$$.field("property-txt").val(),i=$$.field("source-txt").val(),r=$$.field("domain-txt").val();if(!(""!=r&&o.Domain.indexOf(r)<0||""!=i&&o.Source.indexOf(i)<0||""!=a&&o.Property.indexOf(a)<0)){var n=new Date(o.UnixTimestamp),s=HG.WebApp.Utility.FormatDate(n)+" "+HG.WebApp.Utility.FormatDateTime(n);e+="<tr>",e+='<td><abbr title="'+s+'">'+HG.WebApp.Utility.FormatDateTime(n,"sm")+"</abbr></td>",e+="<td>"+o.Property+"</td>",e+="<td>"+o.Value+"</td>",e+="<td>"+o.Source+"</td>",e+="<td>"+o.Domain+"</td>",e+="</tr>"}}var l=$$.field("events-tbl");l.find("tbody").html(e),l.table().table("refresh")},$$.SendEventToUi=function(module,eventLog){null!=module&&(HG.WebApp.Control.UpdateModuleWidget(eventLog.Domain,eventLog.Source,eventLog.Property,eventLog.Value),$.mobile.activePage.attr("id")==HG.WebApp.WidgetEditor.PageId&&HG.WebApp.WidgetEditor.RenderView(eventLog),("HomeAutomation.HomeGenie.Automation"==module.Domain&&"Program.Status"!=eventLog.Property||"Program.UiRefresh"==eventLog.Property)&&HG.Configure.Modules.Get(module.Domain,module.Address,function(data){try{var mod=eval("["+data+"]")[0],idx=HG.WebApp.Utility.GetModuleIndexByDomainAddress(mod.Domain,mod.Address);HG.WebApp.Data.Modules[idx]=mod,HG.WebApp.Control.UpdateModuleWidget(mod.Domain,mod.Address)}catch(e){}}));var logdate=new Date(eventLog.UnixTimestamp),date=HG.WebApp.Utility.FormatDateTime(logdate),popupdata=null;switch(eventLog.Domain){case"HomeGenie.System":"STARTED"!=eventLog.Value&&"UPDATED"!=eventLog.Value||($$.field("#configure_system_updateinstall_status",!0).html("Update install complete. HomeGenie ready."),setTimeout(function(){document.location.href="/"},3e3));case"HomeGenie.UpdateChecker":if("InstallProgress.Message"==eventLog.Property)$$.field("#configure_system_updateinstall_log",!0).prepend("*&nbsp;"+eventLog.Value+"<br/>");else{$$.field("#configure_system_updateinstall_log",!0).prepend("*&nbsp;<strong>"+eventLog.Property+"</strong><br/>&nbsp;&nbsp;"+eventLog.Value+"<br/>");var iconImage="images/genie.png";popupdata={icon:iconImage,title:eventLog.Property+"<br/>"+eventLog.Value,text:"",timestamp:date}}break;case"HomeGenie.PackageInstaller":var log=$$.field("#systemsettings_browserepo",!0).find("[data-ui-field=install_text]"),restore_log=$$.field("#systemsettings_backuprestores1",!0).find("[data-ui-field=restore_log]");if("InstallProgress.Message"==eventLog.Property)log.append("* "+eventLog.Value+"<br/>"),restore_log.append("* "+eventLog.Value+"<br/>");else{log.append("* <strong>"+eventLog.Property+"</strong><br/>&nbsp;&nbsp;"+eventLog.Value+"<br/>"),restore_log.append("* <strong>"+eventLog.Property+"</strong><br/>&nbsp;&nbsp;"+eventLog.Value+"<br/>");var iconImage="images/genie.png";popupdata={icon:iconImage,title:eventLog.Property+"<br/>"+eventLog.Value,text:"",timestamp:date}}var height=log.parent()[0].scrollHeight;log.parent().scrollTop(height),height=restore_log[0].scrollHeight,restore_log.scrollTop(height);break;case"HomeGenie.BackupRestore":var restore_log=$$.field("#systemsettings_backuprestores1",!0).find("[data-ui-field=restore_log]");restore_log.append("* "+eventLog.Value+"<br/>");var height=restore_log[0].scrollHeight;restore_log.scrollTop(height);break;case"HomeAutomation.HomeGenie.Automation":var iconImage=HG.Ui.GetModuleIcon(module,null);if("Runtime.Error"==eventLog.Property)null!=module&&""!=eventLog.Value?(popupdata={icon:iconImage,title:'<span style="color:yellow;font-size:9pt;">Program '+module.Address+"</span><br><b>"+eventLog.Value+"</b>",text:"Runtime<br />Error",timestamp:date},"page_automation_editprogram"==$.mobile.activePage.attr("id")&&HG.WebApp.ProgramEdit.RefreshProgramOptions()):null!=module&&HG.WebApp.ProgramEdit._CurrentProgram.Address==module.Address&&(HG.WebApp.ProgramEdit._CurrentProgram.ScriptErrors="",HG.WebApp.ProgramEdit.RefreshProgramEditorTitle());else if("Program.Status"==eventLog.Property)null!=module&&HG.WebApp.ProgramEdit._CurrentProgram.Address==module.Address&&HG.WebApp.ProgramEdit.RefreshProgramEditorTitle();else if("Program.Notification"==eventLog.Property){var notification=JSON.parse(eventLog.Value);popupdata={icon:iconImage,title:'<span style="color:yellow;font-size:9pt;">'+notification.Title+"</span><br>"+notification.Message,text:"",timestamp:date}}else $$.IsBlacklisted(eventLog.Property)||(popupdata={icon:iconImage,title:'<span style="color:yellow;font-size:9pt;">'+eventLog.Property+"</span><br>"+eventLog.Value,text:"",timestamp:date});break;case"Protocols.UPnP":case"HomeAutomation.ZWave":if("1"==eventLog.Source){var domain=eventLog.Domain.substr(eventLog.Domain.lastIndexOf(".")+1);popupdata={icon:"images/genie.png",title:'<span style="color:yellow;font-size:9pt;">'+domain+" "+eventLog.Property+"</span><br/>"+eventLog.Value,text:"",timestamp:date};break}default:if(null!=module&&!$$.IsBlacklisted(eventLog.Property)){var iconImage=HG.Ui.GetModuleIcon(module,null);if("RF"!=module.Address&&"IR"!=module.Address||""==eventLog.Value){if("Sensor."==eventLog.Property.substring(0,7)){var group=HG.WebApp.GroupsList.GetModuleGroup(module);null!=group&&(group=group.Name);var name=module.Domain.substring(module.Domain.indexOf(".")+1)+" "+module.Address,propname=eventLog.Property.substring(eventLog.Property.indexOf(".")+1);switch(propname){case"Temperature":iconImage="pages/control/widgets/homegenie/generic/images/temperature.png";var temperature=eventLog.Value.replace(",",".");eventLog.Value=HG.WebApp.Utility.FormatTemperature(temperature);break;case"Luminance":iconImage="pages/control/widgets/homegenie/generic/images/luminance.png";break;default:iconImage="pages/control/widgets/homegenie/generic/images/sensor.png"}""!=module.Name&&(name=module.Name),null==group&&(group=""),popupdata={icon:iconImage,title:'<span style="color:yellow;font-size:9pt;">'+group+"</span><br><b>"+name+"</b><br>"+propname,text:parseFloat(eventLog.Value.replace(",",".")).toFixed(2),timestamp:date}}else if("Status."==eventLog.Property.substring(0,7)){var group=HG.WebApp.GroupsList.GetModuleGroup(module);null!=group&&(group=group.Name);var name=module.Domain.substring(module.Domain.indexOf(".")+1)+" "+module.Address,propname=eventLog.Property.substring(eventLog.Property.indexOf(".")+1),value=eventLog.Value;isNaN(eventLog.Value.replace(",","."))||(value=parseFloat(eventLog.Value.replace(",",".")).toFixed(2)),""!=module.Name&&(name=module.Name),null==group&&(group=""),popupdata={icon:iconImage,title:'<span style="color:yellow;font-size:9pt;">'+group+"</span><br><b>"+name+"</b>",text:propname+"<br />"+value,timestamp:date}}}else iconImage="images/remote.png",popupdata={icon:iconImage,title:'<span style="color:yellow;font-size:9pt;">'+module.Domain.substring(module.Domain.indexOf(".")+1)+"</span><br/>"+eventLog.Value,text:module.Address,timestamp:date};if(HG.WebApp.ProgramEdit._IsCapturingConditions&&""!=eventLog.Value){var conditionobj={Domain:module.Domain,Target:module.Address,Property:eventLog.Property,ComparisonOperator:"Equals",ComparisonValue:eventLog.Value};HG.WebApp.ProgramEdit._CurrentProgram.Conditions.push(conditionobj),automationpage_ConditionsRefresh()}else if(HG.WebApp.ProgramEdit._IsCapturingCommands&&""!=eventLog.Value){var command=HG.WebApp.Utility.GetCommandFromEvent(module,eventLog);null!=command&&(HG.WebApp.ProgramEdit._CurrentProgram.Commands.push(command),automationpage_CommandsRefresh())}}}null!=popupdata&&!$$.PopupHasIgnore(eventLog.Domain,eventLog.Source,eventLog.Property)&&eventLog.Description.indexOf(":nopopup:")<0&&!$$.IsBlacklisted(eventLog.Property)&&$$.ShowEventPopup(popupdata,eventLog)},$$.IsBlacklisted=function(e){return!("Meter.Watts"!=e&&!e.startsWith("ConfigureOptions.")&&"Program.UiRefresh"!=e)},$$.PopupRefreshIgnore=function(){var e=HG.WebApp.Store.get("UI.EventPopupIgnore");if(null!=e){$$.field("#popupsettings_ignorelist",!0).find("li:gt(0)").remove();for(var t=0;t<e.length;t++){var o='<li data-icon="minus">';o+='    <a href="#" class="ui-grid-b" onclick="$$.PopupRemoveIgnore('+t+')">',o+='        <div class="ui-block-a hg-label" style="width:40%">'+e[t].Domain+"</div>",o+='        <div class="ui-block-b hg-label" style="width:20%" align="center">'+e[t].Address+"</div>",o+='        <div class="ui-block-c hg-label" style="width:40%">'+e[t].Property+"</div>",o+="    </a>",o+="</li>",$$.field("#popupsettings_ignorelist",!0).append(o)}$$.field("#popupsettings_ignorelist",!0).listview().trigger("create"),$$.field("#popupsettings_ignorelist",!0).listview("refresh")}},$$.PopupHasIgnore=function(e,t,o){var a=HG.WebApp.Store.get("UI.EventPopupIgnore");if(null==a)return!1;for(var i=!1,r=0;r<a.length;r++)if(a[r].Domain==e&&a[r].Address==t&&a[r].Property==o){i=!0;break}return i},$$.PopupRemoveIgnore=function(e){var t=HG.WebApp.Store.get("UI.EventPopupIgnore");null==t||t.length<=e||(t.splice(e,1),$$.PopupRefreshIgnore())},$$.PopupAddIgnore=function(e,t,o){var a=HG.WebApp.Store.get("UI.EventPopupIgnore");null==a&&(a=Array()),$$.PopupHasIgnore(e,t,o)||(a.push({Domain:e,Address:t,Property:o}),HG.WebApp.Store.set("UI.EventPopupIgnore",a)),$$.field("#statuspopup",!0).css("display","none")},$$.ShowEventPopup=function(e,t){var o='<table width="100%"><tr><td width="42" valign="top">';o+='<img src="'+e.icon+'" width="42">',o+='</td><td valign="top" align="left">',o+=e.title,o+='</td><td align="right" style="color:lime;font-size:12pt">'+e.text+"</td></tr>",o+='<tr style="color:gray;font-size:9pt;"><td colspan="2">'+e.timestamp+"</td>",t&&(o+='<td align="right"><a href="#" title="Block popup from this source" onclick="HG.WebApp.Events.PopupAddIgnore(\''+t.Domain+"','"+t.Source+"','"+t.Property+'\')"><img border="0" alt="Block popup from this source" src="images/halt.png" /></a></td>'),o+="</tr>",o+="</table>";var a=$$.field("#statuspopup",!0);a.html(o),null!=$$._popupHideTimeout?clearTimeout($$._popupHideTimeout):(a.css("display",""),a.animate({opacity:"0"},0,function(){a.animate({right:"5px",opacity:"0.90"},300)})),$$._popupHideTimeout=setTimeout(function(){"none"!=a.css("display")&&a.animate({right:"-300px",opacity:"0.0"},300,function(){a.css("display","none")}),$$._popupHideTimeout=null},5e3)}},HG.Ui.CreatePage(HG.WebApp.Events,"page_events"),HG.WebApp.Control=HG.WebApp.Control||new function(){var $$=this;$$._widgetConfiguration=[],$$._widgetList=[],$$._renderModuleDelay=null,$$._renderModuleBusy=!1,$$.InitializePage=function(){var page=$$.getContainer();page.on("pageinit",function(e){$$.toolbarMacroRecord=$("#toolbar_macrorecord"),$$.toolbarMacroRecord.hide(),$$.toolbarControl=$("#toolbar_control"),$$.toolbarControl.show(),$$.recordDelayNone=$("#macrorecord_delay_none"),$$.recordDelayMimic=$("#macrorecord_delay_mimic"),$$.recordDelayFixed=$("#macrorecord_delay_fixed"),$("#control_macrorecord_optionspopup").bind("popupafterclose",function(){$$.recordDelayNone.prop("checked")?HG.Automation.Macro.SetDelay("None",""):$$.recordDelayMimic.prop("checked")?HG.Automation.Macro.SetDelay("Mimic",""):$$.recordDelayFixed.prop("checked")&&HG.Automation.Macro.SetDelay("Fixed",$$.field("#macrorecord_delay_seconds",!0).val())}),$$.controlGroupSelect=$("#control_groupselect"),$$.controlGroupSelect.change(function(){var e=$$.controlGroupSelect.val();$$.ShowGroup(e)}),$.ajax({url:"pages/control/widgets/configuration.json",type:"GET",success:function(data){$$._widgetConfiguration=eval(data)},error:function(){alert("error loading widgets configuration")}})}),page.on("pagehide",function(){widgetsloadtimer&&clearTimeout(widgetsloadtimer),null!=$$._renderModuleDelay&&clearTimeout($$._renderModuleDelay),$$._renderModuleBusy=!1,widgetsloadqueue=[],$$.field('div[data-ui-field="wallpaper"]',!0).hide()}),page.on("pagebeforeshow",function(){$$.clearCache(),$.mobile.loading("show"),HG.Configure.Groups.List("Control",function(){0==$$.field("#control_groupslist",!0).children().length&&$$.RenderGroups(),$$.UpdateModules()}),HG.Automation.Macro.GetDelay(function(e){$$.recordDelayNone.prop("checked",!1).checkboxradio("refresh"),$$.recordDelayMimic.prop("checked",!1).checkboxradio("refresh"),
$$.recordDelayFixed.prop("checked",!1).checkboxradio("refresh"),$$.field("#macrorecord_delay_"+e.DelayType.toLowerCase(),!0).prop("checked",!0).checkboxradio("refresh"),$$.field("#macrorecord_delay_seconds",!0).val(e.DelayOptions)})}),$$.field("#control_bottombar_voice_button",!0).on("click",function(){var e=$(this),t=$$.field("#speechinput",!0);"none"==t.css("display")?(e.removeClass("ui-icon-carat-u"),e.addClass("ui-icon-carat-d"),t.show(150),t.find("input").focus()):(e.removeClass("ui-icon-carat-d"),e.addClass("ui-icon-carat-u"),t.hide(150),t.find("input").blur()),setTimeout(function(){e.removeClass("ui-btn-active")},200)}),$$.field("#voicerecognition_text",!0).on("change",function(){HG.VoiceControl.InterpretInput($(this).val())}).on("keyup",function(e){13==e.keyCode&&HG.VoiceControl.InterpretInput($(this).val())}),$$.field("#groups_panel",!0).panel().trigger("create"),$$.field("#groups_panel",!0).on("beforeopen",function(){setTimeout($$.RenderMenu,1e3)})},$$.ShowGroup=function(e){$.mobile.loading("show"),HG.WebApp.Data._CurrentGroup=HG.WebApp.GroupModules.CurrentGroup=HG.WebApp.Data.Groups[e].Name,HG.WebApp.Data._CurrentGroupIndex=e,$$.field('div[data-ui-field="wallpaper"]',!0).show(),$$.field('div[data-ui-field="wallpaper"]',!0).css("background-image","url(images/wallpapers/"+HG.WebApp.Data.Groups[e].Wallpaper+")"),$$.RefreshGroupIndicators(),$$.field("#control_groupcontent",!0).children("div").hide(),$$.field("#groupdiv_modules_"+HG.WebApp.Data._CurrentGroupIndex,!0).show(),setTimeout(function(){$$.RenderGroupModules(e)},100)},$$.UpdateModules=function(){$.mobile.loading("show"),HG.Configure.Modules.List(function(e){try{HG.WebApp.Data.Modules=e}catch(t){}HG.Automation.Programs.List(function(){$.mobile.loading("hide"),$$.ShowGroup(HG.WebApp.Data._CurrentGroupIndex)})})},$$.ConfigureGroup=function(){HG.WebApp.GroupsList.ConfigureGroup(HG.WebApp.Data._CurrentGroupIndex)},$$.RecordMacroStart=function(){$$.field("#control_actionmenu",!0).popup("close"),HG.Automation.Macro.Record(),$$.toolbarControl.hide("slidedown"),setTimeout(function(){$$.toolbarMacroRecord.show("slideup")},500),$$.field("#btn_control_macrorecord",!0).qtip({content:{title:HG.WebApp.Locales.GetLocaleString("control_macrorecord_recording"),text:HG.WebApp.Locales.GetLocaleString("control_macrorecord_description"),button:HG.WebApp.Locales.GetLocaleString("control_macrorecord_close")},show:{event:!1,ready:!0,delay:1500},events:{hide:function(){$(this).qtip("destroy")}},hide:{event:!1,inactive:5e3},style:{classes:"qtip-red qtip-shadow qtip-rounded qtip-bootstrap"},position:{my:"bottom center",at:"top center"}})},$$.RecordMacroSave=function(e){$.mobile.loading("show"),HG.Automation.Macro.Save(e,function(e){HG.Automation.Programs.List(function(){HG.WebApp.AutomationGroupsList._CurrentGroup="",HG.WebApp.ProgramEdit._CurrentProgram.Address=e,HG.Configure.Groups.List("Automation",function(){HG.WebApp.ProgramsList.EditProgram(),$.mobile.changePage($$.field("#page_automation_editprogram",!0),{transition:"fade",changeHash:!0}),$.mobile.loading("hide")})})}),$$.toolbarControl.show("slideup"),$$.toolbarMacroRecord.hide("slidedown")},$$.RecordMacroDiscard=function(){HG.Automation.Macro.Discard(),$$.toolbarControl.show("slideup"),$$.toolbarMacroRecord.hide("slidedown")},$$.RenderMenu=function(){for($$.field("#control_groupsmenu",!0).find("li:gt(0)").remove(),i=0;i<HG.WebApp.Data.Groups.length;i++){var e='<div class="ui-body-inherit ui-body-a" style="display:block;margin-left:0px;border:0;overflow:hidden;cursor:pointer"><table><tr id="control_groupindicators_'+i+'"></tr></table></div>',t=$('<li data-context-idx="'+i+'" style="height:auto"><a class="ui-btn ui-btn-icon-left ui-icon-carat-r" href"#">'+HG.WebApp.Data.Groups[i].Name+"</a>"+e+"</li>");t.on("click",function(){var e=$(this).attr("data-context-idx");$$.ShowGroup(e),$.mobile.pageContainer.pagecontainer("change","#page_control",{transition:"none"})}),$$.field("#control_groupsmenu",!0).append(t)}$$.field("#control_groupsmenu",!0).listview().listview("refresh")},$$.RenderGroups=function(){for($.each($$.field("#control_groupcontent",!0).find("div[class=isotope]"),function(){$(this).isotope("destroy")}),$$.field("#control_groupcontent",!0).empty(),i=0;i<HG.WebApp.Data.Groups.length;i++)0==i&&(HG.WebApp.Data._CurrentGroup=HG.WebApp.Data.Groups[i].Name),$$.field("#control_groupcontent",!0).append('<div id="groupdiv_modules_'+i+'" />')},$$.GetWidget=function(e,t){for(var o=!1,a=0;a<$$._widgetList.length;a++)if($$._widgetList[a].Widget==e){if(o=!0,"function"==typeof t){var i=$$._widgetList[a],r=HG.WebApp.WidgetEditor.GetInstance(i.Json);t({Widget:i.Widget,Instance:r,Json:i.Json,Model:i.Model})}break}""==e||o?o||"function"==typeof t&&t(null):$.ajax({url:"pages/control/widgets/"+e+".js",type:"GET",dataType:"text",success:function(o){var a=null,i=o;$.get("pages/control/widgets/"+e+".html",function(o){var r={Widget:e,Instance:null,Json:i,Model:o};$$._widgetList.push(r);try{a=HG.WebApp.WidgetEditor.GetInstance(i)}catch(n){alert(e+" Loading Error:\n"+n)}"function"==typeof t&&t({Widget:e,Instance:a,Json:i,Model:o})})},error:function(e){console.log(e),"function"==typeof t&&t(null)}})};var widgetsloadqueue=[],widgetsloadtimer=null;$$.RenderModule=function(){if(clearTimeout(widgetsloadtimer),widgetsloadqueue.length>0){var t=widgetsloadqueue.splice(0,1)[0],o=$$.field("#"+t.ElementId,!0).data("homegenie.widget");if(null!=o&&"undefined"!=o)HG.WebApp.WidgetEditor.RenderWidget("#"+t.ElementId,o,o.module),widgetsloadtimer=setTimeout(function(){$$.RenderModule()},10);else{var a='<div class="freewall"><div id="'+t.ElementId+'" style="display:none" class="hg-widget-container" data-context-group="'+t.GroupName+'" data-context-value="'+HG.WebApp.Utility.GetModuleIndexByDomainAddress(t.Module.Domain,t.Module.Address)+'">';$$.GetWidget(t.Module.Widget,function(o){if("undefined"!=typeof o&&null!=o)if(a+=o.Model,a+="</div></div>",t.GroupElement.append(a),t.GroupElement.trigger("create"),null!=o.Json){var i=HG.WebApp.WidgetEditor.GetInstance(o.Json);$$.field("#"+t.ElementId,!0).data("homegenie.widget",i),t.Module.WidgetInstance=i,HG.WebApp.Locales.LocalizeWidget(t.Module.Widget,t.ElementId,function(){$$.field("#"+t.ElementId,!0).show();var e=t.Module;HG.WebApp.WidgetEditor.RenderWidget("#"+t.ElementId,e.WidgetInstance,e),widgetsloadtimer=setTimeout(function(){$$.RenderModule()},0)})}else alert(t.Module.Widget+" Widget Instance Error:\n"+e),widgetsloadtimer=setTimeout(function(){$$.RenderModule()},0);else console.log(t.Module.Widget+" Widget Error."),widgetsloadtimer=setTimeout(function(){$$.RenderModule()},0)})}}else $$._renderModuleBusy=!1,$$.field("#groupdiv_modules_"+HG.WebApp.Data._CurrentGroupIndex,!0).isotope({itemSelector:".freewall",layoutMode:"fitRows"}).isotope().addClass("isotope"),$$.UpdateActionsMenu(),$.mobile.loading("hide")},$$.EditModule=function(e){HG.WebApp.GroupModules.CurrentGroup=HG.WebApp.Data._CurrentGroup,HG.WebApp.GroupModules.CurrentModule=e;var t=e.DeviceType;HG.WebApp.GroupModules.ModuleEdit(function(){if(t!=e.DeviceType){var o=$$.field("#groupdiv_modules_"+HG.WebApp.Data._CurrentGroupIndex,!0);o.empty(),$$.ShowGroup(HG.WebApp.Data._CurrentGroupIndex)}else $$.UpdateModuleWidget(e.Domain,e.Address)})},$$.EditModuleParams=function(e){HG.WebApp.GroupModules.CurrentGroup=HG.WebApp.Data._CurrentGroup,HG.WebApp.GroupModules.CurrentModule=e,$$.field("#page_configure_groupmodules_propspopup",!0).popup("open",{transition:"pop",positionTo:"window"})},$$.GetModuleUid=function(e){var t=e.Domain.substring(e.Domain.lastIndexOf(".")+1).replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~() ]/g,"_"),o=e.Address.replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~() ]/g,"_"),a=t+"_"+o;return a},$$.UpdateActionsMenu=function(){$$.field("#control_custom_actionmenu",!0).empty();for(var e=0;e<HG.WebApp.Data.Groups.length;e++)if(e==HG.WebApp.Data._CurrentGroupIndex)for(var t=HG.Configure.Groups.GetGroupModules(HG.WebApp.Data.Groups[e].Name),o=0;o<t.Modules.length;o++){var a=t.Modules[o];"homegenie/generic/program"==a.Widget&&$$.field("#control_custom_actionmenu",!0).append('<li><a class="ui-btn ui-icon-fa-play-circle-o ui-btn-icon-right" onclick="HG.Automation.Programs.Toggle(\''+a.Address+"', '"+HG.WebApp.Data._CurrentGroup+"')\">"+HG.WebApp.Locales.GetProgramLocaleString(a.Address,"Title",a.Name)+"</a></li>")}$$.field("#control_custom_actionmenu",!0).listview("refresh")},$$.UpdateModuleWidget=function(e,t,o,a){for(var i=0;i<HG.WebApp.Data.Groups.length;i++)for(var r=HG.Configure.Groups.GetGroupModules(HG.WebApp.Data.Groups[i].Name),n=0;n<r.Modules.length;n++){var s=r.Modules[n];if(s.Domain==e&&s.Address==t){var l="groupdiv_modules_"+r.Index+"_module_"+$$.GetModuleUid(s),d="#"+l,p=$$.field(d,!0),u=s.DeviceType+"";u=u.toLowerCase(),0!=p.length&&p.data("homegenie.widget")&&(s.WidgetInstance=p.data("homegenie.widget"),HG.WebApp.WidgetEditor.RenderWidget(d,s.WidgetInstance,s,{Property:o,Value:a}))}}},$$.RenderGroupModules=function(e){if(widgetsloadqueue.length>0||$$._renderModuleBusy)return null!=$$._renderModuleDelay&&clearTimeout($$._renderModuleDelay),void($$._renderModuleDelay=setTimeout(function(){$$.RenderGroupModules(e)},500));$$._renderModuleBusy=!0,$$._renderModuleDelay=null;for(var t=HG.Configure.Groups.GetGroupModules(HG.WebApp.Data.Groups[e].Name),o=$$.field("#groupdiv_modules_"+t.Index,!0),a=0;a<t.Modules.length;a++){var i=t.Modules[a],r=$$.field("#groupdiv_modules_"+t.Index,!0).attr("id")+"_module_"+$$.GetModuleUid(i),n="#"+r,s=$$.field(n,!0),l=i.DeviceType+"";l=l.toLowerCase();var d=!1;if(i.Domain==HG.WebApp.GroupModules.SeparatorItemDomain&&(i.Widget="homegenie/generic/grouplabel",d=!0),!d){var p=HG.WebApp.Utility.GetModulePropertyByName(i,"Widget.DisplayModule");null!=p&&""!=p.Value&&(i.Widget=p.Value,d=!0)}if(!d)for(var u=0;u<$$._widgetConfiguration.length;u++){var c=$$._widgetConfiguration[u],m=HG.WebApp.Utility.GetModulePropertyByName(i,c.MatchProperty);if(null!=m&&("*"==c.MatchValue||m.Value==c.MatchValue)){i.Widget=c.Widget,d=!0;break}}d||(i.Widget="homegenie/generic/"+("undefined"==l?"unknown":l)),0==s.length?widgetsloadqueue.push({GroupName:HG.WebApp.Data.Groups[e].Name,GroupElement:o,ElementId:r,Module:i}):s.data("homegenie.widget")&&(i.WidgetInstance=s.data("homegenie.widget"),HG.WebApp.WidgetEditor.RenderWidget(n,i.WidgetInstance,i))}widgetsloadtimer=setTimeout(function(){$$.RenderModule()},10),0==widgetsloadqueue.length&&$$.UpdateActionsMenu()},$$.RefreshGroupIndicators=function(){for(var e=0;e<HG.WebApp.Data.Groups.length;e++){for(var t=HG.Configure.Groups.GetGroupModules(HG.WebApp.Data.Groups[e].Name),o=0,a=0,i=0,r=null,n=null,s=null,l=($$.field("#groupdiv_modules_"+t.Index,!0),0);l<t.Modules.length;l++){var d=t.Modules[l],p=$$.field("#groupdiv_modules_"+t.Index,!0).attr("id")+"_module_"+$$.GetModuleUid(d),u="#"+p,c=($$.field(u,!0),d.DeviceType+"");c=c.toLowerCase();var m=HG.WebApp.Utility.GetModulePropertyByName(d,"Meter.Watts"),g=HG.WebApp.Utility.GetModulePropertyByName(d,"Status.Level");if(null!=m&&null!=g&&0!=parseFloat(g.Value.replace(",","."))&&(o+=parseFloat(m.Value.replace(",","."))/1e3),null!=g&&0!=parseFloat(g.Value.replace(",",".")))switch(c){case"dimmer":case"light":a++;break;case"switch":i++}if(null==r){var f=HG.WebApp.Utility.GetModulePropertyByName(d,"Sensor.Temperature");null!=f&&""!=f.Value&&(r=parseFloat(f.Value.replace(",",".")))}if(null==n){var $=HG.WebApp.Utility.GetModulePropertyByName(d,"Sensor.Humidity");null!=$&&""!=$.Value&&(n=parseFloat($.Value.replace(",",".")))}if(null==s){var g=HG.WebApp.Utility.GetModulePropertyByName(d,"Sensor.Luminance");null!=g&&""!=g.Value&&(s=parseFloat(g.Value.replace(",",".")))}}var b="";o>0&&(b+='<td align="center"><span class="hg-indicator-energy">'+(1e3*o).toFixed(1)+"</span></td>"),i>0&&(b+='<td align="center"><span class="hg-indicator-plug">'+i+"</span></td>"),a>0&&(b+='<td align="center"><span class="hg-indicator-bulb">'+a+"</span></td>"),null!=r&&(displayvalue=HG.WebApp.Utility.FormatTemperature(r),b+='<td align="center"><span class="hg-indicator-temperature">'+displayvalue+"</span></td>"),null!=s&&(b+='<td align="center"><span class="hg-indicator-luminance">'+(1*s).toFixed(0)+"</span></td>"),null!=n&&(b+='<td align="center"><span class="hg-indicator-humidity">'+(1*n).toFixed(0)+"</span></td>"),$$.field("#control_groupindicators_"+e,!0).html(b),e==HG.WebApp.Data._CurrentGroupIndex&&($$.field("#control_groupmenutitle",!0).html(HG.WebApp.Data.Groups[e].Name),$$.field("#control_groupindicators",!0).html(b))}},$$.LoadGroups=function(){$.mobile.loading("show"),HG.Configure.Groups.List("Control",function(){$$.RenderGroups()})}},HG.Ui.CreatePage(HG.WebApp.Control,"page_control"),HG.WebApp.Statistics=HG.WebApp.Statistics||new function(){var $$=this;$$._CurrentTab=1,$$._InitDateFromTo=4,$$._CurrentModule="",$$._CurrentParameter="Meter.Watts",$$._CurrentGraphType="bars",$$._CurrentType="hours",$$._RefreshIntervalObject=null,$$._RefreshInterval=3e5,$$._SelItemObject=!1,$$._ItemObject="",$$.InitializePage=function(){$("#page_analyze_source").on("change",function(){var e=$(this).find("option:selected"),t=e.attr("data-context-domain")+":"+e.attr("data-context-address");":"==t&&(t=""),$$.RefreshParameters(t)}),$("#page_analyze_param").on("change",function(){$$.RefreshModules()}),$("#page_analyze_renderbutton").bind("click",function(){var e=$("#page_analyze_source").find("option:selected");$$._CurrentModule=e.attr("data-context-domain")+":"+e.attr("data-context-address"),":"==$$._CurrentModule&&($$._CurrentModule=""),$$._CurrentParameter=$("#page_analyze_param").val(),$$._CurrentType=$("#page_analyze_type").val(),"Meter."==$$._CurrentParameter.substring(0,6)||"PowerMonitor."==$$._CurrentParameter.substring(0,13)?$("#statistics_tab3_button").show():$("#statistics_tab3_button").hide(),$$.SetTab(1),$("#page_analyze_title").html($("#page_analyze_source").find("option:selected").text()+" - "+$("#page_analyze_param").find("option:selected").text()),$("#page_analyze_title2").html($("#page_analyze_title").val()),$("#analyze_stats_options").popup("close")}),$("#page_analyze_costperunit").on("change",function(){var e=$("#page_analyze_costperunit").val()*$("#page_analyze_totalunits").val();$("#page_analyze_totalcost").val(e.toFixed(2)),HG.WebApp.Store.set("UI.Statistics.CostPerUnit",$("#page_analyze_costperunit").val())}),$("#analyze_stats_options").on("popupbeforeposition",function(){$$.RefreshModules(),$$.RefreshParameters()}),$("#page_analyze_datefrom").val(""),$("#page_analyze_datefrom").on("change",function(){0==$$._InitDateFromTo?$$.Refresh():$$._InitDateFromTo-=1}),$("#page_analyze_dateto").val(""),$("#page_analyze_dateto").on("change",function(){0==$$._InitDateFromTo?$$.Refresh():$$._InitDateFromTo-=1}),$("#statshour").qtip({id:"flot",prerender:!0,content:" ",position:{target:"mouse",viewport:$("#flot"),adjust:{x:5}},show:!1,hide:{event:!1,fixed:!0}}),$("#statshour").bind("plothover",function(e,t,o){var a,i=$(this),r=i.qtip();if(!o)return r.cache.point=!1,r.hide(o);if(a=r.cache.point,a!==o.dataIndex){var n=60*(new Date).getTimezoneOffset()*1e3;r.cache.point=o.dataIndex,r.set("content.text",o.series.label+" at "+new Date(o.datapoint[0]+n).toLocaleTimeString()+" = "+o.datapoint[1].toFixed(2)),"days"==$$._CurrentType?0==$$._SelItemObject&&($("#page_delete_stat").html("Delete Value : "+o.datapoint[1]),$$._ItemObject=o.datapoint[0]+"/"+o.datapoint[1],r.elements.tooltip.stop(1,1),r.show(o)):(r.elements.tooltip.stop(1,1),r.show(o))}}),$("#statscounter").qtip({id:"flot",prerender:!0,content:" ",position:{target:"mouse",viewport:$("#flot"),adjust:{x:5}},show:!1,hide:{event:!1,fixed:!0}}),$("#statscounter").bind("plothover",function(e,t,o){var a,i=$(this),r=i.qtip();if(!o)return r.cache.point=!1,r.hide(o);if(a=r.cache.point,a!==o.dataIndex){var n=60*(new Date).getTimezoneOffset()*1e3;r.cache.point=o.dataIndex,r.set("content.text",o.series.label+" at "+new Date(o.datapoint[0]+n).toLocaleTimeString()+" = "+o.datapoint[1].toFixed(2)),r.elements.tooltip.stop(1,1),r.show(o)}}),$("#page_delete_stat").on("click",function(){1==$$._SelItemObject&&($.ajax({url:"/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Statistics/Parameter.StatDelete/"+$$._ItemObject,type:"GET",success:function(data){var stats=eval(data);$.mobile.loading("hide")},error:function(e){console.log("STATISTICS ERROR: "+e.status+":"+e.statusText),$.mobile.loading("hide")}}),$$._ItemObject=""),$$._SelItemObject=!1,$("#page_delete_stat").hide()}),$("#statshour").on("click",function(){0==$$._SelItemObject?""!=$$._ItemObject&&($$._SelItemObject=!0,$("#page_delete_stat").show()):($$._ItemObject="",$$._SelItemObject=!1,$("#page_delete_stat").hide())})},$$.SetTab=function(e){$$._CurrentTab=e,$("#statistics_tab1").hide(),$("#statistics_tab2").hide(),$("#statistics_tab1_button").removeClass("ui-btn-active"),$("#statistics_tab2_button").removeClass("ui-btn-active"),$("#statistics_tab"+e).show(),$("#statistics_tab"+e+"_button").addClass("ui-btn-active"),$$.Refresh()},$$.SetAutoRefresh=function(e){null!=$$._RefreshIntervalObject&&clearInterval($$._RefreshIntervalObject),$$._RefreshIntervalObject=null,e&&($$._RefreshIntervalObject=setInterval("HG.WebApp.Statistics.Refresh();",$$._RefreshInterval))},$$.InitConfiguration=function(){$("#page_analyze_costperunit").val(HG.WebApp.Store.get("UI.Statistics.CostPerUnit")?HG.WebApp.Store.get("UI.Statistics.CostPerUnit"):22e-5),HG.Statistics.ServiceCall("Configuration.Get","","",function(e){var t=1*e.StatisticsUIRefreshSeconds;$$._RefreshInterval=1e3*t,$$.SetAutoRefresh(!0),$$.SetTab(1)})},$$.RefreshParameters=function(e){var t=$("#page_analyze_param").val();""==t&&(t="Meter.Watts"),$("#page_analyze_param").empty(),HG.Statistics.ServiceCall("Parameter.List",e,"",function(e){for(var o=0;o<e.length;o++){var a=e[o];a.indexOf(".")>0&&(a=a.substring(a.indexOf(".")+1)),$("#page_analyze_param").append('<option value="'+e[o]+'"'+(e[o]==t?" selected":"")+">"+a+"</option>")}$("#page_analyze_param").selectmenu("refresh")})},$$.RefreshModules=function(){var e=$("#page_analyze_source").find("option:selected"),t=e.attr("data-context-domain"),o=e.attr("data-context-address");$("#page_analyze_source").empty(),$("#page_analyze_source").append('<option data-context-domain="" data-context-address="" value="">Global averages</option>');var a="All"==t;$("#page_analyze_source").append('<option data-context-domain="All" data-context-address="" value=""'+(a?" selected":"")+">Compare all</option>");for(var i="",r=0;r<HG.WebApp.Data.Groups.length;r++){for(var n=HG.WebApp.Data.Groups[r],s=HG.Configure.Groups.GetGroupModules(n.Name).Modules,l="",d=0;d<s.length;d++){var p=s[d];if("undefined"!=typeof p.Properties)for(var u=0;u<p.Properties.length;u++)if(p.Properties[u].Name==$("#page_analyze_param").val()){var c=p.Domain+":"+p.Address;""!=p.Name&&(c=p.Name);var m=p.Domain==t&&p.Address==o;l+='<option data-context-domain="'+p.Domain+'" data-context-address="'+p.Address+'"'+(m?" selected":"")+">"+c+"</option>";break}}""!=l&&(i+='<optgroup label="'+n.Name+'">',i+=l,i+="</optgroup>")}$("#page_analyze_source").append(i),$("#page_analyze_source").selectmenu("refresh")},$$.Refresh=function(){$.mobile.loading("show");var showsplines="splines"==$$._CurrentGraphType,showlines="lines"==$$._CurrentGraphType,showbars="bars"==$$._CurrentGraphType,showtype="hours"==$$._CurrentType;if(1==$$._CurrentTab)0==$$._SelItemObject&&$("#page_delete_stat").hide(),HG.Statistics.ServiceCall("Global.TimeRange","","",function(trange){var start=new Date(parseFloat(trange.StartTime)),end=new Date(parseFloat(trange.EndTime)),today=new Date,minDays=Math.ceil((today-start)/864e5);$("#page_analyze_datefrom").datebox("option",{minDays:minDays,maxDays:0,useLang:HG.WebApp.Utility.GetDateBoxLocale()}).datebox("refresh"),$("#page_analyze_dateto").datebox("option",{minDays:minDays,maxDays:0,useLang:HG.WebApp.Utility.GetDateBoxLocale()}).datebox("refresh"),""==$("#page_analyze_datefrom").val()&&($("#page_analyze_datefrom").datebox("setTheDate",today),$("#page_analyze_datefrom").trigger("datebox",{method:"doset"})),""==$("#page_analyze_dateto").val()&&($("#page_analyze_dateto").datebox("setTheDate",today),$("#page_analyze_dateto").trigger("datebox",{method:"doset"}));var dfrom=new Date($("#page_analyze_datefrom").datebox("getTheDate").getTime()),dto=new Date($("#page_analyze_dateto").datebox("getTheDate").getTime());if(dfrom.setHours(0,0,0,0),dto.setHours(23,59,59,0),"All:"!=$$._CurrentModule)1==showtype?$.ajax({url:"/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Statistics/Parameter.StatsHour/"+$$._CurrentParameter+"/"+$$._CurrentModule+"/"+dfrom.getTime()+"/"+dto.getTime(),type:"GET",success:function(data){var stats=eval(data);try{if("Sensor.Temperature"==$$._CurrentParameter)for(var sx=0;sx<stats.length;sx++)for(var tx=0;tx<stats[sx].length;tx++)stats[sx][tx][1]=HG.WebApp.Utility.GetLocaleTemperature(stats[sx][tx][1]);var dateFormat=HG.WebApp.Store.get("UI.DateFormat");$.plot($("#statshour"),[{label:"Max",data:stats[1],bars:{show:showbars,barWidth:18e5,align:"center",steps:!0}},{label:"Avg",data:stats[2],bars:{show:showbars,barWidth:18e5,align:"center",steps:!0}},{label:"Min",data:stats[0],bars:{show:showbars,barWidth:18e5,align:"center",steps:!0}},{label:"Today Avg",data:stats[3],bars:{show:showbars,barWidth:6e5,align:"center",steps:!1}},{label:"Today Detail",data:stats[4],lines:{show:!0,lineWidth:2},bars:{show:!1},splines:{show:!1},points:{show:!1}}],{yaxis:{show:!0},xaxis:{mode:"time",timeformat:"MDY12"==dateFormat?"%h:00%p":"%h:00",minTickSize:[1,"hour"],tickSize:[1,"hour"]},legend:{position:"nw",noColumns:5,backgroundOpacity:.3},lines:{show:showlines,lineWidth:1},series:{splines:{show:showsplines}},grid:{backgroundColor:{colors:["#fff","#ddd"]},hoverable:!0},colors:["rgba(200, 255, 0, 0.5)","rgba(120, 160, 0, 0.5)","rgba(40, 70, 0, 0.5)","rgba(110, 80, 255, 0.5)","rgba(200, 30, 0, 1.0)"],points:{show:!0},zoom:{interactive:!0},pan:{interactive:!0}})}catch(e){console.log(e)}$.mobile.loading("hide")},error:function(e){console.log("STATISTICS ERROR: "+e.status+":"+e.statusText),$.mobile.loading("hide")}}):$.ajax({url:"/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Statistics/Parameter.StatsDay/"+$$._CurrentParameter+"/"+$$._CurrentModule+"/"+dfrom.getTime()+"/"+dto.getTime(),type:"GET",success:function(data){var stats=eval(data);try{if("Sensor.Temperature"==$$._CurrentParameter)for(var sx=0;sx<stats.length;sx++)for(var tx=0;tx<stats[sx].length;tx++)stats[sx][tx][1]=HG.WebApp.Utility.GetLocaleTemperature(stats[sx][tx][1]);$.plot($("#statshour"),[{label:$("#page_analyze_title").text(),data:stats[0],lines:{show:!0,lineWidth:1},bars:{show:!1},splines:{show:!1},points:{show:!1}}],{yaxis:{show:!0},xaxis:{mode:"time",timeformat:"%d/%m",minTickSize:[1,"day"],tickSize:[1,"day"]},legend:{position:"nw",noColumns:5,backgroundOpacity:.3},lines:{show:showlines,lineWidth:1},series:{splines:{show:showsplines}},grid:{backgroundColor:{colors:["#fff","#ddd"]},hoverable:!0},colors:["rgba(200, 30, 0, 1.0)"],points:{show:!0},zoom:{interactive:!0},pan:{interactive:!0}})}catch(e){console.log(e)}$.mobile.loading("hide")},error:function(e){console.log("STATISTICS ERROR: "+e.status+":"+e.statusText),$.mobile.loading("hide")}});else{var dateFormat=HG.WebApp.Store.get("UI.DateFormat");$.ajax({url:"/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Statistics/Parameter.StatsMultiple/"+$$._CurrentParameter+"/"+$$._CurrentModule+"/"+dfrom.getTime()+"/"+dto.getTime(),type:"GET",success:function(data){var name="",tformat="",tickSize="",graph_data=[],stats=eval(data);if("Sensor.Temperature"==$$._CurrentParameter)for(var sx=1;sx<stats.length;sx+=2)for(var tx=0;tx<stats[sx].length;tx++)stats[sx][tx][1]=HG.WebApp.Utility.GetLocaleTemperature(stats[sx][tx][1]);1==showtype?(tformat="MDY12"==dateFormat?"%h:00%p":"%h:00",tickSize="hour"):(tformat="%d/%m",tickSize="day"),$.each(stats,function(e,t){e%2?graph_data.push({label:name,data:t,lines:{show:!0,lineWidth:2},bars:{show:!1},splines:{show:!1},points:{show:!1}}):name=t}),$.plot($("#statshour"),graph_data,{yaxis:{show:!0},xaxis:{mode:"time",timeformat:tformat,minTickSize:[1,tickSize],tickSize:[1,tickSize]},legend:{backgroundOpacity:.3},grid:{backgroundColor:{colors:["#fff","#ddd"]},hoverable:!0},points:{show:!0},zoom:{interactive:!0},pan:{interactive:!0}}),$.mobile.loading("hide")},error:function(e){console.log("STATISTICS ERROR: "+e.status+":"+e.statusText),$.mobile.loading("hide")}})}});else{HG.Statistics.ServiceCall("Global.CounterTotal",$$._CurrentParameter,"",function(e){$("#page_analyze_totalunits").val((1*e).toFixed(2));var t=$("#page_analyze_costperunit").val()*$("#page_analyze_totalunits").val();$("#page_analyze_totalcost").val(t.toFixed(2))});var dfrom=new Date($("#page_analyze_datefrom").datebox("getTheDate").getTime()),dto=new Date($("#page_analyze_dateto").datebox("getTheDate").getTime());dfrom.setHours(0,0,0,0),dto.setHours(23,59,59,0),$.ajax({url:"/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Statistics/Parameter.Counter/"+$$._CurrentParameter+"/"+$$._CurrentModule+"/"+dfrom.getTime()+"/"+dto.getTime(),type:"GET",success:function(data){for(var stats=eval(data),total=0,s=0;s<stats[0].length;s++)total+=stats[0][s][1];$("#page_analyze_cost_counter").html("Counter "+Math.round(100*total)/100);try{var dateFormat=HG.WebApp.Store.get("UI.DateFormat");$.plot($("#statscounter"),[{label:$$._CurrentParameter,data:stats[0]}],{yaxis:{show:!0},xaxis:{mode:"time",timeformat:"MDY12"==dateFormat?"%h:00%p":"%h:00",minTickSize:[1,"hour"],tickSize:[1,"hour"]},legend:{position:"nw",backgroundOpacity:.3},lines:{show:showlines,lineWidth:1.5},series:{splines:{show:showsplines}},bars:{show:showbars,barWidth:18e5,align:"center",steps:!0},grid:{backgroundColor:{colors:["#fff","#ddd"]},hoverable:!0},colors:["rgba(120, 160, 0, 0.5)"],points:{show:!0},zoom:{interactive:!0},pan:{interactive:!0}})}catch(e){console.log(e)}$.mobile.loading("hide")},error:function(e){console.log("STATISTICS ERROR: "+e.status+":"+e.statusText),$.mobile.loading("hide")}})}}},HG.WebApp.GroupsList=HG.WebApp.GroupsList||new function(){var e=this;e.PageId="page_configure_groups",e.InitializePage=function(){var t=$("#"+e.PageId);t.on("pageinit",function(){t.find("[id=configure_group_groupadd]").on("popupbeforeposition",function(){$("#group_new_name").val("")}),t.find("[id=group_new_button]").on("click",function(){e.GroupsAdd($("#group_new_name").val())})}),t.on("pagebeforeshow",function(){e.LoadGroups()}),e.groupList=$("#configure_groupslist")},e.LoadGroups=function(){$.mobile.loading("show"),HG.Configure.Groups.List("Control",function(){e.GetGroupsListViewItems(),$.mobile.loading("hide")})},e.GetGroupsListViewItems=function(){e.groupList.hasClass("ui-sortable")&&(e.groupList.sortable("destroy"),e.groupList.off("sortstop")),e.groupList.empty();var t='<li data-icon="false" data-role="list-divider">'+HG.WebApp.Locales.GetLocaleString("configure_grouplist")+"</li>";for(i=0;i<HG.WebApp.Data.Groups.length;i++){for(var o=HG.WebApp.Data.Groups[i],a=0,r=0;r<o.Modules.length;r++){var n=o.Modules[r];-1!=HG.WebApp.Utility.GetModuleIndexByDomainAddress(n.Domain,n.Address)&&a++}t+='<li data-icon="false" data-group-name="'+o.Name+'" data-group-index="'+i+'">',t+='<a href="#">'+o.Name+"</a>",t+='<span class="ui-li-count">'+a+"</span>",t+='<div style="position:absolute;right:40px;top:0;height:100%;overflow:hidden"><a class="handle ui-btn ui-icon-fa-sort ui-btn-icon-notext ui-list-btn-option-mini"></a></div>',t+="</li>"}e.groupList.append(t),e.groupList.listview().listview("refresh"),e.groupList.sortable({handle:".handle",axis:"y",scrollSpeed:10}).sortable("refresh"),e.groupList.on("sortstop",function(){e.SortGroups()}),e.groupList.find("li").bind("click",function(){e.ConfigureGroup($(this).attr("data-group-index"))})},e.ConfigureGroup=function(t){e.groupList.attr("selected-group-name",HG.WebApp.Data.Groups[t].Name),e.groupList.attr("selected-group-index",t),$.mobile.changePage($("#page_configure_groupmodules"),{transition:"fade",changeHash:!0})},e.GetModuleGroup=function(e){for(var t=null,o=0;o<HG.WebApp.Data.Groups.length;o++){for(var a=HG.WebApp.Data.Groups[o],i=0;i<a.Modules.length;i++)if(e.Domain==a.Modules[i].Domain&&e.Address==a.Modules[i].Address){t=a;break}if(null!=t)break}return t},e.GroupsAdd=function(t){HG.Configure.Groups.AddGroup("Control",t,function(){e.LoadGroups()})},e.SortGroups=function(){var t="",o=0;e.groupList.children("li").each(function(){var e=$(this).attr("data-group-index");e>=0&&(t+=e+";",$(this).attr("data-module-index",o),o++)}),e.groupList.empty(),$.mobile.loading("show"),HG.Configure.Groups.Sort("Control",t,function(){$.mobile.loading("hide"),e.LoadGroups()})},e.SaveGroups=function(t){$.mobile.loading("show"),$.ajax({type:"POST",url:"/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Config/Groups.Save/",data:JSON.stringify(HG.WebApp.Data.Groups),success:function(){e.groupList.empty(),HG.WebApp.GroupModules.LoadGroupModules(),$.mobile.loading("hide"),null!=t&&t()},error:function(){$.mobile.loading("hide")}})}},HG.WebApp.GroupModules=HG.WebApp.GroupModules||new function(){var e=this;e.CurrentGroup="(none)",e.CurrentModule=null,e.CurrentModuleProperty=null,e.EditModule=[],e.SeparatorItemDomain="HomeGenie.UI.Separator",e.InitializePage=function(){var t=e.getContainer();t.on("pageinit",function(){e.field("#module_add_button",!0).on("click",function(){var t=e.field("#automation_group_moduleadd",!0).find(":selected"),o=t.attr("data-context-domain"),a=t.attr("data-context-value");e.AddGroupModule(e.CurrentGroup,o,a,function(){var t=e.field("#page_configure_groupmodules_list",!0).find("ul"),o=t.find("li").last();t.parent().animate({scrollTop:o.position().top})})}),e.field("#group_delete_button",!0).on("click",function(){e.DeleteGroup(e.CurrentGroup)}),e.field("#btn_configure_group_deletegroup",!0).on("click",function(){HG.Ui.SwitchPopup("#listmodules_actionmenu","#automation_group_delete")}),e.field("#btn_configure_group_addmodule",!0).on("click",function(){HG.Ui.SwitchPopup("#listmodules_actionmenu","#automation_group_modulechoose")}),e.field("#btn_configure_group_addseparator",!0).on("click",function(){e.EditModule.Domain="",e.EditModule.Address="",HG.Ui.SwitchPopup("#listmodules_actionmenu","#automation_group_separator_edit")}),e.field("#btn_configure_group_editseparatoradd",!0).on("click",function(){var t=e.field("#automation_group_separatorlabel",!0).val().trim();""!=t&&e.AddGroupModule(e.CurrentGroup,e.SeparatorItemDomain,t,function(){var t=e.field("#page_configure_groupmodules_list",!0).find("ul li").last();e.field("#page_configure_groupmodules_list",!0).find("ul").parent().animate({scrollTop:t.position().top},"slow")})}),e.field("#automation_group_separator_edit",!0).on("popupbeforeposition",function(){""!=e.EditModule.Address?(e.field("#automation_group_separatorlabel",!0).val(e.EditModule.Address),e.field("#automation_group_separatorlabel",!0).addClass("ui-disabled"),e.field("#btn_configure_group_editseparatoradd",!0).hide()):(e.field("#automation_group_separatorlabel",!0).val(""),e.field("#automation_group_separatorlabel",!0).removeClass("ui-disabled"),e.field("#btn_configure_group_editseparatoradd",!0).show())}),e.field("#automation_group_modulechoose",!0).on("popupbeforeposition",function(){var t=$("#automation_group_moduleadd");t.empty(),t.append(e.GetModulesListViewItems(e.CurrentGroup)),t.selectmenu("refresh")}),e.field("#automation_group_module_propdelete",!0).on("click",function(){null!=e.CurrentModuleProperty&&(e.ModulePropertyDelete(e.CurrentModuleProperty.find("input[type=text]").first().val()),e.CurrentModuleProperty.remove(),e.CurrentModuleProperty=null)});var t=e.field("#groupmodules_groupname",!0);t.change(function(){HG.Configure.Groups.RenameGroup("Control",e.CurrentGroup,t.val(),function(){e.CurrentGroup=t.val(),e.field("#configure_groupslist",!0).attr("selected-group-name",t.val()),$.mobile.loading("show"),HG.Configure.Modules.List(function(e){try{HG.WebApp.Data.Modules=e;
}catch(t){}HG.Automation.Programs.List(function(){HG.WebApp.GroupsList.LoadGroups(),$.mobile.loading("hide")})})})}),e.field("#groupmodules_groupwall",!0).on("change",function(){""==$(this).val()?e.field("#configure_group_wallpaper",!0).css("background-image",""):e.field("#configure_group_wallpaper",!0).css("background-image","url(images/wallpapers/"+$(this).val()+")"),HG.Configure.Groups.WallpaperSet(e.CurrentGroup,$(this).val(),function(){})}),e.field("#groupmodules_group_deletebtn",!0).on("click",function(){$.mobile.loading("show"),HG.Configure.Groups.WallpaperDelete(e.field("#groupmodules_groupwall",!0).val(),function(){var t=HG.Configure.Groups.GetGroupByName(e.CurrentGroup);t.Wallpaper="",e.RefreshWallpaper(),$.mobile.loading("hide")})}),e.field("#groupmodules_group_uploadbtn",!0).on("click",function(){e.field("#groupmodules_group_uploadfile",!0).click()}),e.wallpaper=e.field("#configure_group_wallpaper",!0)}),t.on("pagebeforeshow",function(){e.field("#page_configure_groupmodules_list",!0).find("ul").parent().animate({scrollTop:0}),e.LoadGroupModules(),$.mobile.loading("show"),e.RefreshWallpaper()}),e.field("#groupmodules_group_uploadfile",!0).fileupload({url:"/api/HomeAutomation.HomeGenie/Config/Groups.WallpaperAdd",replaceFileInput:!1,dropZone:$("[data-upload-dropzone=wallpaper]"),progressall:function(e,t){var o=parseInt(t.loaded/t.total*100,10);$.mobile.loading("show",{text:"Saving background... "+o+"%",textVisible:!0,theme:"a",html:""})},start:function(){$.mobile.loading("show",{text:"Saving background...",textVisible:!0,theme:"a",html:""})},fail:function(){$.mobile.loading("hide")},done:function(t,o){var a=o.result.ResponseValue;e.field("#configure_group_wallpaper",!0).css("background-image","url(images/wallpapers/"+a+")"),HG.Configure.Groups.WallpaperSet(e.CurrentGroup,a,function(){var t=HG.Configure.Groups.GetGroupByName(e.CurrentGroup);t.Wallpaper=a,"page_control"==$.mobile.activePage.attr("id")?e.field('div[data-ui-field="wallpaper"]',!0).css("background-image","url(images/wallpapers/"+a+")"):e.RefreshWallpaper(),$.mobile.loading("hide")})}})},e.RefreshWallpaper=function(){var t=HG.Configure.Groups.GetGroupByName(e.CurrentGroup);e.wallpaper.css("background-image","url(images/wallpapers/"+t.Wallpaper+")"),e.wallpaper.css("background-size","164px 92px"),e.field("#groupmodules_groupwall",!0).find("option:gt(0)").remove(),HG.Configure.Groups.WallpaperList(function(o){$.each(o,function(o,a){var i=t.Wallpaper==a?" selected":"";e.field("#groupmodules_groupwall",!0).append('<option value="'+a+'"'+i+">"+a+"</option>")}),e.field("#groupmodules_groupwall",!0).selectmenu("refresh"),$.mobile.loading("hide")})},e.SetModuleIcon=function(t){var o=$(t).attr("src");e.field("#module_icon",!0).attr("src",o),HG.WebApp.Utility.SetModulePropertyByName(e.EditModule,"Widget.DisplayIcon",o);var a=HG.WebApp.Utility.GetModulePropertyByName(e.EditModule,"Widget.DisplayIcon");a.NeedsUpdate="true",e.field("#configure_module_iconslist",!0).hide(200)},e.ModuleIconsToggle=function(){"program"!=e.EditModule.DeviceType.toLowerCase()&&("none"!=e.field("#configure_module_iconslist",!0).css("display")?e.field("#configure_module_iconslist",!0).hide(200):e.field("#configure_module_iconslist",!0).show(200))},e.SortModules=function(){var t="";e.field("#page_configure_groupmodules_list",!0).find("ul").children("li").each(function(){var e=$(this).attr("data-module-index");e>=0&&(t+=e+";")}),$.mobile.loading("show"),HG.Configure.Groups.SortModules("Control",e.CurrentGroup,t,function(){HG.Configure.Groups.List("Control",function(){e.LoadGroupModules(),$.mobile.loading("hide")})})},e.ModulePropertyDelete=function(t){for(var o=e.CurrentModule,a=0;a<o.Properties.length;a++)o.Properties[a].Name==t&&(delete o.Properties[a],o.Properties.splice(a,1))},e.ModulePropertyAdd=function(e,t,o){for(var a=!1,i=0;i<e.Properties.length;i++)if(e.Properties[i].Name==t){e.Properties[i].Value=o,e.Properties[i].NeedsUpdate="true",a=!0;break}return a||e.Properties.push({Name:t,Value:o,NeedsUpdate:"true"}),a},e.UpdateModule=function(e,t){$.mobile.loading("show",{text:"Saving module settings",textVisible:!0,theme:"a",html:""}),$.ajax({type:"POST",url:"/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Config/Modules.Update/",data:JSON.stringify(e,function(e,t){return"WidgetInstance"==e?void 0:t}),success:function(){$.mobile.loading("hide"),null!=t&&t()},error:function(){$.mobile.loading("hide"),null!=t&&t()}})},e.UpdateCurrentModuleParameter=function(){e.ModulePropertyAdd(e.CurrentModule,e.CurrentModuleProperty.find("input[type=text]").first().val(),e.CurrentModuleProperty.find("input[type=text]").last().val())},e.LoadModuleParameters=function(){var t=e.field("#automation_group_module_params",!0);t.empty();var o=e.CurrentModule;if(null!=o.Properties)for(var a=0;a<o.Properties.length;a++){var i="<li>";i+='        <div class="ui-grid-a">',i+='            <div class="ui-block-a" style="padding-right:7.5px;width:70%;"><input type="text" value="'+o.Properties[a].Name+'" onchange="HG.WebApp.GroupModules.UpdateCurrentModuleParameter()" style="font-size:11pt" -class="ui-disabled" /></div>',i+='            <div class="ui-block-b" style="padding-left:7.5px;width:30%;"><input type="text" value="'+o.Properties[a].Value+'" onchange="HG.WebApp.GroupModules.UpdateCurrentModuleParameter()" style="font-size:11pt" -class="ui-disabled" /></div>',i+="        </div>",i+="   </li>",e.field("#automation_group_module_params",!0).append(i)}t.trigger("create"),t.listview().listview("refresh"),t.find("input").focus(function(){var t=$(this).closest("div").parent().parent().parent();"#E6E6FA"!=t.css("background")&&($(this).attr("originalbackground",t.css("background")),t.css("background","#E6E6FA"),setTimeout("$('#automation_group_module_propdelete').removeClass('ui-disabled')",500),e.CurrentModuleProperty=t)}),e.field("#automation_group_module_params input",!0).blur(function(){$(this).closest("div").parent().parent().parent().css("background",$(this).attr("originalbackground")),setTimeout("$('#automation_group_module_propdelete').addClass('ui-disabled')",250)})},e.GetModulesListViewItems=function(e){var t=HG.Configure.Groups.GetGroupModules(e),o="",a="";if(HG.WebApp.Data.Modules&&HG.WebApp.Data.Modules.length)for(m=0;m<HG.WebApp.Data.Modules.length;m++){var i=HG.WebApp.Data.Modules[m],r=$.grep(t.Modules,function(e){return e.Domain==i.Domain&&e.Address==i.Address});if(0==r.length){var n=HG.WebApp.Utility.GetModulePropertyByName(i,"Widget.DisplayModule"),s=HG.WebApp.Utility.GetModulePropertyByName(i,"VirtualModule.ParentId"),l=null!=n&&null!=n.Value?n.Value:"",d=null!=s&&null!=s.Value?s.Value:"";if("HomeAutomation.HomeGenie.Automation"==i.Domain){var p=""!=d&&d!=i.Address?d:i.Address,u=HG.WebApp.Utility.GetProgramByAddress(p);if(null!=u){if(!u.IsEnabled)continue;if("wizard"!=u.Type.toLowerCase()&&""==l)continue}}a!=i.Domain&&(a=i.Domain,o+='<optgroup label="'+a+'"></optgroup>');var c=""!=i.Name?i.Name:""!=i.Description?i.Description:i.DeviceType;c+=" ("+i.Address+")",o+='<option data-context-domain="'+i.Domain+'" data-context-value="'+i.Address+'">'+c+"</option>"}}return o},e.AddGroupModule=function(e,t,o,a){var r=!1,n=-1;for(i=0;i<HG.WebApp.Data.Groups.length;i++)if(HG.WebApp.Data.Groups[i].Name==e){for(c=0;c<HG.WebApp.Data.Groups[i].Modules.length;c++)if(t==HG.WebApp.Data.Groups[i].Modules[c].Domain&&o==HG.WebApp.Data.Groups[i].Modules[c].Address){r=!0;break}r||(HG.WebApp.Data.Groups[i].Modules.push({Address:o,Domain:t}),n=HG.WebApp.Data.Groups[i].length-1);break}HG.WebApp.GroupsList.SaveGroups(function(){a()})},e.UpdateWMWatts=function(t,o){e.EditModule.WMWatts=o},e.UpdateModuleType=function(t){var o=t.toLowerCase();if(e.field("#module_options_1",!0).css("display",""),e.field("#module_options_2",!0).css("display",""),e.field("#module_options_3",!0).css("display",""),e.field("#module_update_button",!0).removeClass("ui-disabled"),"light"==o||"dimmer"==o||"switch"==o?(e.field("#module_vmwatts",!0).val("0"),e.field("#module_vmwatts_label",!0).removeClass("ui-disabled"),e.field("#module_vmwatts",!0).removeClass("ui-disabled")):"program"==o?(e.field("#module_options_1",!0).css("display","none"),e.field("#module_options_2",!0).css("display","none"),e.field("#module_options_3",!0).css("display","none"),e.field("#module_update_button",!0).addClass("ui-disabled")):o&&void 0!=o&&"generic"!=o&&""!=o&&(e.field("#module_vmwatts",!0).val(""),e.field("#module_vmwatts_label",!0).addClass("ui-disabled"),e.field("#module_vmwatts",!0).addClass("ui-disabled")),e.EditModule.DeviceType!=t){e.EditModule.DeviceType=t,HG.WebApp.Utility.SetModulePropertyByName(e.EditModule,"Widget.DisplayIcon","");var a=HG.WebApp.Utility.GetModulePropertyByName(e.EditModule,"Widget.DisplayIcon");a.NeedsUpdate="true",HG.Ui.GetModuleIcon(e.EditModule,function(t){e.field("#module_icon",!0).attr("src",t)})}e.UpdateFeatures()},e.DeleteGroupModule=function(e,t){for(i=0;i<HG.WebApp.Data.Groups.length;i++)if(HG.WebApp.Data.Groups[i].Name==e){HG.WebApp.Data.Groups[i].Modules=$.grep(HG.WebApp.Data.Groups[i].Modules,function(e){return e.Domain!=t.Domain||e.Address!=t.Address});break}},e.DeleteGroup=function(t){$.mobile.loading("show"),HG.Configure.Groups.DeleteGroup("Control",t,function(){$.mobile.loading("hide"),setTimeout(function(){$.mobile.changePage(e.field("#page_configure_groups",!0),{transition:"fade",changeHash:!0})},200)}),e.field("#control_groupslist",!0).empty(),HG.WebApp.Data._CurrentGroupIndex=0},e.LoadGroupModules=function(){e.CurrentGroup=e.field("#configure_groupslist",!0).attr("selected-group-name");var t=HG.Configure.Groups.GetGroupModules(e.CurrentGroup);e.field("#groupmodules_groupname",!0).val(t.Name),e.field("#page_configure_groupmodules_list",!0).find("ul").hasClass("ui-sortable")&&(e.field("#page_configure_groupmodules_list",!0).find("ul").sortable("destroy"),e.field("#page_configure_groupmodules_list",!0).find("ul").off("sortstop")),e.field("#page_configure_groupmodules_list",!0).find("ul").empty();for(var o="",a=0;a<t.Modules.length;a++){var i=t.Modules[a].Domain.substring(t.Modules[a].Domain.lastIndexOf(".")+1);if(t.Modules[a].Domain==e.SeparatorItemDomain)o+='<li class="ui-header" data-icon="false" data-module-index="'+a+'">',o+='<a style="height:25px;line-height:24px;font-size:12pt;font-weight:bold">&nbsp;'+t.Modules[a].Address+"</a>",o+='<div class="ui-grid-a" style="position:absolute;right:0;top:1px;">',o+='<div class="ui-block-a"><a class="handle ui-btn ui-icon-fa-sort ui-btn-icon-notext ui-list-btn-option-mini">'+HG.WebApp.Locales.GetLocaleString("configure_module_parameters_linktitle")+"</a></div>",o+='<div class="ui-block-b"><a data-ui-field="btn_delete" class="ui-btn ui-icon-delete ui-btn-icon-notext ui-list-btn-option-mini">'+HG.WebApp.Locales.GetLocaleString("configure_module_parameters_linktitle")+"</a></div>",o+="</div>",o+="</li>";else{var r="module_icon_image_"+a,n="pages/control/widgets/homegenie/generic/images/unknown.png";o+='<li data-icon="false" data-module-index="'+a+'">',o+="<a>",o+='<table><tr><td rowspan="2" align="left"><img id="'+r+'" height="54" src="'+n+'"></td>',o+='<td style="padding-left:10px"><span>'+t.Modules[a].Name+"</span></td></tr>",o+='<tr><td style="padding-left:10px"><span style="color:gray">'+i+"</span> "+t.Modules[a].Address+"</td>",o+="</tr></table>",o+="</a>",o+='<div class="ui-grid-c" style="position:absolute;right:0;top:0;height:100%;">',o+='<div class="ui-block-a"><a data-ui-field="btn_settings" title="Settings" data-rel="popup" data-transition="pop" class="ui-btn ui-icon-gear ui-btn-icon-notext ui-list-btn-option"></a></div>',o+='<div class="ui-block-b"><a data-ui-field="btn_parameters" title="Parameters" data-rel="popup" data-transition="pop" class="ui-btn ui-icon-bars ui-btn-icon-notext ui-list-btn-option">'+HG.WebApp.Locales.GetLocaleString("configure_module_parameters_linktitle")+"</a></div>",o+='<div class="ui-block-c"><a title="Drag to sort" class="handle ui-btn ui-icon-fa-sort ui-btn-icon-notext ui-list-btn-option"></a></div>',o+='<div class="ui-block-d"><a data-ui-field="btn_delete" title="Remove from this group" class="ui-btn ui-icon-delete ui-btn-icon-notext ui-list-btn-option"></a></div>',o+="</div>",o+="</li>"}}e.field("#page_configure_groupmodules_list",!0).find("ul").append(o),e.field("#page_configure_groupmodules_list",!0).find("ul").listview().listview("refresh"),e.field("#page_configure_groupmodules_list",!0).find("ul").sortable({handle:".handle",axis:"y",scrollSpeed:10}),e.field("#page_configure_groupmodules_list",!0).find("ul").on("sortstop",function(){e.SortModules()});for(var a=0;a<t.Modules.length;a++){var r="module_icon_image_"+a;HG.Ui.GetModuleIcon(t.Modules[a],function(e,t){$("#"+t).attr("src",e)},r)}e.field("#page_configure_groupmodules_list",!0).find("ul li").each(function(){var t=$(this);t.find("[data-ui-field=btn_settings]").on("click",function(){HG.WebApp.SetCurrentModule(t),e.EditCurrentModule(t)}),t.find("[data-ui-field=btn_parameters]").on("click",function(){HG.WebApp.SetCurrentModule(t),$("#page_configure_groupmodules_propspopup").popup("open",{transition:"pop",positionTo:"window"})}),t.find("[data-ui-field=btn_delete]").on("click",function(){HG.WebApp.SetCurrentModule(t),e.DeleteGroupModule(e.CurrentGroup,e.CurrentModule),HG.WebApp.GroupsList.SaveGroups(null)})}),e.field("#configure_groupslist",!0).listview().listview("refresh")},HG.WebApp.SetCurrentModule=function(t){var o=t.attr("data-module-index");if(o){var a=HG.Configure.Groups.GetGroupModules(e.CurrentGroup);e.CurrentModule=HG.WebApp.Utility.GetModuleByDomainAddress(a.Modules[o].Domain,a.Modules[o].Address),null==e.CurrentModule&&(e.CurrentModule=a.Modules[o],e.CurrentModule.DeviceType="")}},e.EditCurrentModule=function(t){HG.WebApp.SetCurrentModule(t),e.CurrentModule.Domain==e.SeparatorItemDomain?(e.EditModule.Address=e.CurrentModule.Address,e.EditModule.Domain=e.CurrentModule.Domain,e.field("#automation_group_separator_edit",!0).popup("open",{transition:"pop",positionTo:"window"})):e.ModuleEdit(function(){e.field("#control_groupslist",!0).empty(),e.LoadGroupModules()})},e.ModuleEdit=function(t){if(e.ModuleUpdatedCallback=t,e.EditModule.Domain=e.CurrentModule.Domain,e.EditModule.Address=e.CurrentModule.Address,e.EditModule.Name=e.CurrentModule.Name,e.EditModule.Type=e.CurrentModule.Type,e.EditModule.DeviceType=e.CurrentModule.DeviceType,e.EditModule.WMWatts=0,null!=HG.WebApp.Utility.GetModulePropertyByName(e.CurrentModule,"VirtualMeter.Watts")&&(e.EditModule.WMWatts=HG.WebApp.Utility.GetModulePropertyByName(e.CurrentModule,"VirtualMeter.Watts").Value),e.field("#module_options_button",!0).removeClass("ui-disabled"),"HomeAutomation.ZWave"!=e.CurrentModule.Domain)e.field("#module_options_button",!0).addClass("ui-disabled");else if(null!=HG.WebApp.Utility.GetModulePropertyByName(e.CurrentModule,"VirtualModule.ParentId")){var o=HG.WebApp.Utility.GetModulePropertyByName(e.CurrentModule,"VirtualModule.ParentId").Value;o!=e.CurrentModule.Address&&e.field("#module_options_button",!0).addClass("ui-disabled")}e.UpdateModuleType(e.CurrentModule.DeviceType),e.field("#module_title",!0).html(e.EditModule.Domain.split(".")[1]+" "+e.EditModule.Address+" - Settings"),e.field("#module_name",!0).val(e.EditModule.Name),e.field("#module_type",!0).val(e.EditModule.DeviceType).attr("selected",!0).siblings("option").removeAttr("selected"),e.field("#module_type",!0).selectmenu("refresh",!0),e.field("#configure_module_iconslist",!0).hide(),HG.Ui.GetModuleIcon(e.CurrentModule,function(t){e.field("#module_icon",!0).attr("src",t)}),e.field("#module_vmwatts",!0).val(e.EditModule.WMWatts>0?e.EditModule.WMWatts:"0"),e.UpdateFeatures(),e.field("#automation_group_module_edit",!0).popup("open",{transition:"pop",positionTo:"window"})},e.ShowFeatures=function(t){e.field("#module_programs_features",!0).empty();var o=HG.WebApp.Locales.GetProgramLocaleString(HG.WebApp.Data.Programs[t].Address,"Description",HG.WebApp.Data.Programs[t].Description);e.field("#module_programs_featuredesc",!0).html(o);for(var a=null,i=0;i<e.EditModule.Properties.length;i++){var r=e.EditModule.Properties[i];if(r.ProgramIndex==t){r.Index=i;var n={parent:e.field("#module_programs_features",!0),program:HG.WebApp.Data.Programs[t],module:e.EditModule,parameter:r};HG.Ui.GenerateWidget("widgets/"+r.FieldType,n,function(t){t.onChange=function(o){e.FeatureUpdate(t.context,o)},e.field("#automation_group_module_edit",!0).popup("reposition",{positionTo:"window"}),null!=a&&clearTimeout(a),a=setTimeout(function(){e.field("#automation_group_module_edit",!0).popup("reposition",{positionTo:"window"})},300)})}}},e.MatchValues=function(e,t){var o=[e];e.indexOf(",")>0?o=e.split(","):e.indexOf("|")>0&&(o=e.split("|"));var a=[];$.each(o,function(e,t){return 0==t.trim().indexOf("!")?(o.splice(e,1),a.push(t.trim().substring(1))):""==t.trim()&&o.splice(e,1),!0});var i=0==o.length;return $.each(o,function(e,o){return o.trim()==t.trim()?(i=!0,!1):!0}),$.each(a,function(e,o){return o.trim()==t.trim()?(i=!1,!1):!0}),i},e.UpdateFeatures=function(){e.EditModule.Properties=Array(),e.field("#module_options_features",!0).hide(),e.field("#module_programs_featureset",!0).empty(),e.field("#module_programs_features",!0).empty();for(var t="",o=-1,a=0;a<HG.WebApp.Data.Programs.length;a++){var i=-1;if(HG.WebApp.Data.Programs[a].IsEnabled){var r=HG.WebApp.Data.Programs[a].Features;if(r.length>0)for(var n=0;n<r.length;n++){var s=e.MatchValues(r[n].ForDomains.toLowerCase(),e.EditModule.Domain.toLowerCase());if(s=s&&e.MatchValues(r[n].ForTypes.toLowerCase(),e.EditModule.DeviceType.toLowerCase())){var l=r[n].Property,d=HG.WebApp.Utility.GetModulePropertyByName(e.CurrentModule,l);HG.WebApp.Utility.SetModulePropertyByName(e.EditModule,l,null!=d?d.Value:""),d=HG.WebApp.Utility.GetModulePropertyByName(e.EditModule,l),d.ProgramIndex=a,d.FieldType=r[n].FieldType,d.Description=r[n].Description;var p=HG.WebApp.Utility.GetModulePropertyByName(e.CurrentModule,l+".Data");if(null!=p&&HG.WebApp.Utility.SetModulePropertyByName(e.EditModule,p.Name,p.Value),0>i){var u=HG.WebApp.Data.Programs[a].Address,c=HG.WebApp.Data.Programs[a].Name;""==c&&(c=u),c=HG.WebApp.Locales.GetProgramLocaleString(u,"Title",c),t+='<option value="'+a+'">'+c+"</option>",i=a,0>o&&(o=a)}}}}}""!=t&&(e.field("#module_programs_featureset",!0).append(t),e.field("#module_programs_featureset",!0).selectmenu("refresh",!0),e.field("#module_options_features",!0).show(),-1!=o&&e.ShowFeatures(o)),e.field("#automation_group_module_edit",!0).popup("reposition",{positionTo:"window"})},e.FeatureUpdate=function(e,t){var o=(e.program,e.module),a=e.parameter.Name;HG.WebApp.Utility.GetModulePropertyByName(o,a);HG.WebApp.Utility.SetModulePropertyByName(o,a,t)},e.ShowModuleOptions=function(t,o){var a=HG.WebApp.Utility.GetModuleByDomainAddress(t,o);if(null!=a)switch(a.Domain){case"HomeAutomation.ZWave":HG.Ext.ZWave.NodeSetup.Show(a),$.mobile.changePage(e.field("#configurepage_OptionZWave",!0),{transition:"fade",changeHash:!0});break;default:alert("No options page available for this module.")}}},HG.Ui.CreatePage(HG.WebApp.GroupModules,"page_configure_groupmodules"),HG.WebApp.SystemSettings=HG.WebApp.SystemSettings||new function(){var e=this;e.PageId="page_configure_interfaces",e.Interfaces=e.Interfaces||{},e.InitializePage=function(){var t=$("#"+e.PageId),o=t.find("[data-ui-field=import-popup]"),a=t.find("[data-ui-field=interface_install]"),i=t.find("[data-ui-field=import-form]"),r=t.find("[data-ui-field=download-btn]"),n=t.find("[data-ui-field=download-url]"),s=t.find("[data-ui-field=upload-btn]"),l=t.find("[data-ui-field=upload-file]"),d=t.find("[data-ui-field=upload-frame]");t.on("pageinit",function(){o.popup()}),t.on("pagebeforeshow",function(){HG.Automation.Programs.List(function(){HG.Configure.Groups.List("Automation",function(){e.ListInterfaces()})})}),t.on("pageshow",function(){t.find("[data-locale-id=configure_program_bbaractions]").qtip({content:{text:HG.WebApp.Locales.GetLocaleString("configure_system_installtip_description","Go to the Package Manager to install additional features.")},show:{event:!1,ready:!0,delay:1e3},events:{hide:function(){$(this).qtip("destroy")}},hide:{event:!1,inactive:3e3},style:{classes:"qtip-red qtip-shadow qtip-rounded qtip-bootstrap"},position:{my:"bottom center",at:"top center"}})}),o.on("popupafteropen",function(){a.removeClass("ui-btn-active")}),a.on("click",function(){setTimeout(function(){o.popup("open")},500)}),r.on("click",function(){""==n.val()?(alert("Insert add-on package URL"),n.parent().stop().animate({borderColor:"#FF5050"},250).animate({borderColor:"#FFFFFF"},250).animate({borderColor:"#FF5050"},250).animate({borderColor:"#FFFFFF"},250)):(o.popup("close"),setTimeout(function(){$.mobile.loading("show",{text:"Downloading, please wait...",textVisible:!0,html:""}),$.get("/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Config/Interface.Import/"+encodeURIComponent(n.val()),function(){$.mobile.loading("hide"),n.val("");var t=$.parseJSON(arguments[2].responseText);e.AddonInstall(t.ResponseValue)})},1e3))}),s.on("click",function(){""==l.val()?(alert("Select a file to import first"),l.parent().stop().animate({borderColor:"#FF5050"},250).animate({borderColor:"#FFFFFF"},250).animate({borderColor:"#FF5050"},250).animate({borderColor:"#FFFFFF"},250)):(o.popup("close"),$.mobile.loading("show",{text:"Uploading, please wait...",textVisible:!0,html:""}),i.submit())}),d.bind("load",function(){$.mobile.loading("hide"),l.val("");var t=d[0].contentWindow.document.body;if("undefined"!=typeof t&&""!=t&&(t.textContent||t.innerText))try{t=$.parseJSON(t.textContent||t.innerText),e.AddonInstall(t.ResponseValue)}catch(o){}})},e.AddonInstall=function(t){var o=/(https?:\/\/[^\s]+)/g;t=t.replace(o,'<a href="$1" target="_blank">$1</a>'),HG.WebApp.Utility.ConfirmPopup(HG.WebApp.Locales.GetLocaleString("systemsettings_addonsinstall_title","Install add-on?"),"<pre>"+t+"</pre>",function(t){t&&($.mobile.loading("show",{text:"Installing, please wait...",textVisible:!0,html:""}),$.get("/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Config/Interface.Install",function(){e.ListInterfaces(),$.mobile.loading("hide")}))})},e.ListInterfaces=function(){var t=$("#"+e.PageId),o=t.find("[data-ui-field=interface_list]");HG.Configure.Interfaces.ListConfig(function(t){o.empty(),o.append("<h3>Interfaces (MIG)</h3>"),$.each(t,function(t,a){var i=a.Domain,r=i.substring(i.lastIndexOf(".")+1),n=$('<div data-role="collapsible" data-inset="true" class="ui-mini" />'),s=$('<h3><span data-ui-field="title">'+r+'</span><img src="images/interfaces/'+r.toLowerCase()+'.png" style="position:absolute;right:8px;top:6px"></h3>');n.append(s);var l=$("<p />");n.append(l),l.load("pages/configure/interfaces/configlet/"+r.toLowerCase()+".html",function(){var t=r;e.Interfaces[i].Localize&&(e.Interfaces[i].Localize(),t=HG.WebApp.Locales.GetLocaleString("title",r,e.Interfaces[i].Locale)),s.find("[data-ui-field=title]").html(t),s.attr("description",a.Description),null!=a.Description&&""!=a.Description.trim()&&s.qtip({content:{text:a.Description},show:{event:"mouseover",ready:!1,delay:500},hide:{event:"mouseout"},style:{classes:"qtip-red qtip-shadow qtip-rounded qtip-bootstrap"},position:{my:"bottom center",at:"top center"}}),l.trigger("create"),e.Interfaces[i].Initialize()}),o.append(n)}),o.append("<h3>Automation Program Plugins</h3>"),$.each(HG.WebApp.Data.AutomationGroups,function(e,t){var a=!0;$.each(HG.WebApp.Data.Programs,function(e,i){if(i.IsEnabled&&i.Group==t.Name){var r=HG.WebApp.Utility.GetModuleByDomainAddress("HomeAutomation.HomeGenie.Automation",i.Address);if(null!=r){for(var n=!1,s=0;s<r.Properties.length;s++)if("ConfigureOptions."==r.Properties[s].Name.substring(0,17)){n=!0;break}if(n){a&&(o.append("<h4>"+t.Name+"</h4>"),a=!1);var l=HG.WebApp.Locales.GetProgramLocaleString(i.Address,"Title",i.Name),d="undefined"!=i.Description&&null!=i.Description?i.Description:"";d=HG.WebApp.Locales.GetProgramLocaleString(i.Address,"Description",d).replace(/\n/g,"<br />");var p=$('<div data-role="collapsible" data-inset="true" class="ui-mini" />'),u=$('<h3><span data-ui-field="title">'+l+"</span></h3>");p.append(u);var c='<div><div class="ui-grid-a" style="padding-top:10px;padding-bottom:10px">';c+='<div class="ui-block-a" style="width:75%">'+d+"</div>",c+='<div class="ui-block-b" style="width:25%" align="right"><a data-ui-field="options_button" href="#" class="ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left ui-icon-gear">'+HG.WebApp.Locales.GetLocaleString("configure_program_options","Options")+"</a></div>",c+="</div></div>",p.append(c),p.find('[data-ui-field="options_button"]').on("click",function(){HG.WebApp.ProgramEdit._CurrentProgram.Domain=r.Domain,HG.WebApp.ProgramEdit._CurrentProgram.Address=r.Address,HG.WebApp.ProgramsList.UpdateOptionsPopup()}),o.append(p)}}}})}),o.trigger("create")})},e.GetInterface=function(e){var t=null,o=HG.WebApp.Data.Interfaces;if(o&&"undefined"!=o)for(i=0;i<o.length;i++)if(o[i].Domain==e){t=o[i];break}return t},e.ShowPortTip=function(e){$(e).qtip({content:{title:HG.WebApp.Locales.GetLocaleString("systemsettings_selectport_title"),text:HG.WebApp.Locales.GetLocaleString("systemsettings_selectport_text"),button:HG.WebApp.Locales.GetLocaleString("systemsettings_selectport_button")},show:{event:!1,ready:!0,delay:1e3},events:{hide:function(){$(this).qtip("destroy")}},hide:{event:!1,inactive:3e3},style:{classes:"qtip-red qtip-shadow qtip-rounded qtip-bootstrap"},position:{my:"left center",at:"right center"}})}},HG.WebApp.Maintenance=HG.WebApp.Maintenance||new function(){var e=this;e.PageId="page_configure_maintenance",e.RestoreProgramList="",e.InitializePage=function(){var t=$("#"+e.PageId);t.on("pagebeforeshow",function(){$("#restore_configuration_uploadfile").val("")}),t.on("pageshow",function(){t.find("[data-ui-field=package_install]").qtip({content:{text:HG.WebApp.Locales.GetLocaleString("configure_system_installpackage_description","Click here to install additional features.")},show:{event:!1,ready:!0,delay:1e3},events:{hide:function(){$(this).qtip("destroy")}},hide:{event:!1,inactive:3e3},style:{classes:"qtip-red qtip-shadow qtip-rounded qtip-bootstrap"},position:{my:"right center",at:"left center"}})}),t.on("pageinit",function(){$("#systemsettings_httpport_change").bind("click",function(){var e=$("#http_service_port").val();$.mobile.loading("show"),HG.System.SetHttpPort(e,function(){$("#systemsettings_httpport_text").html(e),$.mobile.loading("hide")})}),$("#systemsettings_httphostheader_change").bind("click",function(){var e=$("#http_host_header").val();$.mobile.loading("show"),HG.System.SetHostHeader(e,function(){$("#systemsettings_hostheader_text").html(e),$.mobile.loading("hide")})}),$("#configure_system_flip_httpcache").on("slidestop",function(){$.mobile.loading("show"),"1"==$("#configure_system_flip_httpcache").val()?HG.System.WebCacheEnable(function(){$.mobile.loading("hide")}):HG.System.WebCacheDisable(function(){$.mobile.loading("hide")})}),$("#configure_system_flip_logging").on("slidestop",function(){$.mobile.loading("show"),"1"==$("#configure_system_flip_logging").val()?HG.System.LoggingEnable(function(){$.mobile.loading("hide")}):HG.System.LoggingDisable(function(){$.mobile.loading("hide")})}),$("#configure_system_flip_eventshistory").on("slidestop",function(){"1"==$("#configure_system_flip_eventshistory").val()?(HG.WebApp.Store.set("UI.EventsHistory",!0),$("#btn_eventshistory_led").show()):(HG.WebApp.Store.set("UI.EventsHistory",!1),$("#btn_eventshistory_led").hide())}),$("input[name='tempunit-choice']").on("change",function(){HG.WebApp.Store.set("UI.TemperatureUnit",$(this).val())}),$("input[name='dateformat-choice']").on("change",function(){HG.WebApp.Store.set("UI.DateFormat",$(this).val())}),$("#configure_system_updatemanager_updatebutton").bind("click",function(){$("#configure_system_updatemanager_info").html("<strong>Checking for updates...</strong>"),$.mobile.loading("show"),HG.System.UpdateManager.UpdateCheck(function(){$.mobile.loading("hide"),e.LoadUpdateCheckSettings()})}),$("#configure_system_updatemanager_manualbutton").on("click",function(){""==$("#updatemanager_updatefile_uploadfile").val()?(alert("Select a .tgz release file to install first"),$("#updatemanager_updatefile_uploadfile").parent().stop().animate({borderColor:"#FF5050"},250).animate({borderColor:"#FFFFFF"},250).animate({borderColor:"#FF5050"},250).animate({borderColor:"#FFFFFF"},250)):($.mobile.loading("show"),$("#configure_system_updatemanager_manualbutton").addClass("ui-disabled"),$.mobile.loading("show",{text:"Processing release file, please wait...",textVisible:!0,theme:"a",html:""}),$("#configure_system_updateinstall_log").html(),$("#systemsettings_updateinstall_popup").popup("open"),$("#updatemanager_updatefile_form").submit())}),$("#updatemanager_updatefile_uploadframe").bind("load",function(){""!=$("#updatemanager_updatefile_uploadfile").val()&&($("#configure_system_updatemanager_manualbutton").removeClass("ui-disabled"),$.mobile.loading("hide"),$("#systemsettings_updateinstall_popup").popup("close"))}),$("#configure_system_updateinstall_button").bind("click",function(){$("#configure_system_updateinstall_button").addClass("ui-disabled"),$("#configure_system_updatemanager_info").html("<strong>Installing updates...</strong>"),$("#configure_system_updateinstall_status").html("Installing files..."),$.mobile.loading("show",{text:"Please wait...",textVisible:!0,html:""}),HG.System.UpdateManager.InstallUpdate(function(t){"OK"==t.ResponseValue?($("#configure_system_updateinstall_status").html("Update install complete."),setTimeout(function(){window.location.replace("/")},3e3)):"RESTART"==t.ResponseValue?$("#configure_system_updateinstall_status").html("Installing files... (HomeGenie service stopped)"):"ERROR"==t.ResponseValue&&($("#configure_system_updateinstall_status").html("Error during installation progress."),$.mobile.loading("hide"),e.LoadUpdateCheckSettings())})}),$("#configure_system_updatemanager_proceedbutton").bind("click",function(){$("#configure_system_updateinstall_button").addClass("ui-disabled"),$("#configure_system_updatemanager_info").html("<strong>Downloading files...</strong>"),$("#configure_system_updateinstall_log").empty(),HG.Ui.SwitchPopup("#systemsettings_updatewarning_popup","#systemsettings_updateinstall_popup",!0),$("#configure_system_updateinstall_status").html("Downloading files..."),$.mobile.loading("show",{text:"Please wait...",textVisible:!0,html:""}),HG.System.UpdateManager.DownloadUpdate(function(t){$.mobile.loading("hide"),e.LoadUpdateCheckSettings(),"OK"==t.ResponseValue?($("#configure_system_updateinstall_status").html("Update files ready."),$("#configure_system_updateinstall_button").removeClass("ui-disabled")):"RESTART"==t.ResponseValue?($("#configure_system_updateinstall_status").html("Update files ready. HomeGenie will be restarted after updating."),$("#configure_system_updateinstall_button").removeClass("ui-disabled")):"ERROR"==t.ResponseValue&&($("#configure_system_updateinstall_status").html("Error while downloading update files."),$("#configure_system_updateinstall_button").addClass("ui-disabled"))})}),$("#securitysettings_password_change").bind("click",function(){var t=$("#securitysettings_user_password").val();$.mobile.loading("show"),HG.System.SetPassword(t,function(){$.mobile.loading("hide"),setTimeout(function(){e.LoadHttpSettings()},1e3)})}),$("#securitysettings_password_clear").bind("click",function(){$.mobile.loading("show"),HG.System.ClearPassword(function(){$.mobile.loading("hide"),e.LoadHttpSettings()})}),$("#btn_configuresystem_downloadtday").bind("click",function(){window.open("/api/HomeAutomation.HomeGenie/Config/System.Configure/SystemLogging.DownloadCsv/0")}),$("#btn_configuresystem_downloadyday").bind("click",function(){window.open("/api/HomeAutomation.HomeGenie/Config/System.Configure/SystemLogging.DownloadCsv/1")}),$("#maintenance_configuration_restartproceedbutton").bind("click",function(){$("#maintenance_configuration_restartbutton").addClass("ui-disabled"),
$.mobile.loading("show",{text:"Restarting service, please wait...",textVisible:!0,theme:"a",html:""}),HG.Configure.System.ServiceCall("Service.Restart",function(){})}),$("#maintenance_configuration_backupbutton").bind("click",function(){}),$("#maintenance_configuration_restorebutton").bind("click",function(){""==$("#restore_configuration_uploadfile").val()?(alert("Select a file to restore first"),$("#restore_configuration_uploadfile").parent().stop().animate({borderColor:"#FF5050"},250).animate({borderColor:"#FFFFFF"},250).animate({borderColor:"#FF5050"},250).animate({borderColor:"#FFFFFF"},250)):($("#systemsettings_backuprestores1cancelbutton").removeClass("ui-disabled"),$("#systemsettings_backuprestores1confirmbutton").removeClass("ui-disabled"),$.mobile.loading("show",{text:"Restoring backup, please wait...",textVisible:!0,theme:"a",html:""}),$("#restore_configuration_form").submit())}),$("#maintenance_configuration_factoryresetbutton").bind("click",function(){$.mobile.loading("show",{text:"Resetting to factory defaults, please wait...",textVisible:!0,theme:"a",html:""}),HG.Configure.System.ServiceCall("System.ConfigurationReset",function(){setTimeout(function(){$.mobile.loading("hide"),window.location.replace("/")},3e3)})}),$("#systemsettings_backuprestores1selectallbtn").bind("click",function(){""!=e.RestoreProgramList?(e.RestoreProgramList="",$("#systemsettings_backuprestores1plist div").attr("data-checked","false").find("i").addClass("fa-square-o").removeClass("fa-check-square")):(e.RestoreProgramList="",$("#systemsettings_backuprestores1plist div").each(function(){$(this).attr("data-checked","true").find("i").removeClass("fa-square-o").addClass("fa-check-square"),e.RestoreProgramList+=","+$(this).attr("data-program")+","}))}),$("#maintenance_configuration_backupbutton").bind("click",function(){window.open(location.protocol+"../../api/HomeAutomation.HomeGenie/Config/System.Configure/System.ConfigurationBackup")}),$("#restore_configuration_uploadframe").bind("load",function(){""!=$("#restore_configuration_uploadfile").val()&&(HG.Configure.System.ServiceCall("System.ConfigurationRestoreS1",function(t){$.mobile.loading("hide"),$("#systemsettings_backuprestores1plist").empty();var o=t;if(0==o.length)$("#systemsettings_backuprestores1plist").append("<p>No user's program found in this backup.</p>"),$("#systemsettings_backuprestores1selectallbtn").addClass("ui-disabled");else{for(var a=0;a<o.length;a++){var i=$('<div data-checked="false" data-program="'+o[a].Address+'" style="padding:4px;cursor:pointer"><i class="fa fa-square-o fa-lg" style="width:20px"></i> <span style="font-size:12pt">'+o[a].Address+" "+o[a].Name+"</label></span>");i.on("click",function(){"true"==$(this).attr("data-checked")?($(this).find("i").addClass("fa-square-o"),$(this).find("i").removeClass("fa-check-square"),$(this).attr("data-checked","false"),e.RestoreProgramList=e.RestoreProgramList.replace(","+$(this).attr("data-program")+",","")):($(this).find("i").removeClass("fa-square-o"),$(this).find("i").addClass("fa-check-square"),$(this).attr("data-checked","true"),e.RestoreProgramList+=","+$(this).attr("data-program")+",")}),$("#systemsettings_backuprestores1plist").append(i)}$("#systemsettings_backuprestores1selectallbtn").removeClass("ui-disabled")}$("#systemsettings_backuprestores1plist").scrollTop(0),$("#systemsettings_backuprestores1").find("[data-ui-field=restore_log]").empty(),$("#systemsettings_backuprestores1").find("[data-ui-field=restore_log]").hide(),$("#systemsettings_backuprestores1").find("[data-ui-field=user-programs]").show(),$("#systemsettings_backuprestores1").popup("open")}),$("#systemsettings_backuprestores1confirmbutton").bind("click",function(){$("#systemsettings_backuprestores1cancelbutton").addClass("ui-disabled"),$("#systemsettings_backuprestores1confirmbutton").addClass("ui-disabled"),$("#systemsettings_backuprestores1").find("[data-ui-field=restore_log]").show(),$("#systemsettings_backuprestores1").find("[data-ui-field=user-programs]").hide(),$.mobile.loading("show",{text:"Please be patient, this may take some time...",textVisible:!0,theme:"a",html:""}),HG.Configure.System.ServiceCall("System.ConfigurationRestoreS2/"+e.RestoreProgramList,function(){$.mobile.loading("hide"),window.location.replace("/")})}))}),$("#systemsettings_modulesdelete").on("popupbeforeposition",function(){e.RefreshModulesList()}),$("#configure_interfaces_modules_list").on("click","li",function(){$.mobile.loading("show");var t=$(this).attr("data-context-domain"),o=$(this).attr("data-context-address");HG.Configure.Modules.Delete(t,o,function(){for(var a=-1,i=0;i<HG.WebApp.Data.Modules.length;i++){var r=HG.WebApp.Data.Modules[i];if(r.Domain==t&&r.Address==o){a=i;break}}-1!=a&&HG.WebApp.Data.Modules.splice(a,1),e.RefreshModulesList(),$.mobile.loading("hide")})}),$("#systemsettings_databasemaxsize_change").bind("click",function(){var t=$("#systemsettings_databasemaxsizechange_size").val();$.mobile.loading("show"),HG.Statistics.SetStatisticsDatabaseMaximumSize(t,function(){$.mobile.loading("hide"),setTimeout(function(){e.LoadStatisticsSettings()},1e3)})}),$("#maintenance_configuration_routingresetbutton").on("click",function(){var e=HG.WebApp.Locales.GetLocaleString("systemsettings_resetroutingdata_warning","This operation cannot be undone.");HG.WebApp.Utility.ConfirmPopup(HG.WebApp.Locales.GetLocaleString("systemsettings_resetroutingdata_title","Reset routing data?"),e,function(e){e&&HG.Configure.Modules.RoutingReset()})}),$("#maintenance_configuration_databaseresetbutton").on("click",function(){var e=HG.WebApp.Locales.GetLocaleString("systemsettings_resetdatabase_warning","This operation cannot be undone.");HG.WebApp.Utility.ConfirmPopup(HG.WebApp.Locales.GetLocaleString("systemsettings_resetdatabase_title","Reset stats database?"),e,function(e){e&&HG.Statistics.DatabaseReset()})}),t.find("[id=systemsettings_browserepo]").on("popupbeforeposition",function(){var e=$(window).height()-320,o=$(window).width();o-=o/5;var a=t.find("[data-ui-field=browser_files]");o>500&&(a.parent().parent().css("width",o),a.parent().parent().css("max-width",o)),a.css("height",e/2),a.css("max-height",e/2);var i=t.find("[data-ui-field=browser_text]");i.css("height",e/2),i.css("max-height",e/2)}).on("popupafteropen",function(){e.BrowseRoot()}),t.find("[data-ui-field=parent_folder]").on("click",function(){var t=e.BrowseRepository,o=e._BrowserHistory;o.length>1&&(o.pop(),t(o.pop()))}),t.find("[data-ui-field=install_package]").on("click",function(){t.find("[data-ui-field=install_text]").empty(),t.find("[data-ui-field=install_package]").addClass("ui-disabled"),$.mobile.loading("show"),$.get("/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Config/Package.Install/"+encodeURIComponent(e._BrowserPackage),function(){t.find("[data-ui-field=install_package]").removeClass("ui-disabled"),$.mobile.loading("hide")})}),t.find("[data-ui-field=repository_browse]").on("click",function(){e.BrowseRoot()})})},e._BrowserHistory=[],e._BrowserPackage="",e.BrowseRoot=function(){e._BrowserHistory=[];var t=$("#"+e.PageId);e.BrowseRepository({url:t.find("[data-ui-field=repository_url]").val()+"/packages",name:""})},e.BrowseRepository=function(t){var o=$("#"+e.PageId),a=o.find("[data-ui-field=repository_files]"),i=o.find("[data-ui-field=description_text]"),r=o.find("[data-ui-field=package_info]"),n=o.find("[id=systemsettings_browserepo]"),s=e.BrowseRepository,l=e._BrowserHistory;l.push(t),l.length>1?o.find("[data-ui-field=parent_folder]").show():o.find("[data-ui-field=parent_folder]").hide(),o.find("[data-ui-field=install_package]").hide(),o.find("[data-ui-field=install_text]").empty(),i.html(""),r.hide();var d="";$.each(l,function(e,t){d+="<strong>"+t.name+"</strong> / "}),o.find("[data-ui-field=browser_path]").html(d),a.empty(),$.mobile.loading("show"),$.get(t.url,function(t){$.each(t,function(t,n){if("dir"==n.type){var l=$('<li><a href="#" class="ui-btn ui-btn-icon-left ui-icon-fa-folder">'+n.name+"</a></li>");a.append(l),l.on("click",function(){s({url:n.url,name:n.name})})}else"package.json"==n.name.toLowerCase()?(e._BrowserPackage=n.download_url.substring(0,n.download_url.lastIndexOf("/")),$.get(n.download_url,function(t){t=$.parseJSON(t);var i="<strong>"+t.title+"</strong>";i+="<br/><strong>Version</strong>: "+t.version,i+="<br/><strong>Author</strong>: "+t.author,i+="<br/><strong>Files</strong>: ",i+=t.programs.length+" automation programs, ",i+=t.widgets.length+" ui widgets, ",i+=t.interfaces.length+" mig interfaces",i+="<br/><strong>Published</strong>: "+t.published,"undefined"!=typeof t.sourcecode&&""!=t.sourcecode&&(i+='<br/><i class="fa fa-file-code-o fa-md"></i> <a href="'+t.sourcecode+'" target="_blank">Source Code</a>'),"undefined"!=typeof t.homepage&&""!=t.homepage&&(i+='<br/><i class="fa fa-comments fa-md"></i> <a href="'+t.homepage+'" target="_blank">Forum Thread</a>'),r.html(i+"<br/>"),r.show(),o.find("[data-ui-field=browser_text]").scrollTop(0),$.get("/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Config/Package.Get/"+encodeURIComponent(e._BrowserPackage),function(e){"undefined"!=typeof e.install_date&&r.append("<br/><strong>Installed</strong>: "+e.install_date)}),$.each(t.programs,function(e,t){var o=$('<li><a href="#" class="ui-btn ui-btn-icon-left ui-icon-fa-file-code-o">'+t.description+" ("+t.file+")</a></li>");a.append(o)}),$.each(t.widgets,function(e,t){var o=$('<li><a href="#" class="ui-btn ui-btn-icon-left ui-icon-fa-cube">'+t.description+" ("+t.file+")</a></li>");a.append(o)}),$.each(t.interfaces,function(e,t){var o=$('<li><a href="#" class="ui-btn ui-btn-icon-left ui-icon-fa-wrench">'+t.description+" ("+t.file+")</a></li>");a.append(o)})}),o.find("[data-ui-field=install_package]").show()):n.name.toLowerCase().endsWith(".md")?$.get(n.download_url,function(e){i.html(marked(e)),o.find("[data-ui-field=browser_text]").scrollTop(0)}):"file"==n.type}),a.listview().listview("refresh"),setTimeout(function(){n.popup().popup("reposition",{positionTo:"window"}),$.mobile.loading("hide")},300)})},e.LoadSettings=function(){$.mobile.loading("show"),e.LoadUpdateCheckSettings(),HG.System.LoggingIsEnabled(function(e){$("#configure_system_flip_logging").val(e).slider("refresh"),$.mobile.loading("hide")}),e.LoadHttpSettings(),e.LoadStatisticsSettings(),$("#configure_system_flip_eventshistory").val(HG.WebApp.Store.get("UI.EventsHistory")?"1":"0").slider("refresh");var t=HG.WebApp.Store.get("UI.TemperatureUnit");$("#tempunit-celsius").prop("checked",!1),$("#tempunit-fahrenheit").prop("checked",!1),"F"!=t?$("#tempunit-celsius").prop("checked",!0):$("#tempunit-fahrenheit").prop("checked",!0),$("input[name='tempunit-choice']").checkboxradio("refresh");var o=HG.WebApp.Store.get("UI.DateFormat");$("#dateformat-dmy").prop("checked",!1),$("#dateformat-mdy").prop("checked",!1),"MDY12"!=o?$("#dateformat-dmy").prop("checked",!0):$("#dateformat-mdy").prop("checked",!0),$("input[name='dateformat-choice']").checkboxradio("refresh")},e.LoadUpdateCheckSettings=function(){$.mobile.loading("show"),$("#configure_system_updateinstall_button").addClass("ui-disabled"),HG.System.UpdateManager.GetUpdateList(function(e){if(0==e.length)$("#configure_system_updatemanager_info").html(HG.WebApp.Locales.GetLocaleString("configure_system_updatemanager_no_updates")),$("#configure_system_updatemanager_detailsscroll").hide(),$("#configure_system_updatemanager_installbutton").hide();else{$("#configure_system_updatemanager_info").html(HG.WebApp.Locales.GetLocaleString("configure_system_updatemanager_updates_available"));for(var t="<pre>",o=0;o<e.length;o++){var a=e[o];t+=" * <strong>"+a.Name+" "+a.Version+"</strong>\n",t+="   <em>"+a.ReleaseNote+"</em>\n"}t+="</pre>",$("#configure_system_updatemanager_details").html(t),$("#configure_system_updatemanager_detailsscroll").show(),$("#configure_system_updatemanager_installbutton").show()}$.mobile.loading("hide")})},e.LoadHttpSettings=function(){$.mobile.loading("show"),HG.System.HasPassword(function(e){var t="1"==e.ResponseValue?"on":"off";$("#securitysettings_password_image").attr("src","images/protection-"+t+".png"),HG.System.WebCacheIsEnabled(function(e){$("#configure_system_flip_httpcache").val("true"==e?"1":"0").slider("refresh"),$.mobile.loading("hide")}),HG.Configure.System.ServiceCall("HttpService.GetPort",function(e){$("#http_service_port").val(e),$("#systemsettings_httpport_text").html(e),$.mobile.loading("hide")}),HG.Configure.System.ServiceCall("HttpService.GetHostHeader",function(e){$("#http_host_header").val(e),$("#systemsettings_hostheader_text").html(e),$.mobile.loading("hide")})})},e.LoadStatisticsSettings=function(){$.mobile.loading("show"),HG.Configure.System.ServiceCall("Statistics.GetStatisticsDatabaseMaximumSize",function(e){$("#systemsettings_databasemaxsizechange_size").val(e),$("#systemsettings_databasemaxsize_text").html(e),$.mobile.loading("hide")})},e.RefreshModulesList=function(){$("#configure_interfaces_modules_list").empty();for(var e="",t=0;t<HG.WebApp.Data.Modules.length;t++){var o=HG.WebApp.Data.Modules[t];"HomeAutomation.HomeGenie.Automation"!=o.Domain&&(e!=o.Domain&&($("#configure_interfaces_modules_list").append($("<li/>",{"data-role":"list-divider"}).append(o.Domain)),e=o.Domain),$("#configure_interfaces_modules_list").append($("<li/>",{"data-icon":"minus","data-context-domain":o.Domain,"data-context-address":o.Address}).append($("<a/>",{text:o.Address+" "+o.Name}))))}e="";for(var t=0;t<HG.WebApp.Data.Modules.length;t++){var o=HG.WebApp.Data.Modules[t];"HomeAutomation.HomeGenie.Automation"==o.Domain&&(e!=o.Domain&&($("#configure_interfaces_modules_list").append($("<li/>",{"data-role":"list-divider"}).append(o.Domain)),e=o.Domain),$("#configure_interfaces_modules_list").append($("<li/>",{"data-icon":"minus","data-context-domain":o.Domain,"data-context-address":o.Address}).append($("<a/>",{text:o.Address+" "+o.Name}))))}$("#configure_interfaces_modules_list").listview("refresh")}},HG.WebApp.AutomationGroupsList=HG.WebApp.AutomationGroupsList||new function(){var e=this;e.PageId="page_configure_automationgroups",e._CurrentGroup="",e.InitializePage=function(){var t=$("#"+e.PageId),o=t.find("[data-ui-field=widgeteditor-btn]");e.groupList=$("#configure_automationgroupslist"),t.on("pageinit",function(){t.find("[id=automationgroup_add]").on("popupbeforeposition",function(){t.find("[id=automationgroup_new_name]").val("")}),t.find("[id=automationgroup_new_button]").bind("click",function(){e.GroupsAdd($("#automationgroup_new_name").val())}),o.bind("click",function(){$.mobile.pageContainer.pagecontainer("change","#"+HG.WebApp.WidgetsList.PageId,{transition:"slide"})}),$.mobile.loading("show"),HG.Configure.Groups.List("Automation",function(){e.GetGroupsListViewItems(),$.mobile.loading("hide")})}),t.on("pagebeforeshow",function(){HG.Automation.Programs.List(function(){e.LoadGroups()})})},e.LoadGroups=function(){$.mobile.loading("show"),HG.Configure.Groups.List("Automation",function(){e.GetGroupsListViewItems(),$.mobile.loading("hide")})},e.GetGroupsListViewItems=function(){e.groupList.hasClass("ui-sortable")&&(e.groupList.sortable("destroy"),e.groupList.off("sortstop")),e.groupList.empty();for(var t=HG.WebApp.SystemSettings.GetInterface("HomeAutomation.ZWave"),o=HG.WebApp.SystemSettings.GetInterface("HomeAutomation.Insteon"),a=HG.WebApp.SystemSettings.GetInterface("HomeAutomation.X10"),i=HG.WebApp.SystemSettings.GetInterface("HomeAutomation.W800RF"),r=0,n=' style="display:none"',s='<li data-icon="false" data-role="list-divider">'+HG.WebApp.Locales.GetLocaleString("configure_grouplist")+"</li>";r<HG.WebApp.Data.AutomationGroups.length;r++){var l=HG.WebApp.Data.AutomationGroups[r].Name,d="";"Raspberry Pi"!=l&&"CubieTruck"!=l||"Win"!=HOST_SYSTEM.substring(0,3)?"X10"==l&&null==a&&null==o&&null==i?d=n:"Z-Wave"==l&&null==t&&(d=n):d=n;var u=0;for(p=0;p<HG.WebApp.Data.Programs.length;p++)HG.WebApp.Data.Programs[p].Group==HG.WebApp.Data.AutomationGroups[r].Name&&u++;s+="<li"+d+' data-icon="false" data-group-name="'+l+'" data-group-index="'+r+'">',s+='<a href="#page_automation_programs">'+l+"</a>",s+='<span class="ui-li-count">'+u+"</span>",s+='<div style="position:absolute;right:40px;top:0;height:100%;overflow:hidden"><a class="handle ui-btn ui-icon-fa-sort ui-btn-icon-notext ui-list-btn-option-mini"></a></div>',s+="</li>"}for(u=0,p=0;p<HG.WebApp.Data.Programs.length;p++)HG.WebApp.Data.Programs[p].Group&&""!=HG.WebApp.Data.Programs[p].Group&&"undefined"!=HG.WebApp.Data.Programs[p].Group||u++;u>0&&(s+='<li data-icon="false" data-group-name=""><a href="#page_automation_programs">Ungrouped</a><span class="ui-li-count">'+u+"</span></li>"),e.groupList.append(s),e.groupList.listview().listview("refresh"),e.groupList.sortable({handle:".handle",axis:"y",scrollSpeed:10}).sortable("refresh"),e.groupList.on("sortstop",function(){e.SortGroups()}),e.groupList.find("li").on("click",function(){e._CurrentGroup=$(this).attr("data-group-name"),e.groupList.attr("selected-group-name",$(this).attr("data-group-name")),e.groupList.attr("selected-group-index",$(this).attr("data-group-index"))})},e.GetGroupModules=function(e){for(var t={Index:0,Name:e,Modules:Array()},o=0;o<HG.WebApp.Data.AutomationGroups.length;o++)if(HG.WebApp.Data.AutomationGroups[o].Name==e){t.Index=o;for(var a=0;a<HG.WebApp.Data.AutomationGroups[o].Modules.length;a++){for(var i=!1,r=0;r<HG.WebApp.Data.Modules.length;r++)if(HG.WebApp.Data.Modules[r].Domain==HG.WebApp.Data.AutomationGroups[o].Modules[a].Domain&&HG.WebApp.Data.Modules[r].Address==HG.WebApp.Data.AutomationGroups[o].Modules[a].Address){t.Modules.push(HG.WebApp.Data.Modules[r]),i=!0;break}i||t.Modules.push(HG.WebApp.Data.AutomationGroups[o].Modules[a])}break}return t},e.GetModuleGroup=function(e){for(var t=null,o=0;o<HG.WebApp.Data.AutomationGroups.length;o++){for(var a=0;a<HG.WebApp.Data.AutomationGroups[o].Modules.length;a++)if(e.Domain==HG.WebApp.Data.AutomationGroups[o].Modules[a].Domain&&e.Address==HG.WebApp.Data.AutomationGroups[o].Modules[a].Address){t=HG.WebApp.Data.AutomationGroups[o];break}if(null!=t)break}return t},e.GroupsAdd=function(t){HG.Configure.Groups.AddGroup("Automation",t,function(){e.LoadGroups()})},e.SortGroups=function(){var t="";e.groupList.children("li").each(function(){var e=$(this).attr("data-group-index");e>=0&&(t+=e+";")}),HG.Configure.Groups.Sort("Automation",t,function(){e.LoadGroups()})},e.SaveGroups=function(){$.mobile.loading("show"),$.ajax({type:"POST",url:"/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Config/Groups.Save/Automation/",data:JSON.stringify(HG.WebApp.Data.AutomationGroups),success:function(){$("#control_automationgroupslist").empty(),$.mobile.loading("hide")},error:function(){$.mobile.loading("hide")}})}};var editor1=null,editor2=null,editor3=null;HG.WebApp.ProgramsList=HG.WebApp.ProgramsList||new function(){var e=this;e.PageId="page_automation_programs",e.InitializePage=function(){var t=$("#"+e.PageId);t.on("pageinit",function(){$("#automation_program_add").on("popupbeforeposition",function(){$("#program_new_name").val("")}),$("#btn_automationprograms_group_delete").bind("click",function(){HG.Ui.SwitchPopup("#listprograms_actionmenu","#automationprograms_group_delete")}),$("#btn_automation_program_import").bind("click",function(){HG.Ui.SwitchPopup("#listprograms_actionmenu","#automation_program_import")}),$("#btn_automation_program_add").bind("click",function(){HG.Ui.SwitchPopup("#listprograms_actionmenu","#automation_program_add")}),$("#btn_automation_program_refresh").bind("click",function(){$("#listprograms_actionmenu").popup("close"),e.LoadPrograms(null)}),$("#automationprograms_delete_button").bind("click",function(){e.DeleteGroup(HG.WebApp.AutomationGroupsList._CurrentGroup)}),$("#program_new_button").bind("click",function(){e.AddProgram($("#program_new_name").val())}),$("#program_switchtypecancel_button").bind("click",function(){$("#automation_programtype").val(HG.WebApp.ProgramEdit._CurrentProgram.Type),$("#automation_programtype").selectmenu("refresh")}),$("#program_switchtype_button").bind("click",function(){HG.WebApp.ProgramEdit._CurrentProgram.Type=$("#automation_programtype").select().val(),e.SetProgramType()}),$("#automationprograms_program_edit").bind("click",function(){e.EditProgram()}),$("#automationprograms_program_delete_button").bind("click",function(){e.DeleteProgram(HG.WebApp.ProgramEdit._CurrentProgram.Address)}),$("#program_import_button").bind("click",function(){""==$("#program_import_uploadfile").val()?(alert("Select a file to import first"),$("#program_import_uploadfile").parent().stop().animate({borderColor:"#FF5050"},250).animate({borderColor:"#FFFFFF"},250).animate({borderColor:"#FF5050"},250).animate({borderColor:"#FFFFFF"},250)):($("#automation_program_import").popup("close"),$.mobile.loading("show",{text:"Importing, please wait...",textVisible:!0,html:""}),$("#program_import_form").attr("action","/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Automation/Programs.Import/"+HG.WebApp.AutomationGroupsList._CurrentGroup),$("#program_import_form").submit())}),$("#program_import_uploadframe").bind("load",function(){$("#program_import_uploadfile").val(""),$.mobile.loading("hide"),e.LoadPrograms(null)})}),t.on("pagebeforeshow",function(){e.LoadPrograms()})},e._CurrentOptionsTab=0,e.SetOptionsTab=function(t){e._CurrentOptionsTab=t,$("#automationprograms_program_options_tab0 a").removeClass("ui-btn-active"),$("#automationprograms_program_options_tab0 a").trigger("create"),$("#automationprograms_program_options_tab1 a").removeClass("ui-btn-active"),$("#automationprograms_program_options_tab1 a").trigger("create"),0==t?(e.RefreshProgramOptions(),$("#automationprograms_program_details").hide(),$("#automationprograms_program_parameters").show()):(e.RefreshProgramDetails(),$("#automationprograms_program_parameters").hide(),$("#automationprograms_program_details").show()),setTimeout(function(){$("#automationprograms_program_options_tab"+t+" a").addClass("ui-btn-active"),$("#automationprograms_program_options_tab"+t+" a").trigger("create"),setTimeout(function(){$("#automationprograms_program_options").popup("reposition",{positionTo:"window"})},200)},200)},e.RefreshProgramDetails=function(){var e=$("#automationprograms_program_details");e.empty(),e.trigger("create");var t=HG.WebApp.Utility.GetProgramByAddress(HG.WebApp.ProgramEdit._CurrentProgram.Address);if(null!=t){for(var o="",a=t.Features,i=0;i<a.length;i++){o+='<li><p style="font-size:12pt;margin:0;padding:0"><strong>'+a[i].Property+"</strong> : ",o+=""+HG.WebApp.Locales.GetProgramLocaleString(t.Address,a[i].Property,a[i].Description)+"</br>";var r=a[i].ForDomains;""==r&&(r="Any");var n=a[i].ForTypes;""==n&&(n="Any"),o+='<span style="font-size:8pt;font;">Applies to: &nbsp;&nbsp;&nbsp; <strong>Domain</strong> &#9658; <em>'+r+"</em> &nbsp;&nbsp;&nbsp; <strong>Type</strong> &#9658; <em>"+n+"</em></span></p></li>"}""!=o&&(o='</br><ul data-role="listview"><li data-role="list-divider">'+HG.WebApp.Locales.GetLocaleString("configure_program_details_implemfeatures")+"</li>"+o+"</ul></br>",e.append(o))}var s=HG.WebApp.Utility.GetModuleByDomainAddress(HG.WebApp.ProgramEdit._CurrentProgram.Domain,HG.WebApp.ProgramEdit._CurrentProgram.Address);if(null!=s){o="";for(var l=0;l<s.Properties.length;l++)if("ConfigureOptions."==s.Properties[l].Name.substring(0,17)){var d="text",p=s.Properties[l].Description&&"undefined"!=s.Properties[l].Description&&""!=s.Properties[l].Description?s.Properties[l].Description:s.Properties[l].Name;p.toLowerCase().indexOf("password")>=0&&(d="password");var u=s.Properties[l].UpdateTime;u=u.replace(" ","T");var c=new Date(u);o+='<li><p style="font-size:12pt;margin:0;padding:0"><strong>'+s.Properties[l].Name.substring(17)+"</strong> = ",o+='"'+("password"==d?"*****":s.Properties[l].Value)+'"</br>',o+='<span style="font-size:8pt;"><em>'+c+"</em></span></p></li>"}""!=o&&(o='</br><ul data-role="listview"><li data-role="list-divider">'+HG.WebApp.Locales.GetLocaleString("configure_program_details_configoptions")+"</li>"+o+"</ul></br>",e.append(o))}if(null!=s){for(var o="",l=0;l<s.Properties.length;l++)if("ConfigureOptions."!=s.Properties[l].Name.substring(0,17)&&"Widget.DisplayModule"!=s.Properties[l].Name&&"VirtualModule.ParentId"!=s.Properties[l].Name){var u=s.Properties[l].UpdateTime;u=u.replace(" ","T");var c=new Date(u);o+='<li><p style="font-size:12pt;margin:0;padding:0"><strong>'+s.Properties[l].Name+"</strong> = ",o+='"'+s.Properties[l].Value+'"</br>',o+='<span style="font-size:8pt;font;"><em>'+c+"</em></span></p></li>"}""!=o&&(o='</br><ul data-role="listview"><li data-role="list-divider">'+HG.WebApp.Locales.GetLocaleString("configure_program_details_moduleparams")+"</li>"+o+"</ul></br>",e.append(o));HG.WebApp.Utility.GetModulePropertyByName(s,"Widget.DisplayModule")}var o="";if(HG.WebApp.Data.Modules&&HG.WebApp.Data.Modules.length)for(m=0;m<HG.WebApp.Data.Modules.length;m++){var g=HG.WebApp.Data.Modules[m],f=HG.WebApp.Utility.GetModulePropertyByName(g,"VirtualModule.ParentId");null!=f&&f.Value==HG.WebApp.ProgramEdit._CurrentProgram.Address&&"HomeAutomation.HomeGenie.Automation"!=g.Domain&&(o+='<li><p style="font-size:12pt;margin:0;padding:0"><strong>'+g.Domain+" "+g.Address+"</strong>",o+="</br>",o+='<span style="font-size:8pt;font;"> ',o+="<strong>Type</strong> &#9658; <em>"+g.DeviceType+"</em> &nbsp;&nbsp;&nbsp;",""!=g.Name&&(o+="<strong>Name</strong> &#9658; <em>"+g.Name+"</em> &nbsp;&nbsp;&nbsp;"),o+="</span></p></li>")}""!=o&&(o='</br><ul data-role="listview"><li data-role="list-divider">Virtual Modules</li>'+o+"</ul></br>",e.append(o)),e.trigger("create")},e.RefreshProgramOptions=function(){var e=$("#automationprograms_program_parameters");e.empty(),e.trigger("create");var t=HG.WebApp.Utility.GetProgramByAddress(HG.WebApp.ProgramEdit._CurrentProgram.Address);if(null!=t){$("#automationprograms_program_title").html(HG.WebApp.Locales.GetProgramLocaleString(t.Address,"Title",t.Name));var o="undefined"!=t.Description&&null!=t.Description?t.Description:"";o=HG.WebApp.Locales.GetProgramLocaleString(t.Address,"Description",o),$("#automationprograms_program_description").html(o.replace(/\n/g,"<br />"))}var a=HG.WebApp.Utility.GetModuleByDomainAddress(HG.WebApp.ProgramEdit._CurrentProgram.Domain,HG.WebApp.ProgramEdit._CurrentProgram.Address);if(null!=a){for(var i=Array(),r=0;r<a.Properties.length;r++)"ConfigureOptions."==a.Properties[r].Name.substring(0,17)&&i.push(a.Properties[r]);i.sort(function(e,t){return e=e.Description,t=t.Description,t>e?-1:e>t?1:0});for(var r=0;r<i.length;r++){var n="text",o=i[r].Description&&"undefined"!=i[r].Description&&""!=i[r].Description?i[r].Description:i[r].Name;o.toLowerCase().indexOf("password")>=0&&(n="password");var s=$('<div><p style="font-weight:bold">'+HG.WebApp.Locales.GetProgramLocaleString(t.Address,i[r].Name,o)+"</p></div>"),l=$('<input type="'+n+'" data-parameter-name="'+i[r].Name+'" onchange="HG.WebApp.ProgramsList.UpdateProgramParameter($(this))" />');l.val(i[r].Value),s.append(l),e.append(s)}}e.trigger("create")},e.UpdateProgramParameter=function(e){for(var t=e.attr("data-parameter-name"),o=HG.WebApp.Utility.GetModuleByDomainAddress(HG.WebApp.ProgramEdit._CurrentProgram.Domain,HG.WebApp.ProgramEdit._CurrentProgram.Address),a=0;a<o.Properties.length;a++)o.Properties[a].Name==t&&(o.Properties[a].Value=e.val(),o.Properties[a].NeedsUpdate="true");HG.WebApp.GroupModules.UpdateModule(o,null)},e.SetProgramType=function(){HG.WebApp.ProgramEdit._CurrentProgram.ScriptErrors="","arduino"==HG.WebApp.ProgramEdit._CurrentProgram.Type.toLowerCase()?(editor1.setValue(["ARDUINO_DIR = /usr/share/arduino\n","# Specify your board tag","# TAG          BOARD NAME","# alamode      Arduino compatible board for the Raspberry Pi","# atmega168    Arduino NG or older w/ ATmega168","# atmega328    Arduino Duemilanove w/ ATmega328","# atmega8      Arduino NG or older w/ ATmega8","# bt           Arduino BT w/ ATmega168","# bt328        Arduino BT w/ ATmega328","# diecimila    Arduino Diecimila or Duemilanove w/ ATmega168","# ethernet     Arduino Ethernet","# esplora      Arduino Esplora","# fio          Arduino Fio","# leonardo     Arduino Leonardo","# lilypad      LilyPad Arduino w/ ATmega168","# lilypad328   LilyPad Arduino w/ ATmega328","# LilyPadUSB   LilyPad Arduino USB","# mega         Arduino Mega (ATmega1280)","# mega2560     Arduino Mega 2560 or Mega ADK","# micro        Arduino Micro","# mini         Arduino Mini w/ ATmega168","# mini328      Arduino Mini w/ ATmega328","# nano         Arduino Nano w/ ATmega168","# nano328      Arduino Nano w/ ATmega328","# pro          Arduino Pro or Pro Mini (3.3V, 8 MHz) w/ ATmega168","# pro328       Arduino Pro or Pro Mini (3.3V, 8 MHz) w/ ATmega328","# pro5v        Arduino Pro or Pro Mini (5V, 16 MHz) w/ ATmega168","# pro5v328     Arduino Pro or Pro Mini (5V, 16 MHz) w/ ATmega328","# robotControl Arduino Robot Control","# robotMotor   Arduino Robot Motor","# uno          Arduino Uno","BOARD_TAG    = pro328\n","# Change to your own tty interface","ARDUINO_PORT = /dev/ttyAMA0\n","# The libs needed by your sketchbook, examples are : Wire Wire/utility Ethernet...","ARDUINO_LIBS = \n","# This is where arduino-mk is installed","include /usr/share/arduino/Arduino.mk\n\n"].join("\n")),editor2.setValue(["/*"," * For documentation see http://arduino.cc/en/Tutorial/Sketch .",' * After compiling, use "Run" option from "Actions" menu to upload this sketch to your Arduino board.'," */",'#include "Arduino.h"\n',"// The setup routine runs once when you press reset:","void setup() {","","}","","// The loop routine runs over and over again forever:","void loop() {","    delay(1000);","}\n"].join("\n"))):"python"==HG.WebApp.ProgramEdit._CurrentProgram.Type.toLowerCase()?(editor1.setValue(""),editor2.setValue('"""\nPython Automation Script\nExample for using Helper Classes:\nhg.Modules.WithName(\'Light 1\').On()\n"""\n')):"ruby"==HG.WebApp.ProgramEdit._CurrentProgram.Type.toLowerCase()?(editor1.setValue(""),editor2.setValue("# Ruby Automation Script\n# Example for using Helper Classes:\n# hg.Modules.WithName('Light 1').On()\n")):"javascript"==HG.WebApp.ProgramEdit._CurrentProgram.Type.toLowerCase()?(editor1.setValue(""),editor2.setValue("// Javascript Automation Script\n// Example for using Helper Classes:\n// hg.modules.withName('Light 1').on();\n")):"csharp"==HG.WebApp.ProgramEdit._CurrentProgram.Type.toLowerCase()&&(editor1.setValue(""),editor2.setValue('// CSharp Automation Program Plugin\n// Example for using Helper Classes:\n// Modules.WithName("Light 1").On();\n')),e.RefreshProgramType()},e.RefreshProgramType=function(){HG.WebApp.ProgramEdit._CurrentProgram.Type=$("#automation_programtype").select().val(),"wizard"!=HG.WebApp.ProgramEdit._CurrentProgram.Type.toLowerCase()?($("[data-block-id=configure_program_editfortypewizard]").css("display","none"),$("[data-block-id=configure_program_editfortypecsharp]").css("display","")):($("[data-block-id=configure_program_editfortypewizard]").css("display",""),$("[data-block-id=configure_program_editfortypecsharp]").css("display","none")),$("#program_edit_tab2_button").html(HG.WebApp.Locales.GetLocaleString("configure_program_programcode")),$(editor2.getWrapperElement()).show(),$(editor3.getWrapperElement()).hide(),$("#configure_program_editorsketch").hide(),"wizard"!=HG.WebApp.ProgramEdit._CurrentProgram.Type.toLowerCase()?($("#program_edit_tab3_button").html(HG.WebApp.Locales.GetLocaleString("configure_program_startupcode","Startup Code")),$("#automation_conditiontype").val("OnTrue"),$("#automation_conditiontype_wrapper").hide(),"arduino"==HG.WebApp.ProgramEdit._CurrentProgram.Type.toLowerCase()?($(editor1.getWrapperElement()).show(),$(editor2.getWrapperElement()).show(),$(editor3.getWrapperElement()).hide(),$("#configure_program_editorsketch").show(),$("#program_edit_tab2_button").html(HG.WebApp.Locales.GetLocaleString("configure_program_sketchcode")),$("#program_edit_tab3_button").html(HG.WebApp.Locales.GetLocaleString("configure_program_makefile")),
editor3.setOption("mode","text/x-csrc"),editor2.setOption("mode","text/x-csrc"),editor1.setOption("mode","text/x-python"),HG.WebApp.ProgramEdit.SketchFileOpen("main")):"python"==HG.WebApp.ProgramEdit._CurrentProgram.Type.toLowerCase()?(editor2.setOption("mode","text/x-python"),editor1.setOption("mode","text/x-python")):"ruby"==HG.WebApp.ProgramEdit._CurrentProgram.Type.toLowerCase()?(editor2.setOption("mode","text/x-ruby"),editor1.setOption("mode","text/x-ruby")):"javascript"==HG.WebApp.ProgramEdit._CurrentProgram.Type.toLowerCase()?(editor2.setOption("mode","text/javascript"),editor1.setOption("mode","text/javascript")):"csharp"==HG.WebApp.ProgramEdit._CurrentProgram.Type.toLowerCase()&&(editor2.setOption("mode","text/x-csharp"),editor1.setOption("mode","text/x-csharp"))):($("#automation_conditiontype_wrapper").show(),$("#program_edit_tab3_button").html(HG.WebApp.Locales.GetLocaleString("configure_program_triggercode")),$("#automation_conditiontype_wrapper").show(),$("#automation_conditiontype").val("OnSwitchTrue"),$("#automation_conditiontype").selectmenu().selectmenu("refresh")),HG.WebApp.ProgramEdit.RefreshProgramEditorTitle(),HG.WebApp.ProgramEdit.RefreshCodeMirror()},e.ChangeProgramType=function(){$("#automation_program_switchtype").popup().popup("open")},e.LoadPrograms=function(t){$.mobile.loading("show"),HG.Automation.Programs.List(function(){e.RefreshPrograms(),$.mobile.loading("hide"),t&&t()})},e.RefreshPrograms=function(){var t=HG.WebApp.Locales.GetLocaleString("configure_program_automationtitle","Programs List");for($("#configure_automation_group_title").html('<font style="color:gray">'+t+"</font><br />"+HG.WebApp.AutomationGroupsList._CurrentGroup),$("#configure_programslist").empty(),$("#configure_programslist").append('<li data-icon="false" data-role="list-divider">'+HG.WebApp.Locales.GetLocaleString("configure_programslist_listtitle")+"</li>"),i=0;i<HG.WebApp.Data.Programs.length;i++){var o=HG.WebApp.Data.Programs[i],a=o.Group;if(null!=a&&"undefined"!=a||(a=""),a==HG.WebApp.AutomationGroupsList._CurrentGroup){var r=HG.WebApp.Locales.GetProgramLocaleString(o.Address,"Title",o.Name),n='<li data-icon="'+(o.IsEnabled?"check":"alert")+'">';n+='<a href="#" class="programitem" data-program-domain="'+o.Domain+'"  data-program-address="'+o.Address+'" data-program-index="'+i+'">';var s=e.GetProgramStatusColor(o),l="";if(null!=o.TriggerTime){var d=moment(o.TriggerTime);l=d.format("L LT")}var p=null!=o.Description?o.Description:"";p=HG.WebApp.Locales.GetProgramLocaleString(o.Address,"Description",p),n+='   <p class="ui-li-aside ui-li-desc">'+o.Type+" &nbsp;&nbsp;&nbsp;<strong>PID:</strong> "+o.Address+'<br><font style="opacity:0.5">'+l+"</font></p>",n+='   <h3 class="ui-li-heading"><img src="images/common/led_'+s+'.png" style="width:24px;height:24px;vertical-align:middle;margin-bottom:5px;margin-right:5px;" /> '+r+"</h3>",n+='   <p class="ui-li-desc">'+p+" &nbsp;</p>",n+="</a>",n+="<a href=\"javascript:HG.WebApp.ProgramsList.ToggleProgramIsEnabled('"+o.Address+"')\">"+(o.IsEnabled?HG.WebApp.Locales.GetLocaleString("configure_programslist_tap_disable"):HG.WebApp.Locales.GetLocaleString("configure_programslist_tap_enable"))+"</a>",n+="</li>",$("#configure_programslist").append(n)}}$("#configure_programslist").listview(),$("#configure_programslist").listview("refresh"),$("#configure_programslist li a").bind("click",function(){HG.WebApp.ProgramEdit._CurrentProgram.Domain=$(this).attr("data-program-domain"),HG.WebApp.ProgramEdit._CurrentProgram.Address=$(this).attr("data-program-address"),e.UpdateOptionsPopup()})},e.UpdateOptionsPopup=function(){HG.WebApp.ProgramEdit._CurrentProgram.Domain&&HG.WebApp.ProgramEdit._CurrentProgram.Address&&($.mobile.activePage.attr("id")!=e.PageId?($("#automationprograms_program_edit").hide(),$("#automationprograms_program_btn_delete").hide()):($("#automationprograms_program_edit").show(),$("#automationprograms_program_btn_delete").show()),$.mobile.loading("show",{text:HG.WebApp.Locales.GetLocaleString("update_options_popup_loading"),textVisible:!0,theme:"a",html:""}),HG.Automation.Programs.List(function(){HG.Configure.Modules.List(function(t){try{HG.WebApp.Data.Modules=t}catch(o){}e.RefreshProgramOptions(),e.RefreshProgramDetails();var a=!0;""==$("#automationprograms_program_details").text().trim()?($("#automationprograms_program_options_tab1").css("visibility","hidden"),a=!1):$("#automationprograms_program_options_tab1").css("visibility",""),""==$("#automationprograms_program_parameters").text().trim()?($("#automationprograms_program_options_tab0").css("visibility","hidden"),a?e.SetOptionsTab(1):($("#automationprograms_program_parameters").hide(),$("#automationprograms_program_details").hide())):($("#automationprograms_program_options_tab0").css("visibility",""),e.SetOptionsTab(0)),$("#automationprograms_program_details").scrollTop(0),$("#automationprograms_program_parameters").scrollTop(0),$("#automationprograms_program_options").popup("open",{transition:"slidedown"}),$.mobile.loading("hide")})}))},e.GetProgramByAddress=function(e){var t=null;for(i=0;i<HG.WebApp.Data.Programs.length;i++)if(HG.WebApp.Data.Programs[i].Address==e){t=HG.WebApp.Data.Programs[i];break}return t},e.GetProgramStatusColor=function(e){var t="black",o="",a="undefined"!=typeof e.Type&&"wizard"!=e.Type.toLowerCase()&&"undefined"!=typeof e.ScriptErrors&&""!=e.ScriptErrors.trim()&&"[]"!=e.ScriptErrors.trim(),i=HG.WebApp.Utility.GetModuleByDomainAddress("HomeAutomation.HomeGenie.Automation",e.Address);if(null!=i){var r=HG.WebApp.Utility.GetModulePropertyByName(i,"Program.Status");null!=r&&(o=r.Value)}return"Running"==o?t="green":"Background"==o?t="blue":e.IsEnabled?t=a?"red":"yellow":a&&(t="brown"),t},e.EditProgram=function(){null==editor1&&(editor1=CodeMirror.fromTextArea(document.getElementById("automation_program_scriptsetup"),{lineNumbers:!0,matchBrackets:!0,autoCloseBrackets:!0,extraKeys:{"Ctrl-S":function(){HG.WebApp.ProgramEdit.SaveProgram()},"Ctrl-Q":function(e){e.foldCode(e.getCursor())},"Ctrl-Space":"autocomplete"},foldGutter:!0,gutters:["CodeMirror-lint-markers-1","CodeMirror-linenumbers","CodeMirror-foldgutter"],highlightSelectionMatches:{showToken:/\w/},mode:{globalVars:!0},theme:"ambiance"}),editor2=CodeMirror.fromTextArea(document.getElementById("automation_program_scriptsource"),{lineNumbers:!0,matchBrackets:!0,autoCloseBrackets:!0,extraKeys:{"Ctrl-S":function(){HG.WebApp.ProgramEdit.SaveProgram()},"Ctrl-Q":function(e){e.foldCode(e.getCursor())},"Ctrl-Space":"autocomplete"},foldGutter:!0,gutters:["CodeMirror-lint-markers-2","CodeMirror-linenumbers","CodeMirror-foldgutter"],highlightSelectionMatches:{showToken:/\w/},mode:{globalVars:!0},theme:"ambiance"}),editor3=CodeMirror.fromTextArea(document.getElementById("automation_program_sketchfile"),{lineNumbers:!0,matchBrackets:!0,autoCloseBrackets:!0,extraKeys:{"Ctrl-S":function(){HG.WebApp.ProgramEdit.SaveProgram()},"Ctrl-Q":function(e){e.foldCode(e.getCursor())},"Ctrl-Space":"autocomplete"},foldGutter:!0,gutters:["CodeMirror-lint-markers-3","CodeMirror-linenumbers","CodeMirror-foldgutter"],highlightSelectionMatches:{showToken:/\w/},mode:{globalVars:!0},theme:"ambiance"}),$(editor3.getWrapperElement()).hide()),$("#automation_programgroup").empty(),$("#automation_programgroup").append('<option value="">(select program group)</option>');for(var t=0;t<HG.WebApp.Data.AutomationGroups.length;t++)$("#automation_programgroup").append('<option value="'+HG.WebApp.Data.AutomationGroups[t].Name+'">'+HG.WebApp.Data.AutomationGroups[t].Name+"</option>");for($("#automation_programgroup").trigger("create"),t=0;t<HG.WebApp.Data.Programs.length;t++)if(HG.WebApp.Data.Programs[t].Address==HG.WebApp.ProgramEdit._CurrentProgram.Address){switch(HG.WebApp.ProgramEdit._CurrentProgram.Type=HG.WebApp.Data.Programs[t].Type,HG.WebApp.ProgramEdit._CurrentProgram.Group=HG.WebApp.Data.Programs[t].Group,HG.WebApp.ProgramEdit._CurrentProgram.Name=HG.WebApp.Data.Programs[t].Name,HG.WebApp.ProgramEdit._CurrentProgram.Description=HG.WebApp.Data.Programs[t].Description,HG.WebApp.ProgramEdit._CurrentProgram.Address=HG.WebApp.Data.Programs[t].Address,HG.WebApp.ProgramEdit._CurrentProgram.Domain=HG.WebApp.Data.Programs[t].Domain,HG.WebApp.ProgramEdit._CurrentProgram.IsEnabled=HG.WebApp.Data.Programs[t].IsEnabled,HG.WebApp.ProgramEdit._CurrentProgram.Conditions=HG.WebApp.Data.Programs[t].Conditions,HG.WebApp.ProgramEdit._CurrentProgram.Commands=HG.WebApp.Data.Programs[t].Commands,$("#automation_programname").val(HG.WebApp.ProgramEdit._CurrentProgram.Name),$("#automation_programdescription").val(HG.WebApp.ProgramEdit._CurrentProgram.Description),$("#automation_programgroup").val(HG.WebApp.ProgramEdit._CurrentProgram.Group),$("#automation_programgroup").selectmenu().selectmenu("refresh"),HG.WebApp.ProgramEdit._CurrentProgram.ScriptCondition=HG.WebApp.Data.Programs[t].ScriptCondition,HG.WebApp.ProgramEdit._CurrentProgram.ScriptSource=HG.WebApp.Data.Programs[t].ScriptSource,$("#automation_programtype").val(HG.WebApp.ProgramEdit._CurrentProgram.Type),$("#automation_programtype").selectmenu().selectmenu("refresh"),e.RefreshProgramType(),editor1.setValue(HG.WebApp.ProgramEdit._CurrentProgram.ScriptCondition),editor2.setValue(HG.WebApp.ProgramEdit._CurrentProgram.ScriptSource),editor1.clearHistory(),editor1.markClean(),editor2.clearHistory(),editor2.markClean(),editor3.clearHistory(),editor3.markClean(),HG.WebApp.ProgramEdit._CurrentProgram.ConditionType=HG.WebApp.Data.Programs[t].ConditionType,HG.WebApp.ProgramEdit._CurrentProgram.ConditionType){case 2:HG.WebApp.ProgramEdit._CurrentProgram.ConditionType="OnSwitchFalse";break;case 3:HG.WebApp.ProgramEdit._CurrentProgram.ConditionType="Once";break;case 4:HG.WebApp.ProgramEdit._CurrentProgram.ConditionType="OnTrue";break;case 5:HG.WebApp.ProgramEdit._CurrentProgram.ConditionType="OnFalse";break;default:HG.WebApp.ProgramEdit._CurrentProgram.ConditionType="OnSwitchTrue"}$("#automation_conditiontype").val(HG.WebApp.ProgramEdit._CurrentProgram.ConditionType),$("#automation_conditiontype").selectmenu(),$("#automation_conditiontype").selectmenu("refresh"),HG.WebApp.ProgramEdit._CurrentProgram.ScriptErrors=HG.WebApp.Data.Programs[t].ScriptErrors,HG.WebApp.ProgramEdit.RefreshProgramOptions();break}},e.ExportProgram=function(e){$("#program_import_downloadframe").attr("src",location.protocol+"../../api/HomeAutomation.HomeGenie/Automation/Programs.Export/"+e+"/")},e.RestartProgram=function(t){$("#automationprograms_program_options").popup("close"),$.mobile.loading("show"),$("#control_groupslist").empty(),$.ajax({url:"/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Automation/Programs.Restart/"+t+"/",type:"GET",success:function(){$.mobile.loading("hide"),e.LoadPrograms(null)},error:function(){$.mobile.loading("hide")}})},e.AddProgram=function(t){HG.Automation.Programs.AddProgram(HG.WebApp.AutomationGroupsList._CurrentGroup,t,function(t){e.LoadPrograms(function(){HG.WebApp.ProgramEdit._CurrentProgram.Address=t,e.EditProgram(),$.mobile.changePage($("#page_automation_editprogram"),{transition:"fade",changeHash:!0})})})},e.ToggleProgramIsEnabled=function(t){var o=HG.WebApp.Utility.GetProgramByAddress(t);o.IsEnabled=!o.IsEnabled,$.mobile.loading("show"),HG.WebApp.ProgramEdit.ProgramEnable(o.Address,o.IsEnabled),setTimeout(function(){e.LoadPrograms(function(){e.RefreshPrograms(),$.mobile.loading("hide")})},3e3)},e.DeleteGroup=function(e){$.mobile.loading("show"),HG.Configure.Groups.DeleteGroup("Automation",e,function(){$.mobile.loading("hide"),setTimeout(function(){$.mobile.changePage($("#"+HG.WebApp.AutomationGroupsList.PageId),{transition:"fade",changeHash:!0})},200)})},e.DeleteProgram=function(t){$.mobile.loading("show"),HG.Automation.Programs.DeleteProgram(t,function(){e.LoadPrograms(),$.mobile.loading("hide")})}},HG.WebApp.ProgramEdit=HG.WebApp.ProgramEdit||new function(){var $$=this;$$.PageId="page_automation_editprogram",$$._CurrentProgram=Array(),$$._CurrentProgram.Name="New Program",$$._CurrentProgram.Conditions=Array(),$$._CurrentProgram.Commands=Array(),$$._CurrentSketchFile="",$$._CurrentErrors=[],$$._IsCapturingConditions=!1,$$._IsCapturingCommands=!1,$$._SavePromptCallback=null,$$._CurrentTab=1,$$.InitializePage=function(){var e=$("#"+$$.PageId);e.on("pagehide",function(){$("[data-ui-field=homegenie_panel_button]").removeClass("ui-disabled")}),e.on("pageshow",function(){$("[data-ui-field=homegenie_panel_button]").addClass("ui-disabled")}),e.on("pagebeforeshow",function(){$("#automation_program_scriptcondition").next().css("display",""),$("#automation_program_scriptsource").next().css("display",""),$$.SetTab(1),$$.RefreshProgramEditorTitle(),automationpage_ConditionsRefresh(),automationpage_CommandsRefresh()}),e.on("pageinit",function(){"Win"==HOST_SYSTEM.substring(0,3)&&$("#automation_programtype_option_arduino").hide(),$("#program_delete_button").bind("click",function(){return $$.DeleteProgram($$._CurrentProgram.Address),!0}),$("#editprograms_backbutton").on("click",function(){return $$.CheckIsClean(function(){$.mobile.pageContainer.pagecontainer("change","#page_automation_programs")}),!1}),$("#editprograms_homebutton").on("click",function(){return $$.CheckIsClean(function(){$.mobile.pageContainer.pagecontainer("change","#page_control")}),!1}),$("#program_notsaved_save").on("click",function(){return $$.SaveProgram(function(){$$._SavePromptCallback()}),!1}),$("#program_notsaved_dontsave").on("click",function(){return $$._SavePromptCallback(),!1}),$("#automation_program_delete_button").bind("click",function(){return HG.Ui.SwitchPopup("#editprograms_actionmenu","#automation_program_delete"),!0}),$("#configure_program_editorcompilecode").bind("click",function(){return $$.CompileProgram(),!0}),$("#configure_program_editorcompilecode2").bind("click",function(){return $$.CompileProgram(),!0}),$("#editprograms_actionmenu").on("popupbeforeposition",function(){$$.RefreshProgramOptions()}),$("#editprograms_code_actionmenu").on("popupbeforeposition",function(){$$.RefreshProgramOptions()}),$("#automation_capture_condition_popup").popup().on("popupbeforeposition",function(){$$._IsCapturingConditions=!0}),$("#automation_capture_condition_popup").popup().on("popupafterclose",function(){$$._IsCapturingConditions=!1}),$("#automation_capture_command_popup").popup().on("popupbeforeposition",function(){$$._IsCapturingCommands=!0}),$("#automation_capture_command_popup").popup().on("popupafterclose",function(){$$._IsCapturingCommands=!1}),$("#automation_domain").on("popupbeforeposition",function(){$("#automation_conditiontarget li:gt(0)").remove();for(var e=Array(),t=0;t<HG.WebApp.Data.Modules.length;t++){for(var o=!1,a=0;a<e.length;a++)if(e[a]==HG.WebApp.Data.Modules[t].Domain){o=!0;break}if(!o){if(e.push(HG.WebApp.Data.Modules[t].Domain),0==$$.GetDomainComparableModules(HG.WebApp.Data.Modules[t].Domain,!1).length)continue;var i=HG.WebApp.Data.Modules[t].Domain.substring(HG.WebApp.Data.Modules[t].Domain.lastIndexOf(".")+1);"Automation"==i&&(i="Programs"),$("#automation_conditiontarget").append('<li data-context-value="'+HG.WebApp.Data.Modules[t].Domain+'"><a data-rel="popup" href="#automation_target_popup">'+i+"</a></li>")}}$("#automation_conditiontarget").listview("refresh")}),$("#automation_condition_value_domain").on("popupbeforeposition",function(){$("#automation_conditionvalue_domain").empty();for(var e=Array(),t=0;t<HG.WebApp.Data.Modules.length;t++){for(var o=!1,a=0;a<e.length;a++)if(e[a]==HG.WebApp.Data.Modules[t].Domain){o=!0;break}if(!o){if(e.push(HG.WebApp.Data.Modules[t].Domain),0==$$.GetDomainComparableModules(HG.WebApp.Data.Modules[t].Domain,!1).length)continue;var i=HG.WebApp.Data.Modules[t].Domain.substring(HG.WebApp.Data.Modules[t].Domain.lastIndexOf(".")+1);"Automation"==i&&(i="Programs"),$("#automation_conditionvalue_domain").append('<li data-context-value="'+HG.WebApp.Data.Modules[t].Domain+'"><a data-rel="popup" href="#automation_condition_value_address">'+i+"</a></li>")}}$("#automation_conditionvalue_domain").listview("refresh")}),$("#automation_command_domain_popup").on("popupbeforeposition",function(){$("#automation_commandtarget li:gt(1)").remove();for(var e=Array(),t=0;t<HG.WebApp.Data.Modules.length;t++){for(var o=!1,a=0;a<e.length;a++)if(e[a]==HG.WebApp.Data.Modules[t].Domain){o=!0;break}if(!o){if(e.push(HG.WebApp.Data.Modules[t].Domain),0==$$.GetDomainControllableModules(HG.WebApp.Data.Modules[t].Domain,!1).length)continue;var i=HG.WebApp.Data.Modules[t].Domain.substring(HG.WebApp.Data.Modules[t].Domain.lastIndexOf(".")+1);$("#automation_commandtarget").append('<li data-context-value="'+HG.WebApp.Data.Modules[t].Domain+'"><a data-rel="popup" href="#automation_command_target_popup">'+i+"</a></li>")}}$("#automation_commandtarget").listview("refresh")}),$("#automation_program_listfiles").on("popupbeforeposition",function(){$$.SketchFileList()}),$("#automation_program_sketchfiles_add").bind("click",function(){$("#programfile_new_name").val(""),HG.Ui.SwitchPopup("#automation_program_listfiles","#automation_program_fileadd",!0)}),$("#programfile_new_button").bind("click",function(){$("#automation_program_fileadd").popup("close");var e=$("#programfile_new_name").val();$.mobile.loading("show",{text:"Adding file "+e,textVisible:!0,theme:"a",html:""}),HG.Automation.Programs.ArduinoFileAdd($$._CurrentProgram.Address,e,function(t){"EXISTS"==t?($.mobile.loading("show",{text:'A file named "'+e+'" already exists',textVisible:!0,theme:"a",html:""}),setTimeout(function(){$.mobile.loading("hide")},3e3)):"INVALID_NAME"==t?($.mobile.loading("show",{text:'Invalid file name "'+e+'". Must ends with .c, .cpp, .h or have no extension.',textVisible:!0,theme:"a",html:""}),setTimeout(function(){$.mobile.loading("hide")},3e3)):($.mobile.loading("hide"),$$.SketchFileOpen(e))})}),$("#automation_program_sketchfiles_edit").bind("click",function(){$("#automation_program_listfiles").popup("close");var e=$("#automation_program_sketchfiles li a.ui-btn-active").attr("data-context-value");$$.SketchFileOpen(e)}),$("#automation_program_sketchfiles_delete").bind("click",function(){var e=$("#automation_program_sketchfiles li a.ui-btn-active").attr("data-context-value");$.mobile.loading("show",{text:"Deleting file "+e,textVisible:!0,theme:"a",html:""}),HG.Automation.Programs.ArduinoFileDelete($$._CurrentProgram.Address,e,function(){$$.SketchFileList(),e==$$._CurrentSketchFile&&$$.SketchFileOpen("main"),$.mobile.loading("hide")})})})},$$.CheckIsClean=function(e){$$.IsClean()?e():($$._SavePromptCallback=function(){e()},$("#automation_program_notsaved").popup("open"))},$$.IsClean=function(){var e=$$._CurrentProgram.Group==$("#automation_programgroup").val();return e=e&&$$._CurrentProgram.Name==$("#automation_programname").val(),e=e&&$$._CurrentProgram.Description==$("#automation_programdescription").val(),e=e&&$$._CurrentProgram.ConditionType==$("#automation_conditiontype").val(),e=e&&editor1.isClean()&&editor2.isClean()&&editor3.isClean()},$$.GetDomainControllableModules=function(e,t){var o=Array();if(HG.WebApp.Data.Modules&&HG.WebApp.Data.Modules.length)for(m=0;m<HG.WebApp.Data.Modules.length;m++)HG.WebApp.Data.Modules[m].Domain==e&&($$.IsModuleControllable(HG.WebApp.Data.Modules[m])||t)&&o.push(HG.WebApp.Data.Modules[m]);return o},$$.IsModuleControllable=function(e){return"Generic"!=e.DeviceType&&"Sensor"!=e.DeviceType&&"DoorWindow"!=e.DeviceType&&"Temperature"!=e.DeviceType},$$.GetDomainComparableModules=function(e,t){var o=Array();if(HG.WebApp.Data.Modules&&HG.WebApp.Data.Modules.length)for(m=0;m<HG.WebApp.Data.Modules.length;m++)HG.WebApp.Data.Modules[m].Domain==e&&($$.GetModuleComparableProperties(HG.WebApp.Data.Modules[m]).length>0||t)&&o.push(HG.WebApp.Data.Modules[m]);return o},$$.GetModuleComparableProperties=function(e){for(var t=Array(),o=0;o<e.Properties.length;o++){var a=e.Properties[o];"ConfigureOptions."!=a.Name.substring(0,17)&&"VirtualModule."!=a.Name.substring(0,14)&&"Widget."!=a.Name.substring(0,7)&&t.push(a)}return t},$$.RefreshProgramEditorTitle=function(){var e="wizard";if("undefined"!=typeof $$._CurrentProgram.Type&&(e=$$._CurrentProgram.Type.toLowerCase()),"wizard"!=e){var t=$$._CurrentProgram.ScriptErrors;"undefined"!=typeof t&&""!=t.trim()&&"[]"!=t.trim()?$$.ShowProgramErrors(t):$$.HideProgramErrors()}else $$.HideProgramErrors();var o=$$.GetProgramStatusColor($$._CurrentProgram),a='<img src="images/common/led_'+o+'.png" style="width:24px;height:24px;vertical-align:middle;margin-bottom:5px;margin-right:5px;" /> ';$("#page_automation_program_title").html('<span style="font-size:9pt;font-weight:bold">PROGRAM EDITOR ('+e+")</span><br />"+a+$$._CurrentProgram.Address+" "+$$._CurrentProgram.Name)},$$.GetProgramStatusColor=function(e){var t="black",o="",a="undefined"!=typeof e.Type&&"wizard"!=e.Type.toLowerCase()&&"undefined"!=typeof e.ScriptErrors&&""!=e.ScriptErrors.trim()&&"[]"!=e.ScriptErrors.trim(),i=HG.WebApp.Utility.GetModuleByDomainAddress("HomeAutomation.HomeGenie.Automation",e.Address);if(null!=i){var r=HG.WebApp.Utility.GetModulePropertyByName(i,"Program.Status");null!=r&&(o=r.Value)}return"Running"==o?t="green":"Background"==o?t="blue":e.IsEnabled?t=a?"red":"yellow":a&&(t="brown"),t},$$.RefreshProgramOptions=function(){$("[id=editprograms_actionmenu_run]").each(function(){$(this).show()}),$("[id=editprograms_actionmenu_break]").each(function(){$(this).hide()}),$("[id=editprograms_actionmenu_run]").each(function(){$(this).addClass("ui-disabled")}),$("[id=editprograms_actionmenu_compile]").each(function(){$(this).addClass("ui-disabled")}),setTimeout(function(){HG.Automation.Programs.List(function(){$("[id=editprograms_actionmenu_compile]").each(function(){$(this).removeClass("ui-disabled")}),$("[id=editprograms_actionmenu_run]").each(function(){$(this).removeClass("ui-disabled")}),$("[id=editprograms_actionmenu_run]").each(function(){$(this).hide()});var e=HG.WebApp.Utility.GetProgramByAddress($$._CurrentProgram.Address);null!=e&&(e.IsRunning?$("[id=editprograms_actionmenu_break]").each(function(){$(this).show()}):$("[id=editprograms_actionmenu_run]").each(function(){$(this).show()}),""!=e.ScriptErrors.trim()&&"[]"!=e.ScriptErrors.trim()?$$._CurrentProgram.ScriptErrors=e.ScriptErrors:$$._CurrentProgram.ScriptErrors="",$$.RefreshProgramEditorTitle())})},500)},$$.ProgramEnable=function(e,t){var o=t?"Enable":"Disable",a=t?"Enabling":"Disabling";$.mobile.loading("show",{text:a+" program",textVisible:!0,theme:"a",html:""}),$("#control_groupslist").empty(),$.ajax({url:"/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Automation/Programs."+o+"/"+e+"/",type:"GET",success:function(){$.mobile.loading("hide")},error:function(){$.mobile.loading("hide")}})},$$.UpdateProgram=function(e,t,o){$("#configure_program_editorcompilecode").addClass("ui-disabled"),$("#configure_program_editorcompilecode2").addClass("ui-disabled"),$.mobile.loading("show",{text:HG.WebApp.Locales.GetLocaleString("configure_editprogram_saving"),textVisible:!0,theme:"a",html:""}),$("#control_groupslist").empty(),$.ajax({type:"POST",url:"/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Automation/Programs."+(t?"Compile":"Update")+"/",dataType:"text",data:JSON.stringify(e),success:function(e){$.mobile.loading("hide"),editor1.markClean(),editor2.markClean(),$("#configure_program_editorcompilecode").removeClass("ui-disabled"),$("#configure_program_editorcompilecode2").removeClass("ui-disabled"),""!=e.trim()&&"[]"!=e.trim()?($.mobile.loading("show",{text:HG.WebApp.Locales.GetLocaleString("configure_editprogram_error_updating"),textVisible:!0}),$$.ShowProgramErrors(e)):($.mobile.loading("show",{text:HG.WebApp.Locales.GetLocaleString("configure_editprogram_saving_succeed"),textVisible:!0}),$$.RefreshProgramEditorTitle()),setTimeout(function(){$.mobile.loading("hide"),null!=o&&"undefined"!=typeof o&&o()},2e3),setTimeout(function(){HG.Configure.Modules.List(function(e){try{HG.WebApp.Data.Modules=e}catch(t){}})},3e3)},error:function(){$.mobile.loading("hide"),$("#configure_program_editorcompilecode").removeClass("ui-disabled"),$("#configure_program_editorcompilecode2").removeClass("ui-disabled"),$.mobile.loading("show",{text:"An error occurred!",textVisible:!0}),setTimeout(function(){$.mobile.loading("hide")},5e3)}})},$$.JumpToLine=function(e,t){var o="TC"==e?editor1:editor2;"TC"==e?$$.SetTab(3):($$.SketchFileOpen("main"),$$.SetTab(2)),window.setTimeout(function(){o.setCursor(t);var e=o.getScrollInfo().clientHeight,a=o.charCoords(t,"local");o.scrollTo(null,(a.top+a.bottom-e)/2),o.focus()},500)},$$.ShowProgramErrors=function(message){if($$._CurrentErrors=[],editor1.clearGutter("CodeMirror-lint-markers-1"),editor2.clearGutter("CodeMirror-lint-markers-2"),editor3.clearGutter("CodeMirror-lint-markers-3"),$$._CurrentProgram.ScriptErrors=message,""!=message){for(i=0;i<HG.WebApp.Data.Programs.length;i++)if(HG.WebApp.Data.Programs[i].Address==$$._CurrentProgram.Address){HG.WebApp.Data.Programs[i].ScriptErrors=message;break}var errors=null;try{errors=eval(message)}catch(e){}if(null!=errors){$$._CurrentErrors=errors;for(var currentLine=0,currentBlock="",marker=null,message="",popupMessage="",e=0;e<$$._CurrentErrors.length;e++){var err=$$._CurrentErrors[e];err.Line>0&&(currentLine==err.Line&&currentBlock==err.CodeBlock||(null!=marker&&($(marker).qtip({content:{title:"Error",text:message,button:"Close"},show:{event:"mouseover",solo:!0},hide:"mouseout",style:{classes:"qtip-red qtip-shadow qtip-rounded qtip-bootstrap"}}),message=""),marker=document.createElement("div"),marker.className="CodeMirror-lint-marker-error","TC"==err.CodeBlock?editor1.setGutterMarker(err.Line-1,"CodeMirror-lint-markers-1",marker):editor2.setGutterMarker(err.Line-1,"CodeMirror-lint-markers-2",marker),currentLine=err.Line,currentBlock=err.CodeBlock),message+="<b>("+err.Line+","+err.Column+"):</b> "+err.ErrorMessage+"</br>",popupMessage+="<b><a href=\"javascript:HG.WebApp.ProgramEdit.JumpToLine('"+err.CodeBlock+"', { line: "+(err.Line-1)+", ch: "+(err.Column-1)+' })">Line '+err.Line+", Column "+err.Column+'</a></b> (<font style="color:'+("TC"==err.CodeBlock?'yellow">Trigger':'lime">Code')+"</font>):<br/>"),popupMessage+="&nbsp;&nbsp;&nbsp;&nbsp;<em>"+err.ErrorMessage.replace(/\n/g,"</br>&nbsp;&nbsp;&nbsp;&nbsp;")+"</em><br /><br />"}null!=marker&&$(marker).qtip({content:{title:"Error",text:message,button:"Close"},show:{event:"mouseover",solo:!0},hide:"mouseout",style:{classes:"qtip-red qtip-shadow qtip-rounded qtip-bootstrap"}}),$$.ShowExternalErrors(),""!=popupMessage?($("#program_error_button").show(),$("#program_error_button2").show(),$("#program_error_button").qtip({content:{title:"Error",text:popupMessage,button:"Close"},show:{event:"mouseover",ready:2==$$._CurrentTab,delay:500},hide:{event:!1,inactive:5e3},style:{classes:"qtip-red qtip-shadow qtip-rounded qtip-bootstrap"},position:{adjust:{screen:!0},my:"top center",at:"bottom center"}}),$("#program_error_button2").qtip({content:{title:"Error",text:popupMessage,button:"Close"},show:{event:"mouseover",ready:3==$$._CurrentTab,delay:500},hide:{event:!1,inactive:5e3},style:{classes:"qtip-red qtip-shadow qtip-rounded qtip-bootstrap"},position:{adjust:{screen:!0},my:"top center",at:"bottom center"}})):($("#program_error_button").hide(),$("#program_error_button2").hide())}else $$._CurrentErrors=[];$$.RefreshCodeMirror()}},$$.ShowExternalErrors=function(){editor3.clearGutter("CodeMirror-lint-markers-3");for(var e=0,t="",o=null,a="",i=0;i<$$._CurrentErrors.length;i++)for(var r=$$._CurrentErrors[i].ErrorMessage.split("\n"),n=0;n<r.length;n++){var s=r[n],l=s.split(":");l.length>3&&l[0]==$$._CurrentSketchFile&&$.isNumeric(l[1])&&$.isNumeric(l[2])&&(e==l[1]&&t==s.CodeBlock||(null!=o&&($(o).qtip({content:{title:"Error",text:a,button:"Close"},show:{event:"mouseover",solo:!0},hide:"mouseout",style:{classes:"qtip-red qtip-shadow qtip-rounded qtip-bootstrap"}}),a=""),o=document.createElement("div"),o.className="CodeMirror-lint-marker-error",editor3.setGutterMarker(l[1]-1,"CodeMirror-lint-markers-3",o),e=l[1],t=s.CodeBlock),a+=s+"</br>")}null!=o&&$(o).qtip({content:{title:"Error",text:a,button:"Close"},show:{event:"mouseover",solo:!0},hide:"mouseout",style:{classes:"qtip-red qtip-shadow qtip-rounded qtip-bootstrap"}})},$$.HideProgramErrors=function(){$$._CurrentErrors=[],null!=editor1&&editor1.clearGutter("CodeMirror-lint-markers-1"),null!=editor2&&editor2.clearGutter("CodeMirror-lint-markers-2"),null!=editor3&&editor3.clearGutter("CodeMirror-lint-markers-3"),$("#program_error_button").hide(),$("#program_error_button2").hide(),$(".qtip").hide(),$$.RefreshCodeMirror()},$$.RefreshCodeMirror=function(){setTimeout(function(){null!=editor1&&editor1.refresh(),null!=editor2&&editor2.refresh(),null!=editor3&&editor3.refresh()},500)},$$.CompileProgram=function(){$$.HideProgramErrors();var e=$$.SetProgramData();"arduino"==$$._CurrentProgram.Type.toLowerCase()?$$.SketchFileSave(function(){$$.UpdateProgram(e,!0)}):$$.UpdateProgram(e,!0)},$$.SaveProgram=function(e){$("#program_error_button").hide(),$("#program_error_button2").hide();var t=$$.SetProgramData();"arduino"==$$._CurrentProgram.Type.toLowerCase()?$$.SketchFileSave(function(){$$.UpdateProgram(t,!1,e)}):$$.UpdateProgram(t,!0,e)},$$.SetProgramData=function(){HG.WebApp.AutomationGroupsList._CurrentGroup=$("#automation_programgroup").val(),$$._CurrentProgram.Group=$("#automation_programgroup").val(),$$._CurrentProgram.Name=$("#automation_programname").val(),$$._CurrentProgram.Description=$("#automation_programdescription").val(),$$._CurrentProgram.ScriptCondition=editor1.getValue(),$$._CurrentProgram.ScriptSource=editor2.getValue(),$$._CurrentProgram.ScriptErrors="",$$._CurrentProgram.ConditionType=$("#automation_conditiontype").val();var e={Address:$$._CurrentProgram.Address,Type:$$._CurrentProgram.Type,Group:$$._CurrentProgram.Group,Name:$$._CurrentProgram.Name,Description:$$._CurrentProgram.Description,IsEnabled:$$._CurrentProgram.IsEnabled,ScriptCondition:$$._CurrentProgram.ScriptCondition,ScriptSource:$$._CurrentProgram.ScriptSource,ConditionType:$$._CurrentProgram.ConditionType,Conditions:$$._CurrentProgram.Conditions,Commands:$$._CurrentProgram.Commands};return e},$$.CheckAndRunProgram=function(e){$$._CurrentProgram.ScriptCondition=editor1.getValue(),$$._CurrentProgram.ScriptSource=editor2.getValue(),$$._CurrentProgram.ConditionType=$("#automation_conditiontype").val(),$$.IsClean()?$$.RunProgram(e.Address,null):$$.SaveProgram(function(){$$.RunProgram(e.Address,null)})},$$.BreakProgram=function(e){$.mobile.loading("show",{text:"Stopping program",textVisible:!0,theme:"a",html:""}),$.ajax({url:"/"+HG.WebApp.Data.ServiceKey+"/"+HG.WebApp.Data.ServiceDomain+"/Automation/Programs.Break/"+e+"/",type:"GET",success:function(){$$.RefreshProgramOptions(),$.mobile.loading("hide")},error:function(){$.mobile.loading("hide")}})},$$.RunProgram=function(e,t){$$._CurrentProgram.ScriptCondition=editor1.getValue(),$$._CurrentProgram.ScriptSource=editor2.getValue(),$$._CurrentProgram.ConditionType=$("#automation_conditiontype").val(),$.mobile.loading("show",{text:"Running program",textVisible:!0,theme:"a",html:""}),HG.Automation.Programs.Run(e,t,function(e){null!=e&&$$.RefreshProgramOptions(),$.mobile.loading("hide")})},$$.DeleteProgram=function(e){$.mobile.loading("show",{text:"Deleting program",textVisible:!0,theme:"a",html:""}),HG.Automation.Programs.DeleteProgram(e,function(){$.mobile.loading("hide"),setTimeout(function(){$.mobile.changePage($("#page_automation_programs"),{transition:"fade",changeHash:!0})},200)})},$$.SetTab=function(e){$$._CurrentTab=e,$("#program_edit_tab1").hide(),$("#program_edit_tab2").hide(),$("#program_edit_tab3").hide(),$("#program_edit_tab1_button").removeClass("ui-btn-active"),$("#program_edit_tab2_button").removeClass("ui-btn-active"),$("#program_edit_tab3_button").removeClass("ui-btn-active"),$("#program_edit_tab"+e).show(),$("#program_edit_tab"+e+"_button").addClass("ui-btn-active"),$$.RefreshCodeMirror()},$$.SketchFileSelect=function(e){$("#automation_program_sketchfiles li a").removeClass("ui-btn-active"),
$(e).addClass("ui-btn-active"),$("#automation_program_sketchfiles_edit").removeClass("ui-disabled"),$("#automation_program_sketchfiles_delete").addClass("ui-disabled"),"main"!=$(e).attr("data-context-value")&&$("#automation_program_sketchfiles_delete").removeClass("ui-disabled")},$$.SketchFileOpen=function(e){$$.SketchFileSave(function(){$.mobile.loading("show",{text:"Opening file "+e,textVisible:!0,theme:"a",html:""}),null==e||"undefined"==typeof e||""==e||"main"==e?($$._CurrentSketchFile="",$("#configure_program_editorfilename").html(e),$(editor3.getWrapperElement()).hide(),$(editor2.getWrapperElement()).show(),editor2.clearHistory(),editor2.markClean(),editor2.refresh(),$.mobile.loading("hide")):($(editor2.getWrapperElement()).hide(),$(editor3.getWrapperElement()).show(),HG.Automation.Programs.ArduinoFileLoad($$._CurrentProgram.Address,e,function(t){$$._CurrentSketchFile=e,$("#configure_program_editorfilename").html(e),editor3.setValue(t),editor3.clearHistory(),editor3.markClean(),editor3.refresh(),$$.ShowExternalErrors(),$.mobile.loading("hide")}))})},$$.SketchFileSave=function(e){if(""==$$._CurrentSketchFile)return void(null!=e&&e());$.mobile.loading("show",{text:"Saving file "+$$._CurrentSketchFile,textVisible:!0,theme:"a",html:""});var t=editor3.getValue();HG.Automation.Programs.ArduinoFileSave($$._CurrentProgram.Address,$$._CurrentSketchFile,t,function(){$.mobile.loading("hide"),null!=e&&e()})},$$.SketchFileList=function(){$("#automation_program_sketchfiles_edit").addClass("ui-disabled"),$("#automation_program_sketchfiles_delete").addClass("ui-disabled"),HG.Automation.Programs.ArduinoFileList($$._CurrentProgram.Address,function(e){if($("#automation_program_sketchfiles").empty(),$("#automation_program_sketchfiles").append('<li data-icon="false"><a ondblclick="HG.WebApp.ProgramEdit.SketchFileOpen(\'main\');$(\'#automation_program_listfiles\').popup(\'close\');" onclick="HG.WebApp.ProgramEdit.SketchFileSelect(this)" href="#" data-context-value="main"><strong>Main Sketch Code</strong></a></li>'),"undefined"!=typeof e&&null!=e)for(var t=0;t<e.length;t++)$("#automation_program_sketchfiles").append('<li data-icon="false"><a data-context-value="'+e[t]+'" ondblclick="HG.WebApp.ProgramEdit.SketchFileOpen(\''+e[t]+"');$('#automation_program_listfiles').popup('close');\" onclick=\"HG.WebApp.ProgramEdit.SketchFileSelect(this)\" href=\"#\">"+e[t]+"</a></li>");$("#automation_program_sketchfiles").listview("refresh")})}},HG.WebApp.WidgetsList=HG.WebApp.WidgetsList||new function(){var e=this;e.PageId="page_configure_widgetlist",e._currentWidget="",e.InitializePage=function(){var t=$("#"+e.PageId),o=t.find("[data-ui-field=import-popup]"),a=t.find("[data-ui-field=import-btn]"),i=t.find("[data-ui-field=import-form]"),r=t.find("[data-ui-field=upload-btn]"),n=t.find("[data-ui-field=upload-file]"),s=t.find("[data-ui-field=upload-frame]"),l=t.find("[data-ui-field=addconfirm-btn]"),d=t.find("[data-ui-field=addnew-btn]"),p=t.find("[data-ui-field=widgetadd-popup]"),u=t.find("[data-ui-field=widgetbrand-txt]"),c=t.find("[data-ui-field=widgetcategory-txt]"),m=t.find("[data-ui-field=widgetname-txt]");t.on("pageinit",function(){o.popup(),p.popup()}),t.on("pagebeforeshow",function(){HG.Configure.Modules.List(function(e){try{HG.WebApp.Data.Modules=e}catch(t){}}),e.LoadWidgets()}),d.bind("click",function(){u.val(""),c.val(""),m.val(""),HG.Ui.SwitchPopup("#widgetlist_actionmenu",p)}),l.bind("click",function(){var t=u.val()+"/"+c.val()+"/"+m.val();return HG.Configure.Widgets.Add(t,function(o){"Ok"==o.Status?(e._currentWidget=t,$.mobile.pageContainer.pagecontainer("change","#"+HG.WebApp.WidgetEditor.PageId)):alert("Error adding widget")}),!1}),a.bind("click",function(){HG.Ui.SwitchPopup("#widgetlist_actionmenu",o)}),u.bind("keyup blur",function(){u.val(u.val().replace(/[^a-z,A-Z]/g,"").toLowerCase())}),c.bind("keyup blur",function(){c.val(c.val().replace(/[^a-z,A-Z]/g,"").toLowerCase())}),m.bind("keyup blur",function(){m.val(m.val().replace(/[^a-z,A-Z]/g,"").toLowerCase())}),r.bind("click",function(){""==n.val()?(alert("Select a file to import first"),n.parent().stop().animate({borderColor:"#FF5050"},250).animate({borderColor:"#FFFFFF"},250).animate({borderColor:"#FF5050"},250).animate({borderColor:"#FFFFFF"},250)):(a.removeClass("ui-btn-active"),o.popup("close"),$.mobile.loading("show",{text:"Importing, please wait...",textVisible:!0,html:""}),i.submit())}),s.bind("load",function(){$.mobile.loading("hide"),""!=n.val()&&(n.val(""),e.LoadWidgets())})},e.LoadWidgets=function(){$.mobile.loading("show"),HG.Configure.Widgets.List(function(t){e.RefreshList(t),$.mobile.loading("hide")})},e.RefreshList=function(t){var o=$("#"+e.PageId),a=o.find("[data-ui-field=group-list]");a.empty(),a.append('<li data-icon="false" data-role="list-divider">'+HG.WebApp.Locales.GetLocaleString("configure_widgetlist_list","Widget List")+"</li>");for(var i=0;i<t.length;i++)a.append('<li data-item-name="'+t[i]+'" data-item-index="'+i+'"><a href="#page_widgeteditor_editwidget"><img src="test" width="36" height="36" style="margin-left:7px;margin-top:2px" />'+t[i]+"</a></li>");a.listview(),a.listview("refresh");for(var i=0;i<t.length;i++)e.GetWidgetIcon(t[i],i,function(e,t){a.find("li a img").eq(t).attr("src",e)});a.find("li").on("click",function(){e._currentWidget=$(this).attr("data-item-name")})},e.GetWidgetIcon=function(e,t,o){HG.WebApp.Control.GetWidget(e,function(e){null!=e&&("undefined"!=typeof e.Instance.widget&&"undefined"!=typeof e.Instance.widget.icon?icon=e.Instance.widget.icon:icon=e.Instance.IconImage,null!=o&&o(icon,t))})},e.GroupsAdd=function(e){HG.Configure.Groups.AddGroup("Automation",e,function(){HG.WebApp.AutomationGroupsList.LoadGroups()})}},HG.WebApp.WidgetEditor=HG.WebApp.WidgetEditor||new function(){var $$=this;$$.PageId="page_widgeteditor_editwidget",$$._hasError=!1,$$._editorHtml=null,$$._editorJscript=null,$$._widgetInstance=null,$$.previewWidth=420,$$._splitDragStartX=0,$$._savePromptCallback=null,$$.InitializePage=function(){var e=$("#"+$$.PageId),t=e.find("[data-ui-field=preview-btn]"),o=e.find("[data-ui-field=bindmodule-sel]"),a=e.find("[data-ui-field=module-params-edit]"),i=e.find("[data-ui-field=errors-btn]"),r=e.find("[data-ui-field=save-btn]"),n=e.find("[data-ui-field=export-btn]"),s=e.find("[data-ui-field=delete-btn]"),l=e.find("[data-ui-field=deleteconfirm-btn]"),d=e.find("[data-ui-field=delete-popup]"),p=e.find("[data-ui-field=preview-panel]"),u=e.find("[data-ui-field=split-bar]"),c=e.find("[data-ui-field=back-btn]"),m=e.find("[data-ui-field=home-btn]"),g=e.find("[data-ui-field=notsaved-popup]"),f=e.find("[data-ui-field=saveconfirm-btn]"),b=e.find("[data-ui-field=savecancel-btn]");e.on("pagehide",function(){$("[data-ui-field=homegenie_panel_button]").removeClass("ui-disabled")}),e.on("pageshow",function(){$("[data-ui-field=homegenie_panel_button]").addClass("ui-disabled")}),e.on("pageinit",function(){$$._editorHtml=CodeMirror.fromTextArea(document.getElementById("widgeteditor_code_html"),{lineNumbers:!0,matchBrackets:!0,autoCloseBrackets:!0,extraKeys:{"Ctrl-S":function(){$$.SaveWidget(function(){$$._editorHtml.markClean(),$$._editorJscript.markClean()})},"Ctrl-Q":function(e){e.foldCode(e.getCursor())},"Ctrl-Space":"autocomplete"},foldGutter:!0,gutters:["CodeMirror-lint-markers-4","CodeMirror-linenumbers","CodeMirror-foldgutter"],highlightSelectionMatches:{showToken:/\w/},mode:"text/html",matchTags:{bothTags:!0},theme:"ambiance"}),$$._editorJscript=CodeMirror.fromTextArea(document.getElementById("widgeteditor_code_javascript"),{lineNumbers:!0,matchBrackets:!0,autoCloseBrackets:!0,extraKeys:{"Ctrl-S":function(){$$.SaveWidget(function(){$$._editorHtml.markClean(),$$._editorJscript.markClean()})},"Ctrl-Q":function(e){e.foldCode(e.getCursor())},"Ctrl-Space":"autocomplete"},foldGutter:!0,gutters:["CodeMirror-lint-markers-5","CodeMirror-linenumbers","CodeMirror-foldgutter"],highlightSelectionMatches:{showToken:/\w/},mode:"text/javascript",theme:"ambiance"}),d.popup(),g.popup()}),e.on("pagebeforeshow",function(){e.find("[data-ui-field=title-heading]").html('<span style="font-size:10pt;font-weight:bold">'+HG.WebApp.Locales.GetLocaleString("configure_widgeteditor_title",!1,this.Locale)+"</span><br/>"+HG.WebApp.WidgetsList._currentWidget),e.find(".CodeMirror").css("right",$$.previewWidth+5),u.css("right",$$.previewWidth),p.width($$.previewWidth),$.ajax({url:"/hg/html/pages/control/widgets/"+HG.WebApp.WidgetsList._currentWidget+".html",type:"GET",dataType:"text",success:function(e){$$._editorHtml.setValue(e),$$._editorHtml.clearHistory(),$$._editorHtml.markClean(),$.ajax({url:"/hg/html/pages/control/widgets/"+HG.WebApp.WidgetsList._currentWidget+".js",type:"GET",dataType:"text",success:function(e){$$._editorJscript.setValue(e),$$._editorJscript.clearHistory(),$$._editorJscript.markClean(),$$.RefreshCodeMirror()}})}}),e.find("[data-ui-field=preview-div]").empty(),$$._hasError=!0;var t=e.find("[data-ui-field=bindmodule-sel]");t.empty(),t.append('<option value="">'+HG.WebApp.Locales.GetLocaleString("configure_widgeteditor_selectmodule_placeholder",!1,this.Locale)+"</option>");for(var o="",a=0;a<HG.WebApp.Data.Modules.length;a++){var i=HG.WebApp.Data.Modules[a],r=HG.WebApp.Utility.GetModulePropertyByName(i,"Widget.DisplayModule");null!=r&&(r=r.Value);var n=i.DeviceType.toLowerCase(),s=HG.WebApp.WidgetsList._currentWidget.toLowerCase().split("/");if(s=s[s.length-1],(r==HG.WebApp.WidgetsList._currentWidget||s==n)&&(o=a,"HomeAutomation.HomeGenie.Automation"!=i.Domain))break}for(var a=0;a<HG.WebApp.Data.Modules.length;a++){var i=HG.WebApp.Data.Modules[a],l=i.Name.trim();""==l&&(l=i.Domain+":"+i.Address);var r=HG.WebApp.Utility.GetModulePropertyByName(i,"Widget.DisplayModule");null!=r&&(r=r.Value);var n=i.DeviceType.toLowerCase(),s=HG.WebApp.WidgetsList._currentWidget.toLowerCase().split("/");s=s[s.length-1],r!=HG.WebApp.WidgetsList._currentWidget&&s!=n&&""!=o||t.append('<option value="'+a+'">'+l+"</option>")}t.trigger("create"),t.val(o),t.selectmenu("refresh"),$$.SetTab(1),""!=o||"0"==o?setTimeout(function(){$$.Run()},1e3):t.qtip({content:{title:HG.WebApp.Locales.GetLocaleString("configure_widgeteditor_nobindmodule_title","Select a module"),text:HG.WebApp.Locales.GetLocaleString("configure_widgeteditor_nobindmodule_text","No valid bind-module has been found, please select one."),button:HG.WebApp.Locales.GetLocaleString("configure_widgeteditor_nobindmodule_close","Close")},show:{event:!1,ready:!0,delay:1e3},events:{hide:function(){$(this).qtip("destroy")}},hide:{event:!1,inactive:3e3},style:{classes:"qtip-red qtip-shadow qtip-rounded qtip-bootstrap"},position:{my:"bottom center",at:"top center"}})}),r.bind("click",function(){$("#editwidget_actionmenu").popup("close"),$$.SaveWidget(function(){$$._editorHtml.markClean(),$$._editorJscript.markClean()})}),n.bind("click",function(){$("#editwidget_actionmenu").popup("close"),window.open(location.protocol+"../../api/HomeAutomation.HomeGenie/Config/Widgets.Export/"+encodeURIComponent(HG.WebApp.WidgetsList._currentWidget)+"/")}),s.bind("click",function(){HG.Ui.SwitchPopup("#editwidget_actionmenu",d)}),l.bind("click",function(){return $.mobile.loading("show",{text:"Deleting Widget...",textVisible:!0,theme:"a",html:""}),HG.Configure.Widgets.Delete(HG.WebApp.WidgetsList._currentWidget,function(){$.mobile.loading("hide"),$.mobile.pageContainer.pagecontainer("change","#"+HG.WebApp.WidgetsList.PageId)}),!1}),c.bind("click",function(){return $$.CheckIsClean(function(){$.mobile.pageContainer.pagecontainer("change","#"+HG.WebApp.WidgetsList.PageId)}),!1}),m.bind("click",function(){return $$.CheckIsClean(function(){$.mobile.pageContainer.pagecontainer("change","#page_control")}),!1}),b.bind("click",function(){return $$._savePromptCallback(),!1}),f.bind("click",function(){return $$.SaveWidget(function(){$$._savePromptCallback()}),!1}),t.bind("click",function(){$$.Run()}),o.on("change",function(){""==$(this).val()?a.addClass("ui-disabled"):a.removeClass("ui-disabled"),$$.RenderView()}),a.on("click",function(){if(""!=o.val()){var e=HG.WebApp.Data.Modules[o.val()];HG.WebApp.Control.EditModuleParams(e)}}),i.hide(),u.mousedown(function(t){$$._splitDragStartX=t.pageX,$(window).mousemove(function(t){var o=$$._splitDragStartX-t.pageX,a=e.width()/2,i=p.width()+o;i>=5&&a>=i?(p.width(p.width()+o),e.find(".CodeMirror").css("right",p.width()+5),u.css("right",p.width()),$$._splitDragStartX=t.pageX):($(window).unbind("mousemove"),$$._editorHtml.refresh(),$$._editorJscript.refresh())})}).mouseup(function(){$(window).unbind("mousemove"),$$._editorHtml.refresh(),$$._editorJscript.refresh()}),window.onerror=function(e,t,o,a,i){if(!(t.indexOf("#"+$$.PageId)>0))throw i;$$.ShowError(i)}},$$.SetTab=function(e){var t=$("#"+$$.PageId);t.find("[data-ui-field=tab1-div]").hide(),t.find("[data-ui-field=tab2-div]").hide(),t.find("[data-ui-field=tab3-div]").hide(),t.find("[data-ui-field=tab1-btn]").removeClass("ui-btn-active"),t.find("[data-ui-field=tab2-btn]").removeClass("ui-btn-active"),t.find("[data-ui-field=tab3-btn]").removeClass("ui-btn-active"),t.find("[data-ui-field=tab"+e+"-div]").show(),t.find("[data-ui-field=tab"+e+"-btn]").addClass("ui-btn-active"),$$.RefreshCodeMirror()},$$.CheckIsClean=function(e){if($$._editorHtml.isClean()&&$$._editorJscript.isClean())e();else{var t=$("#"+$$.PageId);$$._savePromptCallback=function(){e()},t.find("[data-ui-field=notsaved-popup]").popup("open")}},$$.SaveWidget=function(e){$$.SaveWidgetHtml(function(){$$.SaveWidgetJavascript(function(){$$.Run(),e&&e()})})},$$.SaveWidgetHtml=function(e){$.mobile.loading("show",{text:HG.WebApp.Locales.GetLocaleString("configure_widgeteditor_savinghtml",!1,this.Locale),textVisible:!0,theme:"a",html:""}),HG.Configure.Widgets.Save(HG.WebApp.WidgetsList._currentWidget,"html",$$._editorHtml.getValue(),function(){$.mobile.loading("hide"),e&&e()})},$$.SaveWidgetJavascript=function(e){$.mobile.loading("show",{text:HG.WebApp.Locales.GetLocaleString("configure_widgeteditor_savingjavascript",!1,this.Locale),textVisible:!0,theme:"a",html:""}),HG.Configure.Widgets.Save(HG.WebApp.WidgetsList._currentWidget,"js",$$._editorJscript.getValue(),function(){$.mobile.loading("hide"),e&&e()})},$$.RefreshCodeMirror=function(){setTimeout(function(){$$._editorHtml.refresh(),$$._editorJscript.refresh()},500)},$$.Render=function(){var e=$("#"+$$.PageId),t=(e.find("[data-ui-field=bindmodule-sel]"),e.find("[data-ui-field=errors-btn]"));t.hide();var o='<div id="widget_preview_instance" data-ui-field="preview-wrapper-div" align="left" style="display:table-cell">';o+=$$._editorHtml.getValue(),o+="</div>",e.find("[data-ui-field=preview-div]").html(o),e.find("[data-ui-field=preview-wrapper-div]").trigger("create")},$$.RenderView=function(e){if(!$$._hasError){var t=$("#"+$$.PageId),o=t.find("[data-ui-field=bindmodule-sel]"),a=HG.WebApp.Data.Modules[o.val()];(null==e||e.Domain==a.Domain&&e.Source==a.Address)&&$$.RenderWidget("#widget_preview_instance",$$._widgetInstance,a,e)}},$$.RenderWidget=function(e,t,o,a){try{t.v2?("function"==typeof t._bind?(t._bind(e,o),t._bind=null):t.setModule(o),"function"!=typeof t.onStart||t._started||(t.onStart(),t._started=!0,"function"==typeof t.onRefresh&&t.onRefresh()),"undefined"!=typeof a&&"undefined"!=typeof a.Property&&"function"==typeof t.onUpdate?t.onUpdate(a.Property,a.Value):"function"==typeof t.onRefresh&&t.onRefresh()):t.RenderView(e,o)}catch(i){console.log(i),$$._hasError=!0,$$.ShowError(i)}},$$.GetInstance=function(javascriptCode){if(javascriptCode.trim().startsWith("["))return eval(javascriptCode)[0];var commonJs="";return commonJs+="    var $$ = this;",commonJs+="    $$._fieldCache = [];",commonJs+="    $$.v2 = true;",commonJs+="    $$.apiCall = HG.Control.Modules.ServiceCall;",commonJs+="    $$.util = HG.WebApp.Utility;",commonJs+="    $$.ui = HG.Ui;",commonJs+="    $$.signalActity = function(fieldName) {",commonJs+="      if (typeof fieldName != 'undefined' && fieldName != '')",commonJs+="        $$.ui.BlinkAnim($$.field(fieldName));",commonJs+="      if ($$.field('led').length) {",commonJs+="          $$.field('led').attr('src', 'images/common/led_green.png');",commonJs+="          setTimeout(function() {",commonJs+="            $$.field('led').attr('src', 'images/common/led_black.png');",commonJs+="          }, 100);",commonJs+="      }",commonJs+="    };",commonJs+="    $$.field = function(field, globalSearch){",commonJs+="        var f = globalSearch ? '@'+field : field;",commonJs+="        var el = null;",commonJs+="        if (typeof $$._fieldCache[f] == 'undefined') {",commonJs+="            el = globalSearch ? $(field) : $$._widget.find('[data-ui-field='+field+']');",commonJs+="            if (el.length)",commonJs+="                $$._fieldCache[f] = el;",commonJs+="        } else {",commonJs+="            el = $$._fieldCache[f];",commonJs+="        }",commonJs+="        return el",commonJs+="    };",commonJs+="    $$.clearCache = function() {",commonJs+="        $$._fieldCache.length = 0;",commonJs+="    };",commonJs+="    $$.setModule = function(module) {",commonJs+="        $$.module = module;",commonJs+="        $$.module.prop = function(propName, value) {",commonJs+="            var p = HG.WebApp.Utility.GetModulePropertyByName(this, propName);",commonJs+="            if (typeof value != 'undefined')",commonJs+="                p.Value = value;",commonJs+="            return p;",commonJs+="        };",commonJs+="        $$.module.command = function(cmd, opt, callback) {",commonJs+="            HG.Control.Modules.ServiceCall(cmd, this.Domain, this.Address, opt, function (response) { ",commonJs+="                if (typeof callback == 'function')",commonJs+="                    callback(response);",commonJs+="            });",commonJs+="        };",commonJs+="    };",commonJs+="    $$._bind = function(cuid, module) {",commonJs+="        $$.setModule(module);",commonJs+="        $$.container = $(cuid);",commonJs+="        $$.popup = $$.container.find('[data-ui-field=controlpopup]');",commonJs+="        $$.popup.popup();",commonJs+="        $$.popup.trigger('create');",commonJs+="        $$.popup.field = function(f){ return $$.popup.find('[data-ui-field='+f+']'); };",commonJs+="        $$._widget = $$.container.find('[data-ui-field=widget]');",commonJs+="        $$._widget.data('ControlPopUp', $$.popup);",commonJs+="    };",commonJs=commonJs.replace(/(\r\n|\n|\r)/gm,""),javascriptCode="new function(){"+commonJs+javascriptCode+"}",eval(javascriptCode)},$$.Run=function(){$$._hasError=!1,$$._editorJscript.clearGutter("CodeMirror-lint-markers-5");var e=$$._editorJscript.getValue();$.mobile.loading("show",{text:"Checking Javascript code...",textVisible:!0,theme:"a",html:""}),HG.Configure.Widgets.Parse(e,function(t){if($.mobile.loading("hide"),"OK"!=t.ResponseValue){var o=t.ResponseValue,a=o.substr(o.indexOf("(")+1);a=a.substr(0,a.indexOf(")")).split(","),o=o.substr(o.indexOf(":")+2),o=o+'<br/> <a href="javascript:HG.WebApp.WidgetEditor.JumpToLine({ line: '+(a[0]-1)+", ch: "+(a[1]-1)+' })">Line <strong>'+a[0]+"</strong>, Column <strong>"+a[1]+"</strong></a>",$$.ShowErrorTip(o,a[0])}else try{$$._widgetInstance=$$.GetInstance(e),$$.Render(),$$.RenderView()}catch(i){$$._hasError=!0,$$.ShowError(i)}})},$$.ShowError=function(e){var t=ErrorStackParser.parse(e);navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(t[0]=e);var o=e+'<br/> <a href="javascript:HG.WebApp.WidgetEditor.JumpToLine({ line: '+(t[0].lineNumber-1)+", ch: "+(t[0].columnNumber-1)+' })">Line <strong>'+t[0].lineNumber+"</strong>, Column <strong>"+t[0].columnNumber+"</strong></a>";$$.ShowErrorTip(o,t[0].lineNumber),console.log(o),console.log(t)},$$.ShowErrorTip=function(e,t){if(null!=$$._editorJscript){var o=$("#"+$$.PageId),a=o.find("[data-ui-field=errors-btn]"),i=document.createElement("div");$$.SetTab(2),$$._editorJscript.clearGutter("CodeMirror-lint-markers-5"),i.className="CodeMirror-lint-marker-error",$$._editorJscript.setGutterMarker(t-1,"CodeMirror-lint-markers-5",i),$(i).qtip({content:{title:"Error",text:e,button:"Close"},show:{event:"mouseover",solo:!0},hide:"mouseout",style:{classes:"qtip-red qtip-shadow qtip-rounded qtip-bootstrap"}}),a.show(),a.qtip({content:{title:"Error",text:e,button:"Close"},show:{event:"mouseover",ready:!0,delay:500},hide:{event:!1,inactive:5e3},style:{classes:"qtip-red qtip-shadow qtip-rounded qtip-bootstrap"},position:{adjust:{screen:!0},my:"top center",at:"bottom center"}})}},$$.JumpToLine=function(e){window.setTimeout(function(){$$._editorJscript.setCursor(e);var t=$$._editorJscript.getScrollInfo().clientHeight,o=$$._editorJscript.charCoords(e,"local");$$._editorJscript.scrollTo(null,(o.top+o.bottom-t)/2),$$._editorJscript.focus()},500)}},HG.WebApp.Scheduler=HG.WebApp.Scheduler||new function(){var e=this;e._ScheduleList={},e._CurrentEventName="",e._CurrentEventIndex=-1,e.InitializePage=function(){$("#scheduleritem_add_button").on("click",function(){e._CurrentEventName="",e._CurrentEventIndex=-1,e.EditCurrentItem(),setTimeout(function(){$("#scheduleritem_add_button").removeClass("ui-btn-active")},200)})},e.GetItemMarkup=function(e){var t=e.Name;t.indexOf(".")>0&&(t=t.substring(t.indexOf(".")+1));var o='<li  data-icon="false" data-schedule-name="'+e.Name+'" data-schedule-index="'+i+'">';return o+='<a href="#" data-ui-ref="edit-btn">',o+='   <h3 class="ui-li-heading">'+t+"</h3>",o+='   <p class="ui-li-desc">'+(null!=e.Description?e.Description:"")+' <span style="opacity:0.5">('+e.CronExpression+")</span></p>",o+="</a>",o+='<div class="ui-grid-a" style="position:absolute;right:0;top:0;height:100%;">',o+='<div class="ui-block-a"><a data-ui-field="btn_delete" title="Delete" class="ui-btn ui-icon-delete ui-btn-icon-notext ui-list-btn-option"></a></div>',o+='<div class="ui-block-b"><a data-ui-field="btn_toggle" title="Disable" class="ui-btn ui-icon-'+(e.IsEnabled?"check":"alert")+' ui-btn-icon-notext ui-list-btn-option">'+(e.IsEnabled?"Tap to DISABLE item":"Tap to ENABLE item")+"</a></div>",o+="</div>",o+="</li>"},e.LoadScheduling=function(t){$.mobile.loading("show"),HG.Automation.Scheduling.List(function(o){for(e._ScheduleList=o,$.mobile.loading("hide"),$("#configure_schedulerservice_list").empty(),$("#configure_schedulerservice_list").append('<li data-icon="false" data-role="list-divider">'+HG.WebApp.Locales.GetLocaleString("configure_scheduler_events")+"</li>"),i=0;i<e._ScheduleList.length;i++){var a=e._ScheduleList[i];if(a.Name.indexOf(".")<0){var r=e.GetItemMarkup(a);$("#configure_schedulerservice_list").append(r)}}var n="";for(i=0;i<e._ScheduleList.length;i++){var a=e._ScheduleList[i];if(a.Name.indexOf(".")>0){var s=a.Name.substring(0,a.Name.indexOf(".")),r=e.GetItemMarkup(a);s!=n&&($("#configure_schedulerservice_list").append('<li data-role="list-divider">'+s+"</li>"),n=s),$("#configure_schedulerservice_list").append(r)}}$("#configure_schedulerservice_list").listview(),$("#configure_schedulerservice_list").find("li").each(function(){var t=$(this);t.find("[data-ui-field=btn_delete]").on("click",function(){var t=$(this);HG.WebApp.Utility.ConfirmPopup("Delete item","This action cannot be undone!",function(o){if(o){var a=t.parent().parent().parent().attr("data-schedule-name");HG.Automation.Scheduling.Delete(a,function(){e.LoadScheduling()}),e._CurrentEventName="",e._CurrentEventIndex=-1}})}),t.find("[data-ui-field=btn_toggle]").on("click",function(){e.ToggleScheduleIsEnabled($(this).parent().parent().parent().attr("data-schedule-index"))})}),$("#configure_schedulerservice_list").listview("refresh"),$('#configure_schedulerservice_list li a[data-ui-ref="edit-btn"]').bind("click",function(){e._CurrentEventName=$(this).parent().attr("data-schedule-name"),e._CurrentEventIndex=$(this).parent().attr("data-schedule-index"),e.EditCurrentItem()}),t&&t()})},e.EditCurrentItem=function(){HG.Ui.Popup.CronWizard.open(e._CurrentEventName),HG.Ui.Popup.CronWizard.onChange=function(t){HG.Automation.Scheduling.Update(t.Name,t.CronExpression,t.Data,t.Description,t.Script,function(){e.LoadScheduling()})}},e.ToggleScheduleIsEnabled=function(t){var o=e._ScheduleList[t];$.mobile.loading("show"),o.IsEnabled?HG.Automation.Scheduling.Disable(o.Name,function(){e.LoadScheduling()}):HG.Automation.Scheduling.Enable(o.Name,function(){e.LoadScheduling()})}},HG.WebApp.Apps=Array(),HG.WebApp.Apps.NetPlay=Array(),HG.WebApp.Apps.NetPlay.SlideShow=Array(),HG.WebApp.Apps.NetPlay.SlideShow.DisplayImage=function(e){$.mobile.changePage("#page_apps_netplay",{transition:"flow"});var t="#bgapp_netplay_image1";$("#bgapp_netplay_image1").is(":visible")?($("#bgapp_netplay_image1").animate({top:0,left:-4e3},2e3,function(){$("#bgapp_netplay_image1").hide()}),t="#bgapp_netplay_image2"):($("#bgapp_netplay_image2").animate({top:0,left:-4e3},2e3,function(){$("#bgapp_netplay_image2").hide()}),t="#bgapp_netplay_image1"),setTimeout(function(){""==e&&(e="0"),$(t).html('<img src="/'+HG.WebApp.Data.ServiceKey+"/Protocols.AirPlay/"+e+'/Control.GetImage/" height="100%">'),$(t).show(),$(t).animate({top:0,left:0},2e3)})};